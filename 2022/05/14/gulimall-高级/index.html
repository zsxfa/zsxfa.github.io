<!DOCTYPE html>
<html lang="en">


<head>

  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/alien.png">
  <meta name="google-site-verification" content="gNcq-rP8_Ahmh-wcxj35y0OipCZz-Q6PviyRJK5pHXw">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zsxfa.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"b2t":false,"scrollpercent":true},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"livere","storage":true,"lazyload":false,"nav":null,"activeClass":"livere"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="对于谷粒商城的高级篇笔记总结…">
<meta property="og:type" content="article">
<meta property="og:title" content="gulimall-高级">
<meta property="og:url" content="http://zsxfa.cn/2022/05/14/gulimall-%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name">
<meta property="og:description" content="对于谷粒商城的高级篇笔记总结…">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648601662.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648602178.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648604589.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648605954.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606206.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606640.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606678.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606741.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606780.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608552.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608751.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608800.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608854.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648609965.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648610035.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648610447.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648610587.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648611681.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648611825.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648612774.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648633368.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648692859.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648693176.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648694712.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648711729.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648720214.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/01/1648779243.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/01/1648807749.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/01/1648817806.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648863473.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648863801.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648864295.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648888974.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648980967.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648980997.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981025.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981054.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981233.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981530.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981632.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648983252.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649040896.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649042053.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649050459.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649050967.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649051078.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650252557.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650252575.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650274901.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276475.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276490.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276784.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276799.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276868.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504286.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504363.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504437.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504492.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504522.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504547.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504570.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504593.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504634.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650510939.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/30/1651285444.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/30/1651310436.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/30/1651310583.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/nbJN45z6D3uEs97.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/HMk4oKfBCsjm2cY.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/qWTQo5azcxihAVU.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651373265.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375754.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375792.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375806.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375826.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651395290.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/VIEF9woJaGchQpW.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/mkn8LVQUiTxphsq.png">
<meta property="og:image" content="https://i.loli.net/2020/10/03/zcLPnRNXvq2uHoE.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651454564.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489137.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489175.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489328.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489224.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489251.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651631106.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651633432.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651633487.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651633524.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972649.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972693.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972731.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972796.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972890.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972957.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973051.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973086.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973246.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973308.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973406.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973552.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013355.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013402.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013625.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013664.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013704.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652082527.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652082546.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088755.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088794.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088812.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088835.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088861.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088914.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088932.png">
<meta property="article:published_time" content="2022-05-14T00:40:33.000Z">
<meta property="article:modified_time" content="2022-05-14T00:59:04.648Z">
<meta property="article:author" content="小Feng">
<meta property="article:tag" content="编程、生活、音乐、影视">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648601662.png">

<link rel="canonical" href="http://zsxfa.cn/2022/05/14/gulimall-%E9%AB%98%E7%BA%A7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>gulimall-高级 | </title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K4J8QJV58T"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-K4J8QJV58T');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
	<a target="_blank" rel="noopener" href="https://github.com/zsxfa/zsxfa.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title"></h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zsxfa.cn/2022/05/14/gulimall-%E9%AB%98%E7%BA%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/01/14/1642171382.png">
      <meta itemprop="name" content="小Feng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          gulimall-高级
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-14 08:40:33 / Modified: 08:59:04" itemprop="dateCreated datePublished" datetime="2022-05-14T08:40:33+08:00">2022-05-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>256k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3:53</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>对于谷粒商城的高级篇笔记总结…</p>
<span id="more"></span>

<h1 id="ELASTICSEARCH"><a href="#ELASTICSEARCH" class="headerlink" title="ELASTICSEARCH"></a>ELASTICSEARCH</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/what-is/elasticsearch">https://www.elastic.co/cn/what-is/elasticsearch</a><br>全文搜索属于最常见的需求，开源的 Elasticsearch 是目前全文搜索引擎的首选。<br>它可以快速地储存、搜索和分析海量数据。维基百科、Stack Overflow、Github 都采用它</p>
<p>Elastic 的底层是开源库 Lucene。但是，你没法直接用 Lucene，必须自己写代码去调用它的接口。Elastic 是 Lucene 的封装，提供了 REST API 的操作接口，开箱即用。<br>REST API：天然的跨平台。<br>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a><br>官方中文：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/foreword_id.html">https://www.elastic.co/guide/cn/elasticsearch/guide/current/foreword_id.html</a></p>
<p>社区中文：<br><a target="_blank" rel="noopener" href="https://es.xiaoleilu.com/index.html">https://es.xiaoleilu.com/index.html</a><br><a target="_blank" rel="noopener" href="http://doc.codingdict.com/elasticsearch/0/">http://doc.codingdict.com/elasticsearch/0/</a></p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><strong>1、Index（索引）</strong></p>
<p>动词，相当于 MySQL 中的 insert；</p>
<p>名词，相当于 MySQL 中的 Database</p>
<p><strong>2、Type（类型）</strong><br>在 Index（索引）中，可以定义一个或多个类型。<br>类似于 MySQL 中的 Table；每一种类型的数据放在一起；</p>
<p><strong>3、Document（文档）</strong><br>保存在某个索引（Index）下，某种类型（Type）的一个数据（Document），文档是 JSON 格式的，Document 就像是 MySQL 中的某个 Table 里面的内容；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648601662.png" alt="desc"></p>
<h2 id="ElasticSearch7-去掉type概念"><a href="#ElasticSearch7-去掉type概念" class="headerlink" title="ElasticSearch7-去掉type概念"></a>ElasticSearch7-去掉type概念</h2><ul>
<li>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但ES中不是这样的。elasticsearch是基于Lucene开发的搜索引擎，而ES中不同type下名称相同的filed最终在Lucene中的处理方式是一样的。<ul>
<li>两个不同type下的两个user_name，在ES同一个索引下其实被认为是同一个filed，你必须在两个不同的type中定义相同的filed映射。否则，不同type中的相同字段名称就会在处理中出现冲突的情况，导致Lucene处理效率下降。</li>
<li>去掉type就是为了提高ES处理数据的效率。</li>
</ul>
</li>
<li>Elasticsearch 7.x<ul>
<li>URL中的type参数为可选。比如，索引一个文档不再要求提供文档类型</li>
</ul>
</li>
<li>Elasticsearch 8.x<ul>
<li>不再支持URL中的type参数。</li>
</ul>
</li>
</ul>
<p>解决：将索引从多类型迁移到单类型，每种类型文档一个独立索引</p>
<h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648602178.png" alt="desc"></p>
<h2 id="1、安装elastic-search"><a href="#1、安装elastic-search" class="headerlink" title="1、安装elastic search"></a>1、安装elastic search</h2><p> dokcer中安装elastic search</p>
<p>（1）下载ealastic search(存储和检索数据)和kibana(可视化检索数据)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull elasticsearch:7.6.2</span><br><span class="line">docker pull kibana:7.6.2</span><br></pre></td></tr></table></figure>

<p>（2）配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mydata/elasticsearch/config</span><br><span class="line">mkdir -p /mydata/elasticsearch/data</span><br><span class="line">echo &quot;http.host: 0.0.0.0&quot; &gt;&gt; /mydata/elasticsearch/config/elasticsearch.yml</span><br><span class="line">chmod -R 777 /mydata/elasticsearch/</span><br></pre></td></tr></table></figure>

<p>（3）启动Elastic search</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e  &quot;discovery.type=single-node&quot; \</span><br><span class="line">-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v  /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-d elasticsearch:7.6.2 </span><br></pre></td></tr></table></figure>

<blockquote>
<p>–name:设置容器名称</p>
<p>-p:9200是发送http请求，rustAPI，9300是ES在分布式集群状态下节点间的通信端口</p>
<p>-e:运行模式，ES_JAVA_OPTS不指定会将内存全部占用</p>
<p>-v:进行挂载，将容器中的配置文件和外部的虚拟机配置文件进行关联</p>
</blockquote>
<p>设置开机启动elasticsearch</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update elasticsearch --restart=always</span><br></pre></td></tr></table></figure>



<p>（4）启动kibana：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.56.10:9200 -p 5601:5601 -d kibana:7.6.2</span><br></pre></td></tr></table></figure>

<p>设置开机启动kibana</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update kibana  --restart=always</span><br></pre></td></tr></table></figure>





<p>（5）测试</p>
<p>查看elasticsearch版本信息： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/">http://192.168.56.10:9200</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1e3900cda632&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zAxedSGQSgC86bmYA72C9Q&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.6.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;docker&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2020-03-26T06:34:37.794943Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.4.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>显示elasticsearch 节点信息http://#:9200/_cat/nodes ，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">13</span> <span class="number">92</span> <span class="number">7</span> <span class="number">0.06</span> <span class="number">0.21</span> <span class="number">0.20</span> dilm * <span class="number">1e3900</span>cda632</span><br></pre></td></tr></table></figure>



<p>访问Kibana：<a target="_blank" rel="noopener" href="http://192.168.56.10:5601/app/kibana#/home">http://192.168.56.10:5601/app/kibana#/home</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648604589.png" alt="desc"></p>
<h2 id="2、初步检索"><a href="#2、初步检索" class="headerlink" title="2、初步检索"></a>2、初步检索</h2><h3 id="1）-CAT"><a href="#1）-CAT" class="headerlink" title="1）_CAT"></a>1）_CAT</h3><p>（1）GET/_cat/nodes：查看所有节点</p>
<p> 如：<a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/nodes">http://192.168.56.10:9200/_cat/nodes</a> :</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> <span class="number">15</span> <span class="number">91</span> <span class="number">3</span> <span class="number">0</span>.<span class="number">13</span> <span class="number">0</span>.<span class="number">38</span> <span class="number">0</span>.<span class="number">31</span> dilm * <span class="number">1</span>e3900cda632</span><br></pre></td></tr></table></figure>

<p>注：*表示集群中的主节点</p>
<p>（2）GET/_cat/health：查看es健康状况</p>
<p>如： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/health">http://192.168.56.10:9200/_cat/health</a> </p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1648604850</span> <span class="number">01</span>:<span class="number">47</span>:<span class="number">30</span> elasticsearch green <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> - <span class="number">100</span>.<span class="number">0</span>%</span><br></pre></td></tr></table></figure>

<p>注：green表示健康值正常</p>
<p>（3）GET/_cat/master：查看主节点</p>
<p>如： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/master">http://192.168.56.10:9200/_cat/master</a> </p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Urxz2dOfSgCRyzGzs</span>-<span class="number">7</span>l6Q <span class="number">127.0.0.1</span> <span class="number">127.0.0.1</span> <span class="number">1</span>e3900cda632</span><br></pre></td></tr></table></figure>

<p>（4）GET/_cat/indicies：查看所有索引 ，等价于mysql数据库的show databases;</p>
<p>如： <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/_cat/indices">http://192.168.56.10:9200/_cat/indices</a> </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">green open .kibana_task_manager_1   X9B74aaIS9KHLlPUrYLVWA <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">34.2</span>kb <span class="number">34.2</span>kb</span><br><span class="line">green open .apm-agent-configuration ZXdJradmQcG-fbLFmRydKw <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>   <span class="number">283</span>b   <span class="number">283</span>b</span><br><span class="line">green open .kibana_1                <span class="number">9</span>uZjKicuSPqv5qUSMWes3Q <span class="number">1</span> <span class="number">0</span> <span class="number">7</span> <span class="number">0</span> <span class="number">34.5</span>kb <span class="number">34.5</span>kb</span><br></pre></td></tr></table></figure>

<h3 id="2）索引一个文档"><a href="#2）索引一个文档" class="headerlink" title="2）索引一个文档"></a>2）索引一个文档</h3><p>保存一个数据，保存在哪个索引的哪个类型下(相当于保存在那个数据库的那张表上)，指定用那个唯一标识<br>PUT customer/external/1;在customer索引下的external类型下保存1号数据为</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT customer<span class="regexp">/external/</span><span class="number">1</span></span><br></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;John Doe&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>PUT和POST都可以<br><strong>POST新增。</strong>如果不指定id，会自动生成id。指定id就会修改这个数据，并新增版本号；<br><strong>PUT可以新增也可以修改。PUT必须指定id</strong>；由于PUT需要指定id，我们一般用来做修改操作，不指定id会报错。</p>
<p>下面是在postman中的测试数据：<br><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648605954.png" alt="desc"></p>
<p>创建数据成功后，显示201 created表示插入记录成功。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这些返回的JSON串的含义；这些带有下划线开头的，称为元数据，反映了当前的基本信息。</p>
<p>“_index”: “customer” 表明该数据在哪个数据库下；</p>
<p>“_type”: “external”     表明该数据在哪个类型下；</p>
<p>“_id”: “1”                    表明被保存数据的id；</p>
<p> “_version”: 1,            被保存数据的版本</p>
<p>“result”: “created”      这里是创建了一条数据，如果重新put一条数据，则该状态会变为updated，并且版本号也会发生变化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606206.png" alt="desc"></p>
<p>下面选用POST方式：</p>
<p>添加数据的时候，不指定ID，会自动的生成id，并且类型是新增：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606640.png" alt="desc"></p>
<p>再次使用POST插入数据，仍然是新增的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606678.png" alt="desc"></p>
<p>添加数据的时候，指定ID，会使用该id，并且类型是新增：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606741.png" alt="desc"></p>
<p>再次使用POST插入数据，类型为updated</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648606780.png" alt="desc"></p>
<h3 id="3）查看文档"><a href="#3）查看文档" class="headerlink" title="3）查看文档"></a>3）查看文档</h3><p>GET /customer/external/1</p>
<p> <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a> </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span><span class="comment">//在哪个索引下</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span><span class="comment">//在哪个类型</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="comment">//记录id</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span><span class="comment">//版本号</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span><span class="comment">//并发控制字段，每次更新都会+1，用来做乐观锁</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span><span class="comment">//同上，主分片重新分配，如重启，就会变化</span></span><br><span class="line">    <span class="attr">&quot;found&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>通过“if_seq_no=1&amp;if_primary_term=1 ”，当序列号匹配的时候，才进行修改，否则不修改。</p>
<p>实例：将id=1的数据更新为name=1，然后再次更新为name=2，起始_seq_no=1，_primary_term=1</p>
<p>（1）将name更新为1</p>
<p><a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1?if_seq_no=1&amp;if_primary_term=1">http://192.168.56.10:9200/customer/external/1?if_seq_no=1&amp;if_primary_term=1</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608552.png" alt="desc"></p>
<p>（2）将name更新为2，更新过程中使用seq_no=1</p>
<p>http://#:9200/customer/external/1?if_seq_no=1&amp;if_primary_term=1 </p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608751.png" alt="desc"></p>
<p>出现更新错误。</p>
<p>（3）查询新的数据</p>
<p> <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1">http://192.168.56.10:9200/customer/external/1</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608800.png" alt="desc"></p>
<p>能够看到_seq_no变为7。（ps.中间有多次更新操作，这里就从seq_no为7来接着操作）</p>
<p>（4）再次更新，更新成功</p>
<p> <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1?if_seq_no=7&amp;if_primary_term=1">http://192.168.56.10:9200/customer/external/1?if_seq_no=7&amp;if_primary_term=1</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648608854.png" alt="desc"></p>
<h3 id="4）更新文档"><a href="#4）更新文档" class="headerlink" title="4）更新文档"></a>4）更新文档</h3><p>（1）POST更新文档，带有_update</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/<span class="number">1</span>/_update</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doew&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p> <a target="_blank" rel="noopener" href="http://192.168.56.10:9200/customer/external/1/_update">http://192.168.56.10:9200/customer/external/1/_update</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648609965.png" alt="desc"></p>
<p>如果再次执行更新，则不执行任何操作，序列号也不发生变化</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648610035.png" alt="desc"></p>
<p>POST更新方式，会对比原来的数据，和原来的相同，则不执行任何操作（version和_seq_no）都不变。</p>
<p> （2）POST更新文档，不带_update</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/<span class="number">1</span> </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doew2&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648610447.png" alt="desc"></p>
<p>在更新过程中，<strong>重复执行更新操作，数据也能够更新成功</strong>，不会和原来的数据进行对比。</p>
<p>（3）PUT更新文档，无_update</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT customer/external/<span class="number">1</span> </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doew3&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648610587.png" alt="desc"></p>
<p>在更新过程中，<strong>重复执行更新操作，数据也能够更新成功</strong>，不会和原来的数据进行对比。</p>
<ul>
<li><p><strong>不同：</strong></p>
<ul>
<li><p>POST 操作带_update会对比源文档数据，如果相同不会有什么操作，文档 version 不增加,不带 _update的话，不会对比源文档数据，会直接进行保存并增加 version 版本</p>
</li>
<li><p>PUT 操作总会将数据重新保存并增加 version 版本；</p>
</li>
</ul>
<p><strong>对于大并发更新，不带 update；</strong><br><strong>对于大并发查询偶尔更新，带 update；对比更新，重新计算分配规则。</strong></p>
</li>
<li><p><strong>更新同时增加属性 （PUT 和 POST 不带_update 也可以）</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/<span class="number">1</span>/_update </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jane Doe&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">20</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="5）删除文档或索引"><a href="#5）删除文档或索引" class="headerlink" title="5）删除文档或索引"></a>5）删除文档或索引</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE customer/external/<span class="number">1</span></span><br><span class="line">DELETE customer</span><br></pre></td></tr></table></figure>

<p>注：elasticsearch并没有提供删除类型的操作，只提供了删除索引和文档的操作。</p>
<p>实例：删除id=1的数据，删除后继续查询</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648611681.png" alt="desc"></p>
<p>实例：删除整个costomer索引数据</p>
<p>删除前，所有的索引</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">green  open .kibana_task_manager_1   X9B74aaIS9KHLlPUrYLVWA 1 0 2 0 34.2kb 34.2kb</span><br><span class="line">green  open .apm-agent-configuration ZXdJradmQcG-fbLFmRydKw 1 0 0 0   283b   283b</span><br><span class="line">green  open .kibana_1                9uZjKicuSPqv5qUSMWes3Q 1 0 7 0 34.5kb 34.5kb</span><br><span class="line">yellow open customer                 S09RAZu5R0yfA8WgHhX3tA 1 1 4 6  9.1kb  9.1kb</span><br></pre></td></tr></table></figure>

<p>删除“ customer ”索引</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648611825.png" alt="desc"></p>
<p>删除后，所有的索引</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">green open .kibana_task_manager_1   X9B74aaIS9KHLlPUrYLVWA 1 0 2 0 34.2kb 34.2kb</span><br><span class="line">green open .apm-agent-configuration ZXdJradmQcG-fbLFmRydKw 1 0 0 0   283b   283b</span><br><span class="line">green open .kibana_1                9uZjKicuSPqv5qUSMWes3Q 1 0 7 0 34.5kb 34.5kb</span><br></pre></td></tr></table></figure>

<h3 id="6）eleasticsearch的批量操作——bulk"><a href="#6）eleasticsearch的批量操作——bulk" class="headerlink" title="6）eleasticsearch的批量操作——bulk"></a>6）eleasticsearch的批量操作——bulk</h3><p>语法格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>action<span class="punctuation">:</span><span class="punctuation">&#123;</span>metadata<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>\n</span><br><span class="line"><span class="punctuation">&#123;</span>request body  <span class="punctuation">&#125;</span>\n</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span>action<span class="punctuation">:</span><span class="punctuation">&#123;</span>metadata<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>\n</span><br><span class="line"><span class="punctuation">&#123;</span>request body  <span class="punctuation">&#125;</span>\n</span><br></pre></td></tr></table></figure>

<p>这里的批量操作，当发生某一条执行发生失败时，其他的数据仍然能够接着执行，也就是说彼此之间是独立的。</p>
<p>bulk api以此按顺序执行所有的action（动作）。如果一个单个的动作因任何原因失败，它将继续处理它后面剩余的动作。当bulk api返回时，它将提供每个动作的状态（与发送的顺序相同），所以您可以检查是否一个指定的动作是否失败了。</p>
<p><strong>postman不支持下面的数据格式，所以以下将在Kibana中进行测试</strong></p>
<p>实例1: 执行多条数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;John Doe&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;John Doe&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648612774.png" alt="desc"></p>
<p>实例2：对于整个索引执行批量操作</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span><span class="string">&quot;website&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;blog&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;123&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;create&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span><span class="string">&quot;website&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;blog&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;123&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;my first blog post&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span><span class="string">&quot;website&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;blog&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;my second blog post&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;update&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span><span class="string">&quot;website&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;blog&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;123&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;my updated blog post&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#! Deprecation<span class="punctuation">:</span> <span class="punctuation">[</span>types removal<span class="punctuation">]</span> Specifying types in bulk requests is deprecated.</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">344</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;delete&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;not_found&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">404</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;create&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;BMv_2H8BWhzCIFNne3Q7&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;update&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="7）样本测试数据"><a href="#7）样本测试数据" class="headerlink" title="7）样本测试数据"></a>7）样本测试数据</h3><p>准备了一份顾客银行账户信息的虚构的JSON文档样本。每个文档都有下列的schema（模式）。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="number">39225</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;firstname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Amber&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Duke&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;880 Holmes Lane&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;employer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pyrami&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;amberduke@pyrami.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Brogan&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IL&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p> <a target="_blank" rel="noopener" href="https://github.com/zsxfa/gulimall/blob/main/es%E7%9A%84%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json">https://github.com/zsxfa/gulimall/blob/main/es%E7%9A%84%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json</a> ，导入测试数据，</p>
<p>POST bank/account/_bulk</p>
<h2 id="3、检索"><a href="#3、检索" class="headerlink" title="3、检索"></a>3、检索</h2><h3 id="1）search-Api"><a href="#1）search-Api" class="headerlink" title="1）search Api"></a>1）search Api</h3><p>ES支持两种基本方式检索；</p>
<ul>
<li>通过REST request uri 发送搜索参数 （uri +检索参数）；</li>
<li>通过REST request body 来发送它们（uri+请求体）；</li>
</ul>
<p>信息检索</p>
<ul>
<li><p>一切检索从_search 开始</p>
<p><strong>GET bank/_search：</strong>检索 bank 下所有信息，包括 type 和 docs</p>
<p><strong>GET bank/_search?q=*&amp;sort=account_number:asc：</strong>请求参数方式检索</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search?q=*&amp;sort=account_number:asc</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">16623</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bradshaw&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Mckenzie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;244 Columbus Place&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Euron&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bradshawmckenzie@euron.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hobucken&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CO&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">0</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      。。。。。。</span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>响应结果解释：</strong></p>
<table>
<thead>
<tr>
<th>took</th>
<th>Elasticsearch 执行搜索的时间（毫秒）</th>
</tr>
</thead>
<tbody><tr>
<td>time_out</td>
<td>告诉我们搜索是否超时</td>
</tr>
<tr>
<td>_shards</td>
<td>告诉我们多少个分片被搜索了，以及统计了成功/失败的搜索分片hits - 搜索结果</td>
</tr>
<tr>
<td>hits.total</td>
<td>搜索结果</td>
</tr>
<tr>
<td>hits.hits</td>
<td>实际的搜索结果数组（默认为前 10 的文档）</td>
</tr>
<tr>
<td>sort</td>
<td>结果的排序 key（键）（没有则按 score 排序）</td>
</tr>
<tr>
<td>score 和 max_score</td>
<td>相关性得分和最高得分（全文检索用）</td>
</tr>
</tbody></table>
</li>
<li><p>uri+请求体进行检索</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span><span class="string">&quot;desc&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>HTTP客户端工具（POSTMAN），get请求不能够携带请求体，我们变为 post 也是一样的我们POST 一个JSON 风格的查询请求体到_search API。<br>需要了解，一旦搜索的结果被返回，Elasticsearch 就完成了这次请求，并且不会维护任何服务端的资源或者结果的cursor（游标）</p>
<p>（1）只有6条数据，这是因为存在分页查询；</p>
<p>使用<code>from</code>和<code>size</code>可以指定查询</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123; &quot;account_number&quot;: &quot;asc&quot; &#125;,</span><br><span class="line">    &#123;&quot;balance&quot;:&quot;desc&quot;&#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;from&quot;: 20,</span><br><span class="line">  &quot;size&quot;: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）详细的字段信息，参照： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-search.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-search.html</a> </p>
<blockquote>
<p>The response also provides the following information about the search request:</p>
<ul>
<li><code>took</code> – how long it took Elasticsearch to run the query, in milliseconds</li>
<li><code>timed_out</code> – whether or not the search request timed out</li>
<li><code>_shards</code> – how many shards were searched and a breakdown of how many shards succeeded, failed, or were skipped.</li>
<li><code>max_score</code> – the score of the most relevant document found</li>
<li><code>hits.total.value</code> - how many matching documents were found</li>
<li><code>hits.sort</code> - the document’s sort position (when not sorting by relevance score)</li>
<li><code>hits._score</code> - the document’s relevance score (not applicable when using <code>match_all</code>)</li>
</ul>
</blockquote>
<h3 id="2）Query-DSL"><a href="#2）Query-DSL" class="headerlink" title="2）Query DSL"></a>2）Query DSL</h3><h4 id="（1）基本语法格式"><a href="#（1）基本语法格式" class="headerlink" title="（1）基本语法格式"></a>（1）基本语法格式</h4><p>Elasticsearch提供了一个可以执行查询的Json风格的DSL。这个被称为Query DSL，该查询语言非常全面。</p>
<p>一个查询语句的典型结构</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QUERY_NAME<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">   ARGUMENT<span class="punctuation">:</span>VALUE<span class="punctuation">,</span></span><br><span class="line">   ARGUMENT<span class="punctuation">:</span>VALUE<span class="punctuation">,</span>...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果针对于某个字段，那么它的结构如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  QUERY_NAME<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">     FIELD_NAME<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">       ARGUMENT<span class="punctuation">:</span>VALUE<span class="punctuation">,</span></span><br><span class="line">       ARGUMENT<span class="punctuation">:</span>VALUE<span class="punctuation">,</span>...</span><br><span class="line">      <span class="punctuation">&#125;</span>   </span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>query定义如何查询；</p>
<ul>
<li>match_all查询类型【代表查询所有的所有】，es中可以在query中组合非常多的查询类型完成复杂查询；</li>
<li>除了query参数之外，我们可也传递其他的参数以改变查询结果，如sort，size；</li>
<li>from+size限定，完成分页功能；</li>
<li>sort排序，多字段排序，会在前序字段相等时后续字段内部排序，否则以前序为准；</li>
</ul>
<h4 id="（2）返回部分字段"><a href="#（2）返回部分字段" class="headerlink" title="（2）返回部分字段"></a>（2）返回部分字段</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;balance&quot;</span><span class="punctuation">,</span><span class="string">&quot;firstname&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;999&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Dorothy&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">6087</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">999</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;998&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Letha&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">16869</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">998</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;997&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Combs&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">25311</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">997</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;996&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Andrews&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">17541</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">996</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;995&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Phelps&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">21153</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="number">995</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="（3）match匹配查询"><a href="#（3）match匹配查询" class="headerlink" title="（3）match匹配查询"></a>（3）match匹配查询</h4><ul>
<li>基本类型（非字符串），精确控制</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>match返回account_number=20的数据。上面匹配的20也可以不带引号</p>
<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;20&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">16418</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Elinor&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ratliff&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;282 Kings Place&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Scentric&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;elinorratliff@scentric.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ribera&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;WA&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>字符串，全文检索</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kings&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>全文检索，最终会按照评分进行排序，会对检索条件进行分词匹配。</strong></p>
<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.990829</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;20&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.990829</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">16418</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Elinor&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ratliff&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;282 Kings Place&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Scentric&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;elinorratliff@scentric.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ribera&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;WA&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;722&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.990829</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">722</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">27256</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Roberts&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Beasley&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">34</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;305 Kings Hwy&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Quintity&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;robertsbeasley@quintity.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hayden&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;PA&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="（4）-match-phrase-短句匹配"><a href="#（4）-match-phrase-短句匹配" class="headerlink" title="（4） match_phrase [短句匹配]"></a>（4） match_phrase [短句匹配]</h4><p>将需要匹配的值当成一整个单词（不分词）进行检索</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mill road&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查处address中包含mill_road的所有记录，并给出相关性得分</p>
<p>查看结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">8.926605</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">8.926605</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>match_phrase和Match的区别，观察如下实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;990 Mill&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">10.806405</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">10.806405</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用match的keyword</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;990 Mill&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果，一条也未匹配到</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>修改匹配条件为“990 Mill Road”</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address.keyword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询出一条数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.5032897</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.5032897</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>文本字段的匹配，使用<strong>keyword</strong>，匹配的条件就是要显示字段的全部值，要进行精确匹配的。</p>
<p>match_phrase是做短语匹配，只要文本中包含匹配条件，就能匹配到。</p>
<h4 id="（5）multi-math【多字段匹配】"><a href="#（5）multi-math【多字段匹配】" class="headerlink" title="（5）multi_math【多字段匹配】"></a>（5）multi_math【多字段匹配】</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mill&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;state&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;address&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>state或者address中包含mill，并且在查询过程中，会对于查询条件进行分词。</p>
<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;136&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">136</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">45801</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Winnie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Holland&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;198 Mill Lane&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Neteria&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;winnieholland@neteria.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Urie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IL&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;345&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">345</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">9812</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Parker&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hines&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;715 Mill Avenue&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Baluba&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;parkerhines@baluba.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Blackgum&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;KY&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;472&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">472</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">25571</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lee&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Long&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;288 Mill Street&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Comverges&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;leelong@comverges.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Movico&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;MT&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="（6）bool用来做复合查询"><a href="#（6）bool用来做复合查询" class="headerlink" title="（6）bool用来做复合查询"></a>（6）bool用来做复合查询</h4><p>复合语句可以合并，任何其他查询语句，包括符合语句。这也就意味着，复合语句之间<br>可以互相嵌套，可以表达非常复杂的逻辑。</p>
<p>must：必须达到must所列举的所有条件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">             <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="string">&quot;mill&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;M&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">             <span class="punctuation">]</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>must_not，必须不匹配must_not所列举的所有条件。</p>
<p>should，应该满足should所列举的条件。</p>
<p><strong>实例：查询gender=m，并且address=mill的数据</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mill&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;136&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">136</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">45801</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Winnie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Holland&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;198 Mill Lane&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Neteria&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;winnieholland@neteria.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Urie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IL&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;345&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">345</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">9812</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Parker&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hines&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;715 Mill Avenue&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Baluba&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;parkerhines@baluba.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Blackgum&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;KY&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>must_not：必须不是指定的情况</strong></p>
<p>实例：查询gender=m，并且address=mill的数据，但是age不等于38的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="string">&quot;mill&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;M&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;38&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>should：应该达到should列举的条件，如果到达会增加相关文档的评分，并不会改变查询的结果。如果query中只有should且只有一种匹配规则，那么should的条件就会被作为默认匹配条件二区改变查询结果。</strong></p>
<p>实例：匹配lastName应该等于Wallace的数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="string">&quot;mill&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;match&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span><span class="string">&quot;M&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">12.585751</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">12.585751</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;136&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">136</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">45801</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Winnie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Holland&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;198 Mill Lane&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Neteria&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;winnieholland@neteria.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Urie&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IL&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;345&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">6.0824604</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">345</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">9812</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Parker&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Hines&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;715 Mill Avenue&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Baluba&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;parkerhines@baluba.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Blackgum&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;KY&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>能够看到相关度越高，得分也越高。</p>
<h4 id="（7）Filter【结果过滤】"><a href="#（7）Filter【结果过滤】" class="headerlink" title="（7）Filter【结果过滤】"></a>（7）Filter【结果过滤】</h4><p>并不是所有的查询都需要产生分数，特别是哪些仅用于filtering过滤的文档。为了不计算分数，elasticsearch会自动检查场景并且优化查询的执行。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mill&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10000&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20000&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里先是查询所有匹配address=mill的文档，然后再根据10000&lt;=balance&lt;=20000进行过滤查询结果</p>
<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;970&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">5.4032025</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">970</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">19648</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Forbes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Wallace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;990 Mill Road&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pheast&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;forbeswallace@pheast.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Lopezo&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Each <code>must</code>, <code>should</code>, and <code>must_not</code> element in a Boolean query is referred to as a query clause. How well a document meets the criteria in each <code>must</code> or <code>should</code> clause contributes to the document’s <em>relevance score</em>. The higher the score, the better the document matches your search criteria. By default, Elasticsearch returns documents ranked by these relevance scores.</p>
<p> 在boolean查询中，<code>must</code>, <code>should</code> 和<code>must_not</code> 元素都被称为查询子句 。 文档是否符合每个“must”或“should”子句中的标准，决定了文档的“相关性得分”。  得分越高，文档越符合您的搜索条件。  默认情况下，Elasticsearch返回根据这些相关性得分排序的文档。 </p>
<p>The criteria in a <code>must_not</code> clause is treated as a <em>filter</em>. It affects whether or not the document is included in the results, but does not contribute to how documents are scored. You can also explicitly specify arbitrary filters to include or exclude documents based on structured data.</p>
<p><code>“must_not”子句中的条件被视为“过滤器”。</code> 它影响文档是否包含在结果中，  但不影响文档的评分方式。  还可以显式地指定任意过滤器来包含或排除基于结构化数据的文档。 </p>
<p>filter在使用过程中，并不会计算相关性得分：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10000&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20000&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">213</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;20&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">16418</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Elinor&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ratliff&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;282 Kings Place&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Scentric&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;elinorratliff@scentric.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ribera&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;WA&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;37&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">37</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">18612</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Mcgee&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Mooney&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;826 Fillmore Place&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Reversus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;mcgeemooney@reversus.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Tooleville&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      ......</span><br></pre></td></tr></table></figure>

<p><strong>能看到所有文档的 “_score” : 0.0。</strong></p>
<h4 id="（8）term"><a href="#（8）term" class="headerlink" title="（8）term"></a>（8）term</h4><p>和match一样。匹配某个属性的值。全文检索字段用match，其他非text字段匹配用term。</p>
<blockquote>
<p>Avoid using the <code>term</code> query for <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/text.html"><code>text</code></a> fields.</p>
<p>避免对文本字段使用“term”查询</p>
<p>By default, Elasticsearch changes the values of <code>text</code> fields as part of <a href="">analysis</a>. This can make finding exact matches for <code>text</code> field values difficult.</p>
<p>默认情况下，Elasticsearch作为<a href="">analysis</a>的一部分更改’ text ‘字段的值。这使得为“text”字段值寻找精确匹配变得困难。 </p>
<p>To search <code>text</code> field values, use the match.</p>
<p>要搜索“text”字段值，请使用匹配。</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/query-dsl-term-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/query-dsl-term-query.html</a> </p>
</blockquote>
<p>使用term匹配查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mill Road&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一条也没有匹配到</p>
<p>而更换为match匹配时，能够匹配到32个文档</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/30/1648633368.png" alt="desc"></p>
<p>也就是说，<strong>全文检索字段用match，其他非text字段匹配用term</strong>。</p>
<h4 id="（9）Aggregation（执行聚合）"><a href="#（9）Aggregation（执行聚合）" class="headerlink" title="（9）Aggregation（执行聚合）"></a>（9）Aggregation（执行聚合）</h4><p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于SQL Group by和SQL聚合函数。在elasticsearch中，执行搜索返回this（命中结果），并且同时返回聚合结果，把以响应中的所有hits（命中结果）分隔开的能力。这是非常强大且有效的，你可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用一次简洁和简化的API啦避免网络往返。</p>
<p>“size”:0</p>
<p>size:0不显示搜索数据<br>aggs：执行聚合。聚合语法如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aggs_name这次聚合的名字，方便展示在结果集中&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;AGG_TYPE聚合的类型(avg,term,terms)&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>，</span><br></pre></td></tr></table></figure>

<p><strong>搜索address中包含mill的所有人的年龄分布以及平均年龄，但不显示这些人的详情</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mill&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span> #假设年龄有<span class="number">100</span>种可能，只取出<span class="number">10</span>个</span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ageAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;balanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">34.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25208.0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>复杂：<br>按照年龄聚合，并且求这些年龄段的这些人的平均薪资</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ageAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">31</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">61</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28312.918032786885</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25269.583333333332</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">59</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">23194.813559322032</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">23951.346153846152</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22136.69230769231</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22174.71153846154</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">51</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">24731.07843137255</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">51</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28273.882352941175</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">33</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25093.94</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">34</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26809.95918367347</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">47</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22841.106382978724</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">46</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26981.434782608696</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">45</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27183.17777777778</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">44</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27741.227272727272</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27314.214285714286</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28519.04761904762</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27445.214285714286</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">37</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27022.261904761905</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">27</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">21471.871794871793</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26187.17948717949</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29483.14285714286</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查出所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;genderAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;balanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ageBalanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">31</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">61</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29565.628571428573</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26626.576923076922</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28312.918032786885</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26348.684210526317</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">23405.68181818182</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25269.583333333332</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">59</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25094.78125</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">27</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">20943.0</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">23194.813559322032</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22941.964285714286</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25128.958333333332</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">23951.346153846152</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">24226.321428571428</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">19698.791666666668</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22136.69230769231</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">31</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">20884.677419354837</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">24079.04761904762</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22174.71153846154</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">51</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">27</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22152.74074074074</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27631.708333333332</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">24731.07843137255</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">51</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">31</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27076.8064516129</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">30129.35</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28273.882352941175</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">33</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26437.615384615383</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">23638.291666666668</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25093.94</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">34</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26039.166666666668</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28027.0</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26809.95918367347</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">47</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25316.16</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">20028.545454545456</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">22841.106382978724</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">46</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28210.916666666668</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25640.18181818182</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26981.434782608696</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">45</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26474.958333333332</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27992.571428571428</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27183.17777777778</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">44</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">27</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29047.444444444445</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25666.647058823528</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27741.227272727272</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27730.75</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26758.833333333332</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27314.214285714286</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29414.521739130436</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27435.052631578947</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28519.04761904762</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29336.08695652174</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25156.263157894737</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27445.214285714286</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">37</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">25015.739130434784</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29451.21052631579</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27022.261904761905</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">27</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">21618.85714285714</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">21300.38888888889</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">21471.871794871793</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">27931.65</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">19</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">24350.894736842107</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">26187.17948717949</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;genderAgg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;doc_count_error_upper_bound&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sum_other_doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;buckets&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29943.17391304348</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;F&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_count&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;balanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">28601.416666666668</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ageBalanceAvg&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">29483.14285714286</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="3）Mapping"><a href="#3）Mapping" class="headerlink" title="3）Mapping"></a>3）Mapping</h3><h4 id="（1）字段类型"><a href="#（1）字段类型" class="headerlink" title="（1）字段类型"></a>（1）字段类型</h4><p><strong>核心类型：</strong></p>
<p>字符串(string): text,keyword</p>
<p>数字类型(Numeric)：long,integer,short,byte,double,float,half_float,scaled_float</p>
<p>日期类型(Date): date</p>
<p>布尔类型(Boolean): boolean</p>
<p>二进制类型(binary): binary</p>
<p><strong>复合类型：</strong></p>
<p>数组类型(Array): Array支持不针对特定的类型</p>
<p>对象类型(Object): object用于单JSON对象</p>
<p>嵌套类型(Nested): nested用户JSON对象数组</p>
<p><strong>地理类型(Geo)</strong></p>
<p>地理坐标(Geo-points): geo_point用于描述 经纬度坐标</p>
<p>地理图形(Geo-Shape): geo_shape用户描述复杂形状，如多边形</p>
<p><strong>特定类型：</strong></p>
<p>IP类型：ip用于描述ipv4和ipv6地址</p>
<p>补全类型（Completion）：completion提供自动完成提示</p>
<p>令牌计数类型（Token count）：token_count用于统计字符串种的词条数量</p>
<p>附件类型（attachment）：参考mapper-attachements插件，支持将附件如Microsoft Office格式，Open Document格式，ePub，HTML等等索引为attachment数据类型。</p>
<p>抽取类型（Percolator）：接受特定领域查询语言（query-dsl）的查询</p>
<p><strong>多字段：</strong></p>
<p>通常用于为不同的方法索引同一个字段。例如，string字段可以映射为一个text字段用于全文检索，同样可以映射为一个keyword字段用于排序和聚合。另外，你可以使用standard analyzer，english analyzer， french analyzer来索引一个text字段</p>
<p>这就是muti-fields的目的，大多数的数据类型通过fields参数来支持muti-fields。</p>
<h4 id="（2）映射"><a href="#（2）映射" class="headerlink" title="（2）映射"></a>（2）映射</h4><p>Mapping(映射)<br>Maping是用来定义一个文档（document），以及它所包含的属性（field）是如何存储和索引的。比如：使用maping来定义：</p>
<ul>
<li><p>哪些字符串属性应该被看做全文本属性（full text fields）；</p>
</li>
<li><p>哪些属性包含数字，日期或地理位置；</p>
</li>
<li><p>文档中的所有属性是否都嫩被索引（all 配置）；</p>
</li>
<li><p>日期的格式；</p>
</li>
<li><p>自定义映射规则来执行动态添加属性；</p>
</li>
<li><p>查看mapping信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_mapping</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;bank&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>修改mapping信息</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html</a></p>
<p>自动猜测的映射类型</p>
<table>
<thead>
<tr>
<th>JSON type</th>
<th>域 type</th>
</tr>
</thead>
<tbody><tr>
<td>布尔型：true 或者 false</td>
<td>boolean</td>
</tr>
<tr>
<td>整数：123</td>
<td>long</td>
</tr>
<tr>
<td>浮点数：123.45</td>
<td>double</td>
</tr>
<tr>
<td>字符串，有效日期：2014-09-15</td>
<td>date</td>
</tr>
<tr>
<td>字符串：foo bar</td>
<td>string</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="（3）新版本改变"><a href="#（3）新版本改变" class="headerlink" title="（3）新版本改变"></a>（3）新版本改变</h4><p>ElasticSearch7-去掉type概念</p>
<ol>
<li><p>关系型数据库中两个数据表示是独立的，即使他们里面有相同名称的列也不影响使用，但ES中不是这样的。elasticsearch是基于Lucene开发的搜索引擎，而ES中不同type下名称相同的filed最终在Lucene中的处理方式是一样的。</p>
<ul>
<li>两个不同type下的两个user_name，在ES同一个索引下其实被认为是同一个filed，你必须在两个不同的type中定义相同的filed映射。否则，不同type中的相同字段名称就会在处理中出现冲突的情况，导致Lucene处理效率下降。</li>
<li>去掉type就是为了提高ES处理数据的效率。</li>
</ul>
</li>
<li><p>Elasticsearch 7.x URL中的type参数为可选。比如，索引一个文档不再要求提供文档类型。</p>
</li>
<li><p>Elasticsearch 8.x 不再支持URL中的type参数。</p>
</li>
<li><p>解决：<br>将索引从多类型迁移到单类型，每种类型文档一个独立索引</p>
<p>将已存在的索引下的类型数据，全部迁移到指定位置即可。详见数据迁移</p>
</li>
</ol>
<blockquote>
<p><strong>Elasticsearch 7.x</strong></p>
<ul>
<li>Specifying types in requests is deprecated. For instance, indexing a document no longer requires a document <code>type</code>. The new index APIs are <code>PUT &#123;index&#125;/_doc/&#123;id&#125;</code> in case of explicit ids and <code>POST &#123;index&#125;/_doc</code> for auto-generated ids. Note that in 7.0, <code>_doc</code> is a permanent part of the path, and represents the endpoint name rather than the document type.</li>
<li>The <code>include_type_name</code> parameter in the index creation, index template, and mapping APIs will default to <code>false</code>. Setting the parameter at all will result in a deprecation warning.</li>
<li>The <code>_default_</code> mapping type is removed.</li>
</ul>
<p><strong>Elasticsearch 8.x</strong></p>
<ul>
<li>Specifying types in requests is no longer supported.</li>
<li>The <code>include_type_name</code> parameter is removed.</li>
</ul>
</blockquote>
<h4 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h4><p>创建索引并指定映射</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p> 输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;my_index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aliases&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;creation_date&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1648691594218&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2gowX9taSjmvYBz-OaDILQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;created&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;7060299&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;provided_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="添加新的字段映射"><a href="#添加新的字段映射" class="headerlink" title="添加新的字段映射"></a>添加新的字段映射</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;employee-id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里的 “index”: false，表明新增的字段不能被检索，只是一个冗余字段。</p>
<h4 id="更新映射"><a href="#更新映射" class="headerlink" title="更新映射"></a>更新映射</h4><p>对于已经存在的字段映射，我们不能更新。更新必须创建新的索引，进行数据迁移。</p>
<h4 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h4><p>先创建new_twitter的正确映射。然后使用如下方式进行数据迁移。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex <span class="punctuation">[</span>固定写法<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;twitter&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dest&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;new_twitters&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>将旧索引的type下的数据进行迁移</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex <span class="punctuation">[</span>固定写法<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;twitter&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;twitter&quot;</span><span class="punctuation">:</span><span class="string">&quot;twitter&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dest&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span><span class="string">&quot;new_twitters&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>更多详情见： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docs-reindex.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docs-reindex.html</a> </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span><span class="comment">//类型为account</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;account_number&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;balance&quot;</span> <span class="punctuation">:</span> <span class="number">39225</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;firstname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Amber&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;lastname&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Duke&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;age&quot;</span> <span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;gender&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;address&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;880 Holmes Lane&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;employer&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pyrami&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;email&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;amberduke@pyrami.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;city&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Brogan&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;state&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IL&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="regexp">/bank/</span>_mapping</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648692859.png" alt="desc"></p>
<p>想要将年龄修改为integer</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT /newbank</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;employer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;firstname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查看“newbank”的映射：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /newbank/_mapping</span><br></pre></td></tr></table></figure>

<p>能够看到age的映射类型被修改为了integer.</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648693176.png" alt="desc"></p>
<p>将bank中的数据迁移到newbank中</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;newbank&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>运行输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#! Deprecation<span class="punctuation">:</span> <span class="punctuation">[</span>types removal<span class="punctuation">]</span> Specifying types in reindex requests is deprecated.</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;updated&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;deleted&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;batches&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version_conflicts&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;noops&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retries&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bulk&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;search&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;throttled_millis&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;requests_per_second&quot;</span> <span class="punctuation">:</span> <span class="number">-1.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;throttled_until_millis&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;failures&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>查看newbank中的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /newbank/_search</span><br></pre></td></tr></table></figure>

<h3 id="4）分词"><a href="#4）分词" class="headerlink" title="4）分词"></a>4）分词</h3><p>一个tokenizer（分词器）接收一个字符流，将之分割为独立的tokens（词元，通常是独立的单词），然后输出tokens流。</p>
<p>例如：whitespace tokenizer遇到空白字符时分割文本。它会将文本“Quick brown fox!”分割为[Quick,brown,fox!]。</p>
<p>该tokenizer（分词器）还负责记录各个terms(词条)的顺序或position位置（用于phrase短语和word proximity词近邻查询），以及term（词条）所代表的原始word（单词）的start（起始）和end（结束）的character offsets（字符串偏移量）（用于高亮显示搜索的内容）。</p>
<p>elasticsearch提供了很多内置的分词器，可以用来构建custom analyzers（自定义分词器）。</p>
<p>关于分词器： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/analysis.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/analysis.html</a> </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The 2 QUICK Brown-Foxes jumped over the lazy dog&#x27;s bone.&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;the&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;NUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;quick&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;brown&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">17</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;foxes&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jumped&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;over&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">31</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">35</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;the&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;lazy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">44</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dog&#x27;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">45</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;bone&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">51</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">55</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="1）安装ik分词器"><a href="#1）安装ik分词器" class="headerlink" title="1）安装ik分词器"></a>1）安装ik分词器</h4><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648694712.png" alt="desc"></p>
<p>所有的语言分词，默认使用的都是“Standard Analyzer”，但是这些分词器针对于中文的分词，并不友好。为此需要安装中文的分词器。</p>
<p>注意：不能用默认elasticsearch-plugin install xxx.zip 进行自动安装<br><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a> 对应es版本安装</p>
<p>在前面安装的elasticsearch时，我们已经将elasticsearch容器的“/usr/share/elasticsearch/plugins”目录，映射到宿主机的“ /mydata/elasticsearch/plugins”目录下，所以比较方便的做法就是下载“/elasticsearch-analysis-ik-7.6.2.zip”文件，然后解压到该文件夹下即可。安装完毕后，需要重启elasticsearch容器。</p>
<p>如果不嫌麻烦，还可以采用如下的方式。</p>
<h5 id="a、查看elasticsearch版本号："><a href="#a、查看elasticsearch版本号：" class="headerlink" title="a、查看elasticsearch版本号："></a>a、查看elasticsearch版本号：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop-104 ~]# curl http://localhost:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;0adeb7852e00&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;9gglpP0HTfyOTRAaSe2rIg&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.6.2&quot;,      #版本号为7.6.2</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;docker&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2020-03-26T06:34:37.794943Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.4.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@hadoop-104 ~]# </span><br></pre></td></tr></table></figure>

<h5 id="b、进入es容器内部plugin目录"><a href="#b、进入es容器内部plugin目录" class="headerlink" title="b、进入es容器内部plugin目录"></a>b、进入es容器内部plugin目录</h5><ul>
<li>docker exec -it 容器id /bin/bash</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop-104 ~]# docker exec -it elasticsearch /bin/bash</span><br><span class="line">[root@0adeb7852e00 elasticsearch]# </span><br></pre></td></tr></table></figure>

<ul>
<li>wget <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.6.2/elasticsearch-analysis-ik-7.6.2.zip">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.6.2/elasticsearch-analysis-ik-7.6.2.zip</a></li>
<li>如果wget显示未找到命令，就需要先进行安装，yum install wget</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@0adeb7852e00 elasticsearch]# pwd</span><br><span class="line">/usr/share/elasticsearch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载ik7.6.2</span></span><br><span class="line">[root@0adeb7852e00 elasticsearch]# wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.6.2/elasticsearch-analysis-ik-7.6.2.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>unzip 下载的文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@0adeb7852e00 elasticsearch]# unzip elasticsearch-analysis-ik-7.6.2.zip -d ik</span><br><span class="line">Archive:  elasticsearch-analysis-ik-7.6.2.zip</span><br><span class="line">   creating: ik/config/</span><br><span class="line">  inflating: ik/config/main.dic      </span><br><span class="line">  inflating: ik/config/quantifier.dic  </span><br><span class="line">  inflating: ik/config/extra_single_word_full.dic  </span><br><span class="line">  inflating: ik/config/IKAnalyzer.cfg.xml  </span><br><span class="line">  inflating: ik/config/surname.dic   </span><br><span class="line">  inflating: ik/config/suffix.dic    </span><br><span class="line">  inflating: ik/config/stopword.dic  </span><br><span class="line">  inflating: ik/config/extra_main.dic  </span><br><span class="line">  inflating: ik/config/extra_stopword.dic  </span><br><span class="line">  inflating: ik/config/preposition.dic  </span><br><span class="line">  inflating: ik/config/extra_single_word_low_freq.dic  </span><br><span class="line">  inflating: ik/config/extra_single_word.dic  </span><br><span class="line">  inflating: ik/elasticsearch-analysis-ik-7.6.2.jar  </span><br><span class="line">  inflating: ik/httpclient-4.5.2.jar  </span><br><span class="line">  inflating: ik/httpcore-4.4.4.jar   </span><br><span class="line">  inflating: ik/commons-logging-1.2.jar  </span><br><span class="line">  inflating: ik/commons-codec-1.9.jar  </span><br><span class="line">  inflating: ik/plugin-descriptor.properties  </span><br><span class="line">  inflating: ik/plugin-security.policy  </span><br><span class="line">[root@0adeb7852e00 elasticsearch]# chmod -R 777 ik/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">移动到plugins目录下</span></span><br><span class="line">[root@0adeb7852e00 elasticsearch]# mv ik plugins/</span><br></pre></td></tr></table></figure>

<ul>
<li>rm -rf *.zip</li>
</ul>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@0adeb7852e00</span> elasticsearch]<span class="meta"># rm -rf elasticsearch-analysis-ik-7.6.2.zip </span></span><br></pre></td></tr></table></figure>

<p>确认是否安装好了分词器,进入到bin目录中执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-plugin list</span><br></pre></td></tr></table></figure>

<h4 id="2）测试分词器"><a href="#2）测试分词器" class="headerlink" title="2）测试分词器"></a>2）测试分词器</h4><p>使用默认</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;我是中国人&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>请观察执行结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;我&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;是&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;中&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;国&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;IDEOGRAPHIC&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用ik_smart分词器</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span> </span><br><span class="line">   <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;我是中国人&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;我&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;是&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;中国人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用ik_max_word分词器</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span> </span><br><span class="line">   <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;我是中国人&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;我&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;是&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;中国人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;中国&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;国人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3）对ES进行设置"><a href="#3）对ES进行设置" class="headerlink" title="3）对ES进行设置"></a>3）对ES进行设置</h4><p>由于之前为Linux分配的内存太小了，所以首先需要对虚拟机内存进行配置，</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648711729.png" alt="desc"></p>
<p>然后需要将ES的docker镜像删除掉重新设置一个新的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">1e3900cda632   elasticsearch:7.6.2   &quot;/usr/local/bin/dock…&quot;   ...</span><br><span class="line">[root@localhost ~]# docker stop 1e3</span><br><span class="line">[root@localhost ~]# docker rm 1e3</span><br><span class="line">[root@localhost ~]#docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e  &quot;discovery.type=single-node&quot; \</span><br><span class="line">-e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v  /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-d elasticsearch:7.6.2</span><br></pre></td></tr></table></figure>

<h4 id="4）自定义词库"><a href="#4）自定义词库" class="headerlink" title="4）自定义词库"></a>4）自定义词库</h4><p><strong>首先看第5部分附录的安装Nginx部分</strong></p>
<ul>
<li>修改/mydata/elasticsearch/plugins/ik/config中的IKAnalyzer.cfg.xml<br>/mydata/elasticsearch/plugins/ik/config</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;remote_ext_dict&quot;</span>&gt;</span>http://#/es/fenci.txt<span class="tag">&lt;/<span class="name">entry</span>&gt;</span> </span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>原来的xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改完成后，需要重启elasticsearch容器，否则修改不生效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost config]# docker restart elasticsearch</span><br></pre></td></tr></table></figure>

<p>更新完成后，es只会对于新增的数据用更新分词。历史数据是不会重新分词的。如果想要历史数据重新分词，需要执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST my_index/_update_by_query?conflicts=proceed</span><br></pre></td></tr></table></figure>

<p>http://#/es/fenci.txt，这个是nginx上资源的访问路径</p>
<p>在运行下面实例之前，需要安装nginx（安装方法见安装nginx），然后创建“fenci.txt”文件，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;乔碧萝&quot; &gt; /mydata/nginx/html/fenci.txt </span><br></pre></td></tr></table></figure>

<p>测试效果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span> </span><br><span class="line">   <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span><span class="string">&quot;乔碧萝殿下&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;乔碧萝&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;殿下&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="4、elasticsearch-Rest-Client"><a href="#4、elasticsearch-Rest-Client" class="headerlink" title="4、elasticsearch-Rest-Client"></a>4、elasticsearch-Rest-Client</h3><h4 id="1）9300-TCP"><a href="#1）9300-TCP" class="headerlink" title="1）9300: TCP"></a>1）9300: TCP</h4><ul>
<li>spring-data-elasticsearch:transport-api.jar;<ul>
<li>springboot版本不同，ransport-api.jar不同，不能适配es版本</li>
<li>7.x已经不建议使用，8以后就要废弃</li>
</ul>
</li>
</ul>
<h4 id="2）9200-HTTP"><a href="#2）9200-HTTP" class="headerlink" title="2）9200: HTTP"></a>2）9200: HTTP</h4><ul>
<li><p>jestClient: 非官方，更新慢；</p>
</li>
<li><p>RestTemplate：模拟HTTP请求，ES很多操作需要自己封装，麻烦；</p>
</li>
<li><p>HttpClient：同上；</p>
</li>
<li><p>Elasticsearch-Rest-Client：官方RestClient，封装了ES操作，API层次分明，上手简单；<br>最终选择Elasticsearch-Rest-Client（elasticsearch-rest-high-level-client）；<br> <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html</a> </p>
</li>
</ul>
<h3 id="5、附录：安装Nginx"><a href="#5、附录：安装Nginx" class="headerlink" title="5、附录：安装Nginx"></a>5、附录：安装Nginx</h3><ul>
<li><p>在mydata文件夹中先创建一个文件夹，nginx的有关内容放在文件夹中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mydata]# mkdir nginx</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li><p>随便启动一个nginx实例，只是为了复制出配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mydata]# docker run -p80:80 --name nginx -d nginx:1.10   </span><br></pre></td></tr></table></figure></li>
<li><p>将容器内的配置文件拷贝到/mydata/nginx/conf/ 下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mydata]# docker container cp nginx:/etc/nginx .</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">由于拷贝完成后文件会存在nginx文件夹，这里将nginx文件夹的名字改为conf</span></span><br><span class="line">[root@localhost mydata]# mv nginx conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">再次创建一个nginx文件夹</span></span><br><span class="line">[root@localhost mydata]# mkdir nginx</span><br><span class="line">[root@localhost mydata]# mv conf nginx/</span><br></pre></td></tr></table></figure></li>
<li><p>终止原容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop nginx</span><br></pre></td></tr></table></figure></li>
<li><p>执行命令删除原容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm nginx</span><br></pre></td></tr></table></figure></li>
<li><p>创建新的Nginx，执行以下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 80:80 --name nginx \</span><br><span class="line"> -v /mydata/nginx/html:/usr/share/nginx/html \</span><br><span class="line"> -v /mydata/nginx/logs:/var/log/nginx \</span><br><span class="line"> -v /mydata/nginx/conf/:/etc/nginx \</span><br><span class="line"> -d nginx:1.10</span><br></pre></td></tr></table></figure></li>
<li><p>设置开机启动nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update nginx --restart=always</span><br></pre></td></tr></table></figure></li>
<li><p>创建“/mydata/nginx/html/index.html”文件，测试是否能够正常访问</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;h2&gt;hello nginx!&lt;/h2&gt;&#x27;</span> &gt;<span class="built_in">index</span>.html</span><br></pre></td></tr></table></figure>

<p>访问：<a target="_blank" rel="noopener" href="http://ngix所在主机的ip/index.html">http://ngix所在主机的IP:80/index.html</a></p>
</li>
</ul>
<h2 id="SpringBoot整合ElasticSearch"><a href="#SpringBoot整合ElasticSearch" class="headerlink" title="SpringBoot整合ElasticSearch"></a>SpringBoot整合ElasticSearch</h2><h3 id="1、导入依赖"><a href="#1、导入依赖" class="headerlink" title="1、导入依赖"></a>1、导入依赖</h3><p>这里的版本要和所按照的ELK版本匹配。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在spring-boot-dependencies中所依赖的ELK版本位6.8.7</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;elasticsearch.version&gt;</span><span class="attribute">6</span>.<span class="number">8</span>.<span class="number">7</span>&lt;/elasticsearch.version&gt;</span><br></pre></td></tr></table></figure>

<p>需要在项目中将它改为7.6.2</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">elasticsearch.version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">elasticsearch.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2、编写测试类"><a href="#2、编写测试类" class="headerlink" title="2、编写测试类"></a>2、编写测试类</h3><h4 id="1）测试保存数据"><a href="#1）测试保存数据" class="headerlink" title="1）测试保存数据"></a>1）测试保存数据</h4><p> <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-document-index.html</a> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">indexData</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span> (<span class="string">&quot;users&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setUserName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">20</span>);</span><br><span class="line">    user.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">    <span class="comment">//设置要保存的内容</span></span><br><span class="line">    indexRequest.source(jsonString, XContentType.JSON);</span><br><span class="line">    <span class="comment">//执行创建索引和保存数据</span></span><br><span class="line">    <span class="type">IndexResponse</span> <span class="variable">index</span> <span class="operator">=</span> client.index(indexRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">    System.out.println(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试后：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/03/31/1648720214.png" alt="desc"></p>
<h4 id="2）测试获取数据"><a href="#2）测试获取数据" class="headerlink" title="2）测试获取数据"></a>2）测试获取数据</h4><p> <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html</a> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchData</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(</span><br><span class="line">        <span class="string">&quot;users&quot;</span>,</span><br><span class="line">        <span class="string">&quot;_-2vAHIB0nzmLJLkxKWk&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">GetResponse</span> <span class="variable">getResponse</span> <span class="operator">=</span> client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(getResponse);</span><br><span class="line">    <span class="type">String</span> <span class="variable">index</span> <span class="operator">=</span> getResponse.getIndex();</span><br><span class="line">    System.out.println(index);</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> getResponse.getId();</span><br><span class="line">    System.out.println(id);</span><br><span class="line">    <span class="keyword">if</span> (getResponse.isExists()) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">version</span> <span class="operator">=</span> getResponse.getVersion();</span><br><span class="line">        System.out.println(version);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> getResponse.getSourceAsString();</span><br><span class="line">        System.out.println(sourceAsString);</span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap();</span><br><span class="line">        System.out.println(sourceAsMap);</span><br><span class="line">        <span class="type">byte</span>[] sourceAsBytes = getResponse.getSourceAsBytes();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询state=”AK”的文档：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span>   <span class="comment">//匹配到了22条</span></span><br><span class="line">			<span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">3.7952394</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bank&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;account&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;210&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">3.7952394</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">				<span class="attr">&quot;account_number&quot;</span><span class="punctuation">:</span> <span class="number">210</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;balance&quot;</span><span class="punctuation">:</span> <span class="number">33946</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;firstname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Cherry&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;lastname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Carey&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;539 Tiffany Place&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;employer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Martgo&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cherrycarey@martgo.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fairacres&quot;</span><span class="punctuation">,</span></span><br><span class="line">				<span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AK&quot;</span></span><br><span class="line">			<span class="punctuation">&#125;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">           ....<span class="comment">//省略其他</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p><strong>搜索address中包含mill的所有人的年龄分布以及平均年龄，平均薪资</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mill&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ageAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ageAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;age&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;balanceAvg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;balance&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>java实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 复杂检索:在bank中搜索address中包含mill的所有人的年龄分布以及平均年龄，平均薪资</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchData</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1. 创建检索请求</span></span><br><span class="line">    <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.1）指定索引</span></span><br><span class="line">    searchRequest.indices(<span class="string">&quot;bank&quot;</span>);</span><br><span class="line">    <span class="comment">//1.2）构造检索条件</span></span><br><span class="line">    <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;address&quot;</span>,<span class="string">&quot;Mill&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.2.1)按照年龄分布进行聚合</span></span><br><span class="line">    TermsAggregationBuilder ageAgg=AggregationBuilders.terms(<span class="string">&quot;ageAgg&quot;</span>).field(<span class="string">&quot;age&quot;</span>).size(<span class="number">10</span>);</span><br><span class="line">    sourceBuilder.aggregation(ageAgg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.2.2)计算平均年龄</span></span><br><span class="line">    <span class="type">AvgAggregationBuilder</span> <span class="variable">ageAvg</span> <span class="operator">=</span> AggregationBuilders.avg(<span class="string">&quot;ageAvg&quot;</span>).field(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">    sourceBuilder.aggregation(ageAvg);</span><br><span class="line">    <span class="comment">//1.2.3)计算平均薪资</span></span><br><span class="line">    <span class="type">AvgAggregationBuilder</span> <span class="variable">balanceAvg</span> <span class="operator">=</span> AggregationBuilders.avg(<span class="string">&quot;balanceAvg&quot;</span>).field(<span class="string">&quot;balance&quot;</span>);</span><br><span class="line">    sourceBuilder.aggregation(balanceAvg);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;检索条件：&quot;</span>+sourceBuilder);</span><br><span class="line">    searchRequest.source(sourceBuilder);</span><br><span class="line">    <span class="comment">//2. 执行检索</span></span><br><span class="line">    <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;检索结果：&quot;</span>+searchResponse);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 将检索结果封装为Bean</span></span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit searchHit : searchHits) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> searchHit.getSourceAsString();</span><br><span class="line">        <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, Account.class);</span><br><span class="line">        System.out.println(account);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 获取聚合信息</span></span><br><span class="line">    <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line"></span><br><span class="line">    <span class="type">Terms</span> <span class="variable">ageAgg1</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;ageAgg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : ageAgg1.getBuckets()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">        System.out.println(<span class="string">&quot;年龄：&quot;</span>+keyAsString+<span class="string">&quot; ==&gt; &quot;</span>+bucket.getDocCount());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Avg</span> <span class="variable">ageAvg1</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;ageAvg&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;平均年龄：&quot;</span>+ageAvg1.getValue());</span><br><span class="line"></span><br><span class="line">    <span class="type">Avg</span> <span class="variable">balanceAvg1</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;balanceAvg&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;平均薪资：&quot;</span>+balanceAvg1.getValue());</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>可以尝试对比打印的条件和执行结果，和前面的ElasticSearch的检索语句和检索结果进行比较；</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="1-kibana控制台命令"><a href="#1-kibana控制台命令" class="headerlink" title="1. kibana控制台命令"></a>1. kibana控制台命令</h3><p>ctrl+home：回到文档首部；</p>
<p>ctril+end：回到文档尾部。</p>
<h1 id="商品上架"><a href="#商品上架" class="headerlink" title="商品上架"></a>商品上架</h1><h2 id="spu在es中的存储模型分析"><a href="#spu在es中的存储模型分析" class="headerlink" title="spu在es中的存储模型分析"></a>spu在es中的存储模型分析</h2><p>如果每个sku都存储规格参数，会有冗余存储，因为每个spu对应的sku的规格参数都一样</p>
<p>但是如果将规格参数单独建立索引会出现检索时出现大量数据传输的问题，会阻塞网络</p>
<p>因此我们选用第一种存储模型，以空间换时间</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/01/1648779243.png" alt="desc"></p>
<h2 id="向ES添加商品属性映射"><a href="#向ES添加商品属性映射" class="headerlink" title="向ES添加商品属性映射"></a>向ES添加商品属性映射</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;skuId&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;spuId&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;skuImg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;saleCount&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;long&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hotScore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;brandName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;brandImg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;catalogName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;attrs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;attrName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;attrValue&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="商品上架接口实现"><a href="#商品上架接口实现" class="headerlink" title="商品上架接口实现"></a>商品上架接口实现</h2><p>在SpuInfoController中添加商品上架功能的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 商品上架功能：https://easydoc.xyz/doc/75716633/ZUqEdvA4/DhOtFr4A</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;&#123;spuId&#125;/up&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">spuUp</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span>&#123;</span><br><span class="line">spuInfoService.up(spuId);</span><br><span class="line"><span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>商品上架需要在es中保存spu信息并更新spu的状态信息，由于<code>SpuInfoEntity</code>与索引的数据模型并不对应，所以我们要建立专门的vo进行数据传输</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuEsModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> String skuTitle;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal skuPrice;</span><br><span class="line">    <span class="keyword">private</span> String skuImg;</span><br><span class="line">    <span class="keyword">private</span> Long saleCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> hasStock;</span><br><span class="line">    <span class="keyword">private</span> Long hotScore;</span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="keyword">private</span> Long catalogId;</span><br><span class="line">    <span class="keyword">private</span> String brandName;</span><br><span class="line">    <span class="keyword">private</span> String brandImg;</span><br><span class="line">    <span class="keyword">private</span> String catalogName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Attrs&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Attrs</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line">        <span class="keyword">private</span> String attrValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写商品上架的接口</strong></p>
<p>由于每个spu对应的各个sku的规格参数相同，因此我们要将查询规格参数提前，只查询一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upSpuForSearch</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">       <span class="comment">//1、查出当前spuId对应的所有sku信息,品牌的名字</span></span><br><span class="line">       List&lt;SkuInfoEntity&gt; skuInfoEntities=skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line">       <span class="comment">//TODO 4、查出当前sku的所有可以被用来检索的规格属性</span></span><br><span class="line">       List&lt;ProductAttrValueEntity&gt; productAttrValueEntities = productAttrValueService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;ProductAttrValueEntity&gt;().eq(<span class="string">&quot;spu_id&quot;</span>, spuId));</span><br><span class="line">       List&lt;Long&gt; attrIds = productAttrValueEntities.stream().map(attr -&gt; &#123;</span><br><span class="line">           <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line">       List&lt;Long&gt; searchIds=attrService.selectSearchAttrIds(attrIds);</span><br><span class="line">       Set&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(searchIds);</span><br><span class="line">       List&lt;SkuEsModel.Attr&gt; searchAttrs = productAttrValueEntities.stream().filter(entity -&gt; &#123;</span><br><span class="line">           <span class="keyword">return</span> ids.contains(entity.getAttrId());</span><br><span class="line">       &#125;).map(entity -&gt; &#123;</span><br><span class="line">           SkuEsModel.<span class="type">Attr</span> <span class="variable">attr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>.Attr();</span><br><span class="line">           BeanUtils.copyProperties(entity, attr);</span><br><span class="line">           <span class="keyword">return</span> attr;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">//TODO 1、发送远程调用，库存系统查询是否有库存</span></span><br><span class="line">       Map&lt;Long, Boolean&gt; stockMap = <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           List&lt;Long&gt; longList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</span><br><span class="line">           List&lt;SkuHasStockVo&gt; skuHasStocks = wareFeignService.getSkuHasStocks(longList);</span><br><span class="line">           stockMap = skuHasStocks.stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, SkuHasStockVo::getHasStock));</span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           log.error(<span class="string">&quot;远程调用库存服务失败,原因&#123;&#125;&quot;</span>,e);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//2、封装每个sku的信息</span></span><br><span class="line">       Map&lt;Long, Boolean&gt; finalStockMap = stockMap;</span><br><span class="line">       List&lt;SkuEsModel&gt; skuEsModels = skuInfoEntities.stream().map(sku -&gt; &#123;</span><br><span class="line">           <span class="type">SkuEsModel</span> <span class="variable">skuEsModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>();</span><br><span class="line">           BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">           skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">           skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line">           <span class="comment">//TODO 2、热度评分。0</span></span><br><span class="line">           skuEsModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line">           <span class="comment">//TODO 3、查询品牌和分类的名字信息</span></span><br><span class="line">           <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandService.getById(sku.getBrandId());</span><br><span class="line">           skuEsModel.setBrandName(brandEntity.getName());</span><br><span class="line">           skuEsModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line">           <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryService.getById(sku.getCatalogId());</span><br><span class="line">           skuEsModel.setCatalogName(categoryEntity.getName());</span><br><span class="line">           <span class="comment">//设置可搜索属性</span></span><br><span class="line">           skuEsModel.setAttrs(searchAttrs);</span><br><span class="line">           <span class="comment">//设置是否有库存</span></span><br><span class="line">           skuEsModel.setHasStock(finalStockMap==<span class="literal">null</span>?<span class="literal">false</span>:finalStockMap.get(sku.getSkuId()));</span><br><span class="line">           <span class="keyword">return</span> skuEsModel;</span><br><span class="line">       &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//TODO 5、将数据发给es进行保存：gulimall-search</span></span><br><span class="line">       <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> searchFeignService.saveProductAsIndices(skuEsModels);</span><br><span class="line">       <span class="keyword">if</span> (r.getCode()==<span class="number">0</span>)&#123;</span><br><span class="line">           <span class="built_in">this</span>.baseMapper.upSpuStatus(spuId, ProductConstant.ProductStatusEnum.SPU_UP.getCode());</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           log.error(<span class="string">&quot;商品远程es保存失败&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h1 id="商城系统首页"><a href="#商城系统首页" class="headerlink" title="商城系统首页"></a>商城系统首页</h1><h2 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h2><p>前端使用了thymeleaf开发，因此要导入该依赖,并且为了改动页面实时生效导入devtools</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="渲染一级分类菜单"><a href="#渲染一级分类菜单" class="headerlink" title="渲染一级分类菜单"></a>渲染一级分类菜单</h2><p>由于访问首页时就要加载一级目录,所以我们需要在加载首页时获取该数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&#123;&quot;/&quot;, &quot;index.html&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">indexPage</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    <span class="comment">//获取所有的一级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; catagories = categoryService.getLevel1Catagories();</span><br><span class="line">    model.addAttribute(<span class="string">&quot;catagories&quot;</span>, catagories);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面遍历菜单数据</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;catagory:$&#123;catagories&#125;&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;header_main_left_a&quot;</span> <span class="attr">ctg-data</span>=<span class="string">&quot;3&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;ctg-data=$&#123;catagory.catId&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;catagory.name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/01/1648807749.png" alt="desc"></p>
<h2 id="渲染二级三级分类菜单"><a href="#渲染二级三级分类菜单" class="headerlink" title="渲染二级三级分类菜单"></a>渲染二级三级分类菜单</h2><p>首先创建一个VO类表示二级和三级菜单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Catelog2Vo</span> &#123;</span><br><span class="line">    <span class="comment">//父分类id</span></span><br><span class="line">    <span class="keyword">private</span> String catalog1Id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Catelog3Vo&gt; catalog3List;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Catelog3Vo</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String catalog2Id;</span><br><span class="line">        <span class="keyword">private</span> String id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意其中的catalog1Id属性和catalog2Id属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;index/catelog.json&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBodye</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJson</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> categoryService.getCategoryJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Catelog2Vo</span> &#123;</span><br><span class="line">    <span class="comment">//父分类id</span></span><br><span class="line">    <span class="keyword">private</span> String catelog1Id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Catelog3Vo&gt; catelog3List;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Catelog3Vo</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String catelog2Id;</span><br><span class="line">        <span class="keyword">private</span> String id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改resources/static/index下的catalogLoader.js文件中的访问路径为<code>index/catelog.json</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//1.查出所有1级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; level1Categories = getLevel1Catagories();</span><br><span class="line">        <span class="comment">//2.封装数据</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; parent_cid = level1Categories.stream().collect(Collectors.toMap(k -&gt; k.getCatId().toString(), v -&gt; &#123;</span><br><span class="line">            <span class="comment">//1.每一个1级分类,查到这个一级分类的二级分类</span></span><br><span class="line">            List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, v.getCatId()));</span><br><span class="line">            <span class="comment">//2.封装上面的结果</span></span><br><span class="line">            List&lt;Catelog2Vo&gt; catelog2Vos = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (categoryEntities != <span class="literal">null</span>) &#123;</span><br><span class="line">                catelog2Vos = categoryEntities.stream().map(l2 -&gt; &#123;</span><br><span class="line">                    <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(v.getCatId().toString(), l2.getCatId().toString(), l2.getName(), <span class="literal">null</span>);</span><br><span class="line">                    <span class="comment">//找当前二级分类的三级分类封装成vo</span></span><br><span class="line">                    List&lt;CategoryEntity&gt; level3Catelog = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, l2.getCatId()));</span><br><span class="line">                    <span class="keyword">if</span> (level3Catelog != <span class="literal">null</span>) &#123;</span><br><span class="line">                        List&lt;Catelog2Vo.Catelog3Vo&gt; collect = level3Catelog.stream().map(l3 -&gt; &#123;</span><br><span class="line">                            <span class="comment">//封装成指定格式</span></span><br><span class="line">                            Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(l2.getCatId().toString(), l3.getCatId().toString(), l3.getName());</span><br><span class="line">                            <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                        &#125;).collect(Collectors.toList());</span><br><span class="line">                        catelog2Vo.setCatalog3List(collect);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> catelog2Vos;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="keyword">return</span> parent_cid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/01/1648817806.png" alt="desc"></p>
<h1 id="搭建域名访问环境"><a href="#搭建域名访问环境" class="headerlink" title="搭建域名访问环境"></a>搭建域名访问环境</h1><h2 id="1-正向代理与反向代理"><a href="#1-正向代理与反向代理" class="headerlink" title="1. 正向代理与反向代理"></a>1. 正向代理与反向代理</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648863473.png" alt="desc"></p>
<p>nginx就是通过反向代理实现负载均衡</p>
<h2 id="2-Nginx配置文件"><a href="#2-Nginx配置文件" class="headerlink" title="2. Nginx配置文件"></a>2. Nginx配置文件</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648863801.png" alt="desc"></p>
<p>nginx.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">event块</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http块</span></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;    </span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>/etc/nginx/conf.d/default.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">/etc/nginx/conf.d/default.conf 的server块</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/log/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    # concurs with nginx&#x27;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Nginx-Windows搭建域名访问环境"><a href="#3-Nginx-Windows搭建域名访问环境" class="headerlink" title="3. Nginx+Windows搭建域名访问环境"></a>3. Nginx+Windows搭建域名访问环境</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648864295.png" alt="desc"></p>
<ol>
<li><p>修改windows hosts文件改变本地域名映射，将<code>gulimall.com</code>映射到虚拟机ip</p>
</li>
<li><p>修改nginx的根配置文件nginx.conf，将<code>upstream</code>映射到我们的网关服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream gulimall&#123;</span><br><span class="line">	server 192.168.56.1:88;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>修改nginx的server块配置文件<code>gulimall.conf</code>，将以<code>/</code>开头的请求转发至我们配好的<code>gulimall</code>的<code>upstream</code>,由于nginx的转发会丢失<code>host</code>头，所以我们添加头信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	proxy_pass http://gulimall;</span><br><span class="line">	proxy_set_header Host $host;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置网关服务，将域名为<code>.gulimall.com</code>转发至商品服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">gulimall_host</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://gulimall-product</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=**.gulimall.com</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="性能压测与优化"><a href="#性能压测与优化" class="headerlink" title="性能压测与优化"></a>性能压测与优化</h1><h2 id="1-压测工具与环境"><a href="#1-压测工具与环境" class="headerlink" title="1. 压测工具与环境"></a>1. 压测工具与环境</h2><ul>
<li><p>jvisualvm</p>
<p>用于检测java应用资源占用和垃圾回收的情况，cmd输入jvisualvm即可打开</p>
</li>
<li><p>Jmeter <a target="_blank" rel="noopener" href="https://jmeter.apache.org/download_jmeter.cgi">https://jmeter.apache.org/download_jmeter.cgi</a></p>
<p>下载后bin目录<code>jmeter.bat</code>打开</p>
</li>
<li><p>测试环境</p>
<p><strong>系统</strong>win10 Pro N for Workstations，<strong>CPU</strong> AMD Ryzen 7 4800，<strong>内存</strong>16G</p>
</li>
</ul>
<p>注：简单业务仅返回一个字符串</p>
<table>
<thead>
<tr>
<th align="center">压测内容</th>
<th align="center">压测线程数</th>
<th align="center">吞吐量/s</th>
<th align="center">90%响应时间</th>
<th align="center">99%响应时间</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Nginx</strong></td>
<td align="center">50</td>
<td align="center">6355</td>
<td align="center">4</td>
<td align="center">235</td>
</tr>
<tr>
<td align="center"><strong>Gateway</strong></td>
<td align="center">50</td>
<td align="center">14355</td>
<td align="center">5</td>
<td align="center">23</td>
</tr>
<tr>
<td align="center"><strong>简单服务</strong></td>
<td align="center">50</td>
<td align="center">27373</td>
<td align="center">3</td>
<td align="center">5</td>
</tr>
<tr>
<td align="center"><strong>首页一级菜单渲染</strong></td>
<td align="center">50</td>
<td align="center">252(db,thymeleaf)</td>
<td align="center">241</td>
<td align="center">316</td>
</tr>
<tr>
<td align="center"><strong>首页菜单渲染(开缓存)</strong></td>
<td align="center">50</td>
<td align="center">640</td>
<td align="center">100</td>
<td align="center">179</td>
</tr>
<tr>
<td align="center"><strong>首页菜单渲染(开缓存、优化数据库、关日志)</strong></td>
<td align="center">50</td>
<td align="center">1204</td>
<td align="center">50</td>
<td align="center">85</td>
</tr>
<tr>
<td align="center"><strong>三级分类数据获取</strong></td>
<td align="center">50</td>
<td align="center">5(db)</td>
<td align="center">10132</td>
<td align="center">10275</td>
</tr>
<tr>
<td align="center"><strong>三级分类(加索引)</strong></td>
<td align="center">50</td>
<td align="center">15(加索引)</td>
<td align="center">3715</td>
<td align="center">3871</td>
</tr>
<tr>
<td align="center"><strong>三级分类(优化业务)</strong></td>
<td align="center">50</td>
<td align="center">285</td>
<td align="center">205</td>
<td align="center">313</td>
</tr>
<tr>
<td align="center"><strong>三级分类(redis缓存)</strong></td>
<td align="center">50</td>
<td align="center">658</td>
<td align="center">97</td>
<td align="center">121</td>
</tr>
<tr>
<td align="center"><strong>首页全量数据获取</strong></td>
<td align="center">50</td>
<td align="center">2.5(静态资源)</td>
<td align="center">34096</td>
<td align="center">35168</td>
</tr>
<tr>
<td align="center"><strong>首页全量数据获取(动静分类)</strong></td>
<td align="center">50</td>
<td align="center">7</td>
<td align="center">3977</td>
<td align="center">5215</td>
</tr>
<tr>
<td align="center">Gateway+简单服务</td>
<td align="center">50</td>
<td align="center">6200</td>
<td align="center">13</td>
<td align="center">34</td>
</tr>
<tr>
<td align="center">全链路(Nginx+GateWay+简单服务)</td>
<td align="center">50</td>
<td align="center">1539</td>
<td align="center">46</td>
<td align="center">66</td>
</tr>
</tbody></table>
<ul>
<li>中间件越多，性能损失越大，大多都损失在网络交互了；</li>
<li>业务：<ul>
<li>Db（MySQL 优化）</li>
<li>模板的渲染速度（缓存）</li>
<li>静态资源</li>
</ul>
</li>
</ul>
<h2 id="2-首页菜单渲染优化数据库"><a href="#2-首页菜单渲染优化数据库" class="headerlink" title="2. 首页菜单渲染优化数据库"></a>2. 首页菜单渲染优化数据库</h2><p>优化数据库前</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevel1Catagories</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">       List&lt;CategoryEntity&gt; parent_cid = <span class="built_in">this</span>.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">       System.out.println(<span class="string">&quot;查询一级菜单时间:&quot;</span>+(System.currentTimeMillis()-start));</span><br><span class="line">       <span class="keyword">return</span> parent_cid;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查询一级菜单时间:4</span><br><span class="line">查询一级菜单时间:3</span><br></pre></td></tr></table></figure>

<p>给<code>parent_cid</code>添加索引后</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查询一级菜单时间:2</span><br><span class="line">查询一级菜单时间:3</span><br></pre></td></tr></table></figure>

<p>但是整体业务和吞吐量并没有优化，可能由于使用了远程数据库，通信时间较长？</p>
<h2 id="3-三级分类-优化业务"><a href="#3-三级分类-优化业务" class="headerlink" title="3. 三级分类(优化业务)"></a>3. 三级分类(优化业务)</h2><p><strong>优化前</strong></p>
<p>对二级菜单的每次遍历都需要查询数据库，浪费大量资源</p>
<p><strong>优化后</strong></p>
<p>仅查询一次数据库，剩下的数据通过遍历得到并封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJson</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; selectList = baseMapper.selectList(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.查出所有1级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; level1Categories = getParent_cid(selectList, <span class="number">0L</span>);</span><br><span class="line">    <span class="comment">//2.封装数据</span></span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; parent_cid = level1Categories.stream().collect(Collectors.toMap(k -&gt; k.getCatId().toString(), v -&gt; &#123;</span><br><span class="line">        <span class="comment">//1.每一个1级分类,查到这个一级分类的二级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; categoryEntities = getParent_cid(selectList,v.getCatId());</span><br><span class="line">        <span class="comment">//2.封装上面的结果</span></span><br><span class="line">        List&lt;Catelog2Vo&gt; catelog2Vos = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (categoryEntities != <span class="literal">null</span>) &#123;</span><br><span class="line">            catelog2Vos = categoryEntities.stream().map(l2 -&gt; &#123;</span><br><span class="line">                <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(v.getCatId().toString(), l2.getCatId().toString(), l2.getName(), <span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//找当前二级分类的三级分类封装成vo</span></span><br><span class="line">                List&lt;CategoryEntity&gt; level3Catelog = getParent_cid(selectList,l2.getCatId());</span><br><span class="line">                <span class="keyword">if</span> (level3Catelog != <span class="literal">null</span>) &#123;</span><br><span class="line">                    List&lt;Catelog2Vo.Catelog3Vo&gt; collect = level3Catelog.stream().map(l3 -&gt; &#123;</span><br><span class="line">                        <span class="comment">//封装成指定格式</span></span><br><span class="line">                        Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(l2.getCatId().toString(), l3.getCatId().toString(), l3.getName());</span><br><span class="line">                        <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                    &#125;).collect(Collectors.toList());</span><br><span class="line">                    catelog2Vo.setCatalog3List(collect);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> catelog2Vos;</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">return</span> parent_cid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;CategoryEntity&gt; <span class="title function_">getParent_cid</span><span class="params">(List&lt;CategoryEntity&gt; selectList, Long parent_cid)</span> &#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; collect = selectList.stream().filter(item -&gt; item.getParentCid() == parent_cid).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">    <span class="comment">//        return baseMapper.selectList(new QueryWrapper&lt;CategoryEntity&gt;().eq(&quot;parent_cid&quot;, v.getCatId()));</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Nginx动静分类"><a href="#4-Nginx动静分类" class="headerlink" title="4. Nginx动静分类"></a>4. Nginx动静分类</h2><p>由于动态资源和静态资源目前都处于服务端，所以为了减轻服务器压力，我们将js、css、img等静态资源放置在Nginx端，以减轻服务器压力</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/02/1648888974.png" alt="desc"></p>
<ol>
<li><p>在nginx的html文件夹创建staic文件夹，并将index/css等静态资源全部上传到该文件夹中</p>
</li>
<li><p>修改index.html的静态资源路径，使其全部带有static前缀<code>src=&quot;/static/index/img/img_09.png&quot;</code></p>
</li>
<li><p>修改nginx的配置文件<code>/mydata/nginx/conf/conf.d/gulimall.conf</code></p>
<p>如果遇到有<code>/static</code>为前缀的请求，转发至html文件夹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123;</span><br><span class="line">	root   /usr/share/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">	proxy_pass http://gulimall;</span><br><span class="line">	proxy_set_header Host $host;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><h2 id="1-本地缓存"><a href="#1-本地缓存" class="headerlink" title="1. 本地缓存"></a>1. 本地缓存</h2><h3 id="1-使用hashmap本地缓存"><a href="#1-使用hashmap本地缓存" class="headerlink" title="1)  使用hashmap本地缓存"></a>1)  使用hashmap本地缓存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试本地缓存，通过hashmap</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String,Object&gt; cache=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2Vo&gt;&gt; <span class="title function_">getCategoryMap</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, List&lt;Catalog2Vo&gt;&gt; catalogMap = (Map&lt;String, List&lt;Catalog2Vo&gt;&gt;) cache.get(<span class="string">&quot;catalogMap&quot;</span>);</span><br><span class="line">    <span class="comment">//如果没有缓存，则从数据库中查询并放入缓存中</span></span><br><span class="line">    <span class="keyword">if</span> (catalogMap == <span class="literal">null</span>) &#123;</span><br><span class="line">        catalogMap = getCategoriesDb();</span><br><span class="line">        cache.put(<span class="string">&quot;catalogMap&quot;</span>,catalogMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> catalogMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-整合redis进行测试"><a href="#2-整合redis进行测试" class="headerlink" title="2) 整合redis进行测试"></a>2) 整合redis进行测试</h3><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置redis主机地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="comment">#</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>使用springboot自动配置的RedisTemplate优化菜单获取业务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ValueOperations&lt;String, String&gt; ops = stringRedisTemplate.opsForValue();</span><br><span class="line"><span class="type">String</span> <span class="variable">catalogJson</span> <span class="operator">=</span> ops.get(<span class="string">&quot;catalogJson&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (catalogJson == <span class="literal">null</span>) &#123;</span><br><span class="line">    Map&lt;String, List&lt;Catalog2Vo&gt;&gt; categoriesDb = getCategoriesDb();</span><br><span class="line">    <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSON.toJSONString(categoriesDb);</span><br><span class="line">    ops.set(<span class="string">&quot;catalogJson&quot;</span>,toJSONString);</span><br><span class="line">    <span class="keyword">return</span> categoriesDb;</span><br><span class="line">&#125;</span><br><span class="line">Map&lt;String, List&lt;Catalog2Vo&gt;&gt; listMap = JSON.parseObject(catalogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catalog2Vo&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line"><span class="keyword">return</span> listMap;</span><br></pre></td></tr></table></figure>

<p><strong>内存泄漏及解决办法</strong></p>
<p>当进行压力测试时后期后出现堆外内存溢出OutOfDirectMemoryError</p>
<p>产生原因：</p>
<p>1)、springboot2.0以后默认使用lettuce操作redis的客户端，它使用通信</p>
<p>2)、lettuce的bug导致netty堆外内存溢出</p>
<p>解决方案：由于是lettuce的bug造成，不能直接使用-Dio.netty.maxDirectMemory去调大虚拟机堆外内存</p>
<p>1)、升级lettuce客户端。   2）、切换使用jedis</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-高并发下缓存失效问题"><a href="#3-高并发下缓存失效问题" class="headerlink" title="3) 高并发下缓存失效问题"></a>3) 高并发下缓存失效问题</h3><p><strong>缓存穿透</strong></p>
<p>指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也无此记录，我们没有将这次查询的null写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义</p>
<p>风险：<br>利用不存在的数据进行攻击，数据库瞬时压力增大，最终导致崩溃</p>
<p>解决：<br>null结果缓存，并加入短暂过期时间</p>
<p><strong>缓存雪崩</strong></p>
<p>缓存雪崩是指在我们设置缓存时key采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时<br>压力过重雪崩。</p>
<p>解决：<br>原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>
<p><strong>缓存击穿</strong></p>
<ul>
<li><p>对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。</p>
</li>
<li><p>如果这个key在大量请求同时进来前正好失效，那么所有对这个key的数据查询都落到db，我们称为缓存击穿。</p>
</li>
</ul>
<p>解决：<br>加锁。大量并发只让一个去查，其他人等待，查到以后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去db</p>
<h3 id="4-加锁解决缓存击穿问题"><a href="#4-加锁解决缓存击穿问题" class="headerlink" title="4) 加锁解决缓存击穿问题"></a>4) 加锁解决缓存击穿问题</h3><p>将查询db的方法加锁，这样在同一时间只有一个方法能查询数据库，就能解决缓存击穿的问题了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJson</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.加入缓存逻辑，缓存中存的数据是json字符串</span></span><br><span class="line">    <span class="comment">//JSON跨语言，跨平台兼容</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">catelogJson</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;catelogJson&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (catelogJson == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//2.缓存中没有，查询数据库</span></span><br><span class="line">        System.out.println(<span class="string">&quot;缓存没有命中..进入getCategoryJsonFromDB方法&quot;</span>);</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; categoriesDb = getCategoryJsonFromDB();</span><br><span class="line">        <span class="comment">//3.查到的数据再放入缓存，将对象转为json放在缓存中</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSON.toJSONString(categoriesDb);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;catelogJson&quot;</span>,toJSONString);</span><br><span class="line">        <span class="keyword">return</span> categoriesDb;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;缓存命中....&quot;</span>);</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; listMap = JSON.parseObject(catelogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> listMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDB</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">catelogJson</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;catelogJson&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(catelogJson)) &#123;</span><br><span class="line">            Map&lt;String, List&lt;Catelog2Vo&gt;&gt; listMap = JSON.parseObject(catelogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">            <span class="keyword">return</span> listMap;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询数据库........&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-锁时序问题"><a href="#5-锁时序问题" class="headerlink" title="5)  锁时序问题"></a>5)  锁时序问题</h3><p>在上述方法中，我们将业务逻辑中的<code>确认缓存没有</code>和<code>查数据库</code>放到了锁里，但是最终控制台却打印了两次查询了数据库。这是因为在将结果放入缓存的这段时间里，有其他线程确认缓存没有，又再次查询了数据库，因此我们要将<code>结果放入缓存</code>也进行加锁</p>
<p>优化代码逻辑后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDB</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">catelogJson</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;catelogJson&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(catelogJson)) &#123;</span><br><span class="line">            Map&lt;String, List&lt;Catelog2Vo&gt;&gt; listMap = JSON.parseObject(catelogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">            <span class="keyword">return</span> listMap;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询数据库........&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//查到的数据再放入缓存，将对象转为json放在缓存中</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSON.toJSONString(parent_cid);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;catelogJson&quot;</span>,toJSONString);</span><br><span class="line">        <span class="keyword">return</span> parent_cid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优化后多线程访问时仅查询一次数据库</p>
<h2 id="2-分布式缓存"><a href="#2-分布式缓存" class="headerlink" title="2. 分布式缓存"></a>2. 分布式缓存</h2><h3 id="1-本地缓存面临问题"><a href="#1-本地缓存面临问题" class="headerlink" title="1) 本地缓存面临问题"></a>1) 本地缓存面临问题</h3><p>当有多个服务存在时，每个服务的缓存仅能够为本服务使用，这样每个服务都要查询一次数据库，并且当数据更新时只会更新单个服务的缓存数据，就会造成数据不一致的问题</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648980967.png" alt="desc"></p>
<p>所有的服务都到同一个redis进行获取数据，就可以避免这个问题</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648980997.png" alt="desc"></p>
<h3 id="2-分布式锁"><a href="#2-分布式锁" class="headerlink" title="2)  分布式锁"></a>2)  分布式锁</h3><p>当分布式项目在高并发下也需要加锁，但本地锁只能锁住当前服务，这个时候就需要分布式锁</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981025.png" alt="desc"></p>
<h3 id="3-分布式锁的演进"><a href="#3-分布式锁的演进" class="headerlink" title="3) 分布式锁的演进"></a>3) 分布式锁的演进</h3><p><strong>基本原理</strong></p>
<p>我们可以同时去一个地方“占坑”，如果占到，就执行逻辑。否则就必须等待，直到释放锁。“占坑”可以去redis，可以去数据库，可以去任何大家都能访问的地方。等待可以自旋的方式。</p>
<p><strong>阶段一</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981054.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDBWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//阶段一</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;111&quot;</span>);</span><br><span class="line">    <span class="comment">//获取到锁，执行业务</span></span><br><span class="line">    <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">        Map&lt;String, List&lt;Catalog2Vo&gt;&gt; categoriesDb = getCategoryMap();</span><br><span class="line">        <span class="comment">//删除锁，如果在此之前报错或宕机会造成死锁</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> categoriesDb;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//没获取到锁，等待100ms重试</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getCatelogJsonDbWithRedisLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2Vo&gt;&gt; <span class="title function_">getCategoryMap</span><span class="params">()</span> &#123;</span><br><span class="line">        ValueOperations&lt;String, String&gt; ops = redisTemplate.opsForValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogJson</span> <span class="operator">=</span> ops.get(<span class="string">&quot;catalogJson&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(catalogJson)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;缓存不命中，准备查询数据库。。。&quot;</span>);</span><br><span class="line">            Map&lt;String, List&lt;Catalog2Vo&gt;&gt; categoriesDb= getCategoryJsonFromDBWithRedisLock();</span><br><span class="line">            <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSON.toJSONString(categoriesDb);</span><br><span class="line">            ops.set(<span class="string">&quot;catalogJson&quot;</span>, toJSONString);</span><br><span class="line">            <span class="keyword">return</span> categoriesDb;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;缓存命中。。。。&quot;</span>);</span><br><span class="line">        Map&lt;String, List&lt;Catalog2Vo&gt;&gt; listMap = JSON.parseObject(catalogJson, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catalog2Vo&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">        <span class="keyword">return</span> listMap;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>问题：<br>1、setnx占好了位，业务代码异常或者程序在页面过程中宕机。没有执行删除锁逻辑，这就造成了死锁</p>
<p>解决：设置锁的自动过期，即使没有删除，会自动删除</p>
<p><strong>阶段二</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981233.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDBWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//占分布式锁，去redis占坑,阶段2</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;111&quot;</span>);</span><br><span class="line">    <span class="comment">//获取到锁，执行业务</span></span><br><span class="line">    <span class="keyword">if</span>(lock)&#123;</span><br><span class="line">        <span class="comment">//设置过期时间</span></span><br><span class="line">        redisTemplate.expire(<span class="string">&quot;lock&quot;</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//加锁成功</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; dataFromDB = getDataFromDB();</span><br><span class="line">        <span class="comment">//删除锁，如果在此之前报错或宕机会造成死锁</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> dataFromDB;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//加锁失败...</span></span><br><span class="line">        <span class="comment">//休眠100ms重试</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getCategoryJsonFromDBWithLocalLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：<br>1、setnx设置好，正要去设置过期时间，宕机。又死锁了。<br>解决：<br>设置过期时间和占位必须是原子的。redis支持使用setnx ex命令</p>
<p><strong>阶段三</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981530.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDBWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//占分布式锁，去redis占坑,阶段1，2</span></span><br><span class="line">    <span class="comment">//Boolean lock = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;111&quot;);</span></span><br><span class="line">    <span class="comment">//加锁的同时设置过期时间，二者是原子性操作，阶段3</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;111&quot;</span>,<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//获取到锁，执行业务</span></span><br><span class="line">    <span class="keyword">if</span>(lock)&#123;</span><br><span class="line">        <span class="comment">//设置过期时间</span></span><br><span class="line">        <span class="comment">//redisTemplate.expire(&quot;lock&quot;, 30, TimeUnit.SECONDS);</span></span><br><span class="line">        <span class="comment">//加锁成功</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; dataFromDB = getDataFromDB();</span><br><span class="line">        <span class="comment">//删除锁，如果在此之前报错或宕机会造成死锁</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> dataFromDB;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//加锁失败...</span></span><br><span class="line">        <span class="comment">//休眠100ms重试</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getCategoryJsonFromDBWithLocalLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：<br>1、删除锁直接删除？？？<br>如果由于业务时间很长，锁自己过期了，我们直接删除，有可能把别人正在持有的锁删除了。<br>解决：<br>占锁的时候，值指定为uuid，每个人匹配是自己的锁才删除。</p>
<p><strong>阶段四</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648981632.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDBWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//占分布式锁，去redis占坑,阶段2</span></span><br><span class="line">    <span class="comment">//Boolean lock = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;111&quot;);</span></span><br><span class="line">    <span class="comment">//加锁的同时设置过期时间，二者是原子性操作，阶段3</span></span><br><span class="line">    <span class="comment">//Boolean lock = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;111&quot;,5, TimeUnit.SECONDS);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//为当前锁设置唯一的uuid，只有当uuid相同时才会进行删除锁的操作，阶段4</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//获取到锁，执行业务</span></span><br><span class="line">    <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">        <span class="comment">//设置过期时间</span></span><br><span class="line">        <span class="comment">//redisTemplate.expire(&quot;lock&quot;, 30, TimeUnit.SECONDS);</span></span><br><span class="line">        <span class="comment">//加锁成功</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; dataFromDB = getDataFromDB();</span><br><span class="line">        <span class="comment">////获取值对比+对比成功删除=原子操作，阶段4</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockValue</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (uuid.equals(lockValue)) &#123;</span><br><span class="line">            <span class="comment">//删除锁，如果在此之前报错或宕机会造成死锁</span></span><br><span class="line">            redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataFromDB;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//加锁失败...</span></span><br><span class="line">        <span class="comment">//休眠100ms重试</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getCategoryJsonFromDBWithLocalLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：<br>1、如果正好判断是当前值，正要删除锁的时候，锁已经过期，别人已经设置到了新的值。那么我们删除的是别人的锁<br>解决：<br>删除锁必须保证原子性。使用redis+Lua脚本完成</p>
<p><strong>阶段五-最终形态</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/03/1648983252.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCategoryJsonFromDBWithRedisLock</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//占分布式锁，去redis占坑,阶段1，2</span></span><br><span class="line">    <span class="comment">//Boolean lock = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;111&quot;);</span></span><br><span class="line">    <span class="comment">//加锁的同时设置过期时间，二者是原子性操作，阶段3</span></span><br><span class="line">    <span class="comment">//Boolean lock = redisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;111&quot;,5, TimeUnit.SECONDS);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//为当前锁设置唯一的uuid，只有当uuid相同时才会进行删除锁的操作，阶段4</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//获取到锁，执行业务</span></span><br><span class="line">    <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;获取分布式锁成功...&quot;</span>);</span><br><span class="line">        <span class="comment">//设置过期时间</span></span><br><span class="line">        <span class="comment">//redisTemplate.expire(&quot;lock&quot;, 30, TimeUnit.SECONDS);</span></span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; dataFromDB;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//加锁成功</span></span><br><span class="line">            dataFromDB = getDataFromDB();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//获取值对比+对比成功删除=原子操作，lua脚本，阶段5</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    return redis.call(&#x27;del&#x27;,KEYS[1])\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;else\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    return 0\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;end&quot;</span>;</span><br><span class="line">            redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;Long&gt;(script, Long.class), Arrays.asList(<span class="string">&quot;lock&quot;</span>), uuid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取值对比+对比成功删除=原子操作，阶段4</span></span><br><span class="line">        <span class="comment">//String lockValue = redisTemplate.opsForValue().get(&quot;lock&quot;);</span></span><br><span class="line">        <span class="comment">//if (uuid.equals(lockValue)) &#123;</span></span><br><span class="line">        <span class="comment">//删除锁，如果在此之前报错或宕机会造成死锁</span></span><br><span class="line">        <span class="comment">//redisTemplate.delete(&quot;lock&quot;);</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="keyword">return</span> dataFromDB;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//加锁失败...</span></span><br><span class="line">        <span class="comment">//休眠100ms重试</span></span><br><span class="line">        System.out.println(<span class="string">&quot;获取分布式锁失败...等待重试...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getCategoryJsonFromDBWithLocalLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保证加锁【占位+过期时间】和删除锁【判断+删除】的原子性。更难的事情，锁的自动续期</p>
<h3 id="4-Redisson"><a href="#4-Redisson" class="headerlink" title="4) Redisson"></a>4) Redisson</h3><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(<code>BitSet</code>, <code>Set</code>, <code>Multimap</code>, <code>SortedSet</code>, <code>Map</code>, <code>List</code>, <code>Queue</code>, <code>BlockingQueue</code>, <code>Deque</code>, <code>BlockingDeque</code>, <code>Semaphore</code>, <code>Lock</code>, <code>AtomicLong</code>, <code>CountDownLatch</code>, <code>Publish / Subscribe</code>, <code>Bloom filter</code>, <code>Remote service</code>, <code>Spring cache</code>, <code>Executor service</code>, <code>Live Object service</code>, <code>Scheduler service</code>) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p>
<p>本文我们仅关注分布式锁的实现，更多请参考<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8">官方文档</a></p>
<h4 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="(1) 环境搭建"></a>(1) 环境搭建</h4><p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>开启配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.56.10:6379&quot;</span>);</span><br><span class="line">        <span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config);</span><br><span class="line">        <span class="keyword">return</span> redisson;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-可重入锁（Reentrant-Lock）"><a href="#2-可重入锁（Reentrant-Lock）" class="headerlink" title="(2)  可重入锁（Reentrant Lock）"></a>(2)  可重入锁（Reentrant Lock）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;my-lock&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;加锁成功，执行业务...&quot;</span>+Thread.currentThread().getId());</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;释放锁...&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果负责储存这个分布式锁的Redisson节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，所以就设置了过期时间，但是如果业务执行时间过长，业务还未执行完锁就已经过期，那么就会出现解锁时解了其他线程的锁的情况。</p>
<p>所以Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92">Config.lockWatchdogTimeout</a>来另行指定。</p>
<p>在本次测试中<code>lock</code>的初始过期时间TTL为30s，但是每到1/3看门狗时间就会自动续借成30s</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649040896.png" alt="desc"></p>
<p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。不会自动续期！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加锁以后10秒钟自动解锁</span></span><br><span class="line"><span class="comment">// 无需调用unlock方法手动解锁,如果要手动解锁一定要确保业务执行时间小于锁的失效时间</span></span><br><span class="line">lock.lock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> lock.tryLock(<span class="number">100</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (res) &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     ...</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       lock.unlock();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-读写锁（ReadWriteLock）"><a href="#3-读写锁（ReadWriteLock）" class="headerlink" title="(3) 读写锁（ReadWriteLock）"></a>(3) 读写锁（ReadWriteLock）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保证一定能读到最新数据，修改期间，写锁是一个排他锁</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/write&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">writeValue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">RReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(<span class="string">&quot;rw-lock&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> readWriteLock.writeLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//1.改数据加写锁，读数据加读锁</span></span><br><span class="line">        rLock.lock();</span><br><span class="line">        uuid = UUID.randomUUID().toString();</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;writeValue&quot;</span>,uuid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        rLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uuid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/read&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">readValue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">RReadWriteLock</span> <span class="variable">readWriteLock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(<span class="string">&quot;rw-lock&quot;</span>);</span><br><span class="line">    <span class="comment">//加读锁</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> readWriteLock.readLock();</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rLock.lock();</span><br><span class="line">        res = redisTemplate.opsForValue().get(<span class="string">&quot;writeValue&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        rLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写锁会阻塞读锁，但是读锁不会阻塞读锁，但读锁会阻塞写锁</p>
<p>总之含有写的过程都会被阻塞，只有读读不会被阻塞</p>
<p>上锁时在redis的状态</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649042053.png" alt="desc"></p>
<h4 id="4-信号量（Semaphore）"><a href="#4-信号量（Semaphore）" class="headerlink" title="(4) 信号量（Semaphore）"></a>(4) 信号量（Semaphore）</h4><p>信号量为存储在redis中的一个数字，当这个数字大于0时，即可以调用<code>acquire()</code>方法增加数量，也可以调用<code>release()</code>方法减少数量，但是当调用<code>release()</code>之后小于0的话方法就会阻塞，直到数字大于0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/park&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">park</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redissonClient.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        park.acquire(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;停进2&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/go&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">go</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redissonClient.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">    park.release(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;开走2&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-闭锁（CountDownLatch）"><a href="#5-闭锁（CountDownLatch）" class="headerlink" title="(5) 闭锁（CountDownLatch）"></a>(5) 闭锁（CountDownLatch）</h4><p>可以理解为门栓，使用若干个门栓将当前方法阻塞，只有当全部门栓都被放开时，当前方法才能继续执行。</p>
<p>以下代码只有<code>offLatch()</code>被调用5次后 <code>setLatch()</code>才能继续执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/setLatch&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">setLatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RCountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> redissonClient.getCountDownLatch(<span class="string">&quot;CountDownLatch&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        latch.trySetCount(<span class="number">5</span>);</span><br><span class="line">        latch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;门栓被放开&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/offLatch&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">offLatch</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RCountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> redissonClient.getCountDownLatch(<span class="string">&quot;CountDownLatch&quot;</span>);</span><br><span class="line">    latch.countDown();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;门栓被放开1&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-缓存数据的一致性"><a href="#3-缓存数据的一致性" class="headerlink" title="3. 缓存数据的一致性"></a>3. 缓存数据的一致性</h2><h3 id="1-双写模式"><a href="#1-双写模式" class="headerlink" title="1)  双写模式"></a>1)  双写模式</h3><p>当数据更新时，更新数据库时同时更新缓存</p>
<p><strong>存在问题</strong></p>
<p>由于卡顿等原因，导致写缓存2在最前，写缓存1在后面就出现了不一致</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649050459.png" alt="desc"></p>
<p>这是暂时性的脏数据问题，但是在数据稳定，缓存过期以后，又能得到最新的正确数据</p>
<h3 id="2-失效模式"><a href="#2-失效模式" class="headerlink" title="2) 失效模式"></a>2) 失效模式</h3><p>数据库更新时将缓存删除</p>
<p><strong>存在问题</strong></p>
<p>当两个请求同时修改数据库，一个请求已经更新成功并删除缓存时又有读数据的请求进来，这时候发现缓存中无数据就去数据库中查询并放入缓存，在放入缓存前第二个更新数据库的请求成功，这时候留在缓存中的数据依然是第一次数据更新的数据</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649050967.png" alt="desc"></p>
<p><strong>解决方法</strong></p>
<p>1、缓存的所有数据都有过期时间，数据过期下一次查询触发主动更新<br>2、读写数据的时候(并且写的不频繁)，加上分布式的读写锁。</p>
<h3 id="3-解决方案"><a href="#3-解决方案" class="headerlink" title="3) 解决方案"></a>3) 解决方案</h3><p>无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？</p>
<ul>
<li><p>如果是用户纬度数据（订单数据、用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间触发读的主动更新即可</p>
</li>
<li><p>如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/04/1649051078.png" alt="desc"></p>
</li>
<li><p>缓存数据+过期时间也足够解决大部分业务对于缓存的要求。</p>
</li>
<li><p>通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时脏数据可忽略）；</p>
</li>
</ul>
<p>总结：</p>
<ul>
<li>我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。</li>
<li>我们不应该过度设计，增加系统的复杂性</li>
<li>遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。</li>
</ul>
<h2 id="4-SpringCache"><a href="#4-SpringCache" class="headerlink" title="4. SpringCache"></a>4. SpringCache</h2><h3 id="1-导入依赖"><a href="#1-导入依赖" class="headerlink" title="1)  导入依赖"></a>1)  导入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-自定义配置"><a href="#2-自定义配置" class="headerlink" title="2) 自定义配置"></a>2) 自定义配置</h3><p>指定缓存类型并在主配置类上加上注解<code>@EnableCaching</code></p>
<p>在<code>application.properties</code>文件中可进行如下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定缓存类型为redis</span></span><br><span class="line"><span class="string">spring.cache.type=redis</span></span><br><span class="line"><span class="comment">#指定redis中的过期时间为1h</span></span><br><span class="line"><span class="string">spring.cache.redis.time-to-live=3600000</span></span><br><span class="line"><span class="comment">#如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span></span><br><span class="line"><span class="comment">#spring.cache.redis.key-prefix=CACHE_</span></span><br><span class="line"><span class="string">spring.cache.redis.use-key-prefix=true</span></span><br><span class="line"><span class="comment">#是否缓存空值，防止缓存穿透</span></span><br><span class="line"><span class="string">spring.cache.redis.cache-null-values=true</span></span><br></pre></td></tr></table></figure>

<p>默认使用jdk进行序列化，自定义序列化方式需要编写配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCacheConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> org.springframework.data.redis.cache.RedisCacheConfiguration <span class="title function_">redisCacheConfiguration</span><span class="params">(</span></span><br><span class="line"><span class="params">            CacheProperties cacheProperties)</span> &#123;</span><br><span class="line">        CacheProperties.<span class="type">Redis</span> <span class="variable">redisProperties</span> <span class="operator">=</span> cacheProperties.getRedis();</span><br><span class="line">        org.springframework.data.redis.cache.<span class="type">RedisCacheConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> org.springframework.data.redis.cache.RedisCacheConfiguration</span><br><span class="line">                .defaultCacheConfig();</span><br><span class="line">        <span class="comment">//指定缓存序列化方式为json</span></span><br><span class="line">        config = config.serializeValuesWith(</span><br><span class="line">                RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>()));</span><br><span class="line">        <span class="comment">//设置配置文件中的各项配置，如过期时间</span></span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-自定义序列化原理"><a href="#3-自定义序列化原理" class="headerlink" title="3) 自定义序列化原理"></a>3) 自定义序列化原理</h3><p>缓存使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用该方法时会将结果缓存，缓存名为category，key为方法名</span></span><br><span class="line"><span class="comment">//表示该方法的缓存被读取时会加锁</span></span><br><span class="line"><span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;,key = &quot;#root.method.name&quot;,sync = true)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catalog2Vo&gt;&gt; <span class="title function_">getCatalogJsonDbWithSpringCache</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getCategoriesDb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用该方法会删除缓存category下的所有cache</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &#123;&quot;category&quot;&#125;,allEntries = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateById(category);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(category.getName())) &#123;</span><br><span class="line">        categoryBrandRelationService.updateCategory(category);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Spring-Cache的不足之处"><a href="#4-Spring-Cache的不足之处" class="headerlink" title="4)  Spring-Cache的不足之处"></a>4)  Spring-Cache的不足之处</h3><p><strong>1）、读模式</strong></p>
<p>缓存穿透：查询一个null数据。解决方案：缓存空数据，可通过<code>spring.cache.redis.cache-null-values=true</code></p>
<p>缓存击穿：大量并发进来同时查询一个正好过期的数据。解决方案：加锁 ? 默认是无加锁的;</p>
<p>使用sync = true来解决击穿问题</p>
<p>缓存雪崩：大量的key同时过期。解决：加随机时间。加上过期时间</p>
<p><strong>2)、写模式：（缓存与数据库一致）</strong></p>
<p>a、读写加锁。</p>
<p>b、引入Canal,感知到MySQL的更新去更新Redis</p>
<p>c 、读多写多，直接去数据库查询就行</p>
<p><strong>3）、总结：</strong></p>
<p>常规数据（读多写少，即时性，一致性要求不高的数据，完全可以使用Spring-Cache）：</p>
<p>写模式(只要缓存的数据有过期时间就足够了)</p>
<p>特殊数据：特殊设计</p>
<h1 id="检索"><a href="#检索" class="headerlink" title="检索"></a>检索</h1><h2 id="1-检索条件分析"><a href="#1-检索条件分析" class="headerlink" title="1. 检索条件分析"></a>1. 检索条件分析</h2><ul>
<li><p>全文检索：skuTitle-》keyword</p>
</li>
<li><p>排序：saleCount（销量）、hotScore（热度分）、skuPrice（价格）</p>
</li>
<li><p>过滤：hasStock、skuPrice区间、brandId、catalog3Id、attrs</p>
</li>
<li><p>聚合：attrs</p>
</li>
</ul>
<p>完整查询参数<br><code>keyword=小米&amp;sort=saleCount_desc/asc&amp;hasStock=0/1&amp;skuPrice=400_1900&amp;brandId=1&amp;catalog3Id=1&amp;at trs=1_3G:4G:5G&amp;attrs=2_骁龙845&amp;attrs=4_高清屏</code></p>
<h2 id="2-DSL分析"><a href="#2-DSL分析" class="headerlink" title="2. DSL分析"></a>2. DSL分析</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">GET gulimall_product/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="string">&quot;华为&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;225&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;2&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;lte&quot;</span><span class="punctuation">:</span> <span class="number">7000</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                  <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                      <span class="attr">&quot;attrs.attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6&quot;</span></span><br><span class="line">                      <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                  <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;/b&gt;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;brandAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandId&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;brandNameAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandName&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      </span><br><span class="line">        <span class="attr">&quot;brandImgAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;brandImg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        </span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;catalogAgg&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;catalogId&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;catalogNameAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;catalogName&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;attrs&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;nested&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;attrIdAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrId&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;aggs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;attrNameAgg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attrs.attrName&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-检索代码编写"><a href="#3-检索代码编写" class="headerlink" title="3. 检索代码编写"></a>3. 检索代码编写</h2><h3 id="1-请求参数和返回结果"><a href="#1-请求参数和返回结果" class="headerlink" title="1) 请求参数和返回结果"></a>1) 请求参数和返回结果</h3><p>请求参数的封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchParam</span> &#123;</span><br><span class="line">    <span class="comment">//页面传递过来的全文匹配关键字</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//品牌id,可以多选</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; brandId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//三级分类id</span></span><br><span class="line">    <span class="keyword">private</span> Long catalog3Id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//排序条件：sort=price/salecount/hotscore_desc/asc</span></span><br><span class="line">    <span class="keyword">private</span> String sort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否显示有货</span></span><br><span class="line">    <span class="keyword">private</span> Integer hasStock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//价格区间查询</span></span><br><span class="line">    <span class="keyword">private</span> String skuPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按照属性进行筛选</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageNum</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//原生的所有查询条件</span></span><br><span class="line">    <span class="keyword">private</span> String _queryString;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResult</span> &#123;</span><br><span class="line">    <span class="comment">//查询到的所有商品信息</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuEsModel&gt; product;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前页码</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总记录数</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总页码</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalPages;</span><br><span class="line">	<span class="comment">//页码遍历结果集(分页)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; pageNavs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前查询到的结果，所有涉及到的品牌</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BrandVo&gt; brands;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前查询到的结果，所有涉及到的所有属性</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrVo&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前查询到的结果，所有涉及到的所有分类</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CatalogVo&gt; catalogs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//===========================以上是返回给页面的所有信息============================//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 面包屑导航数据 */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;NavVo&gt; navs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NavVo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String navName;</span><br><span class="line">        <span class="keyword">private</span> String navValue;</span><br><span class="line">        <span class="keyword">private</span> String link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BrandVo</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long brandId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String brandName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String brandImg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AttrVo</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; attrValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CatalogVo</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long catalogId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String catalogName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-主体逻辑"><a href="#2-主体逻辑" class="headerlink" title="2)  主体逻辑"></a>2)  主体逻辑</h3><p>主要逻辑在service层进行，service层将封装好的<code>SearchParam</code>组建查询条件，再将返回后的结果封装成<code>SearchResult</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@GetMapping(value = &#123;&quot;/search.html&quot;,&quot;/&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getSearchPage</span><span class="params">(SearchParam searchParam, Model model, HttpServletRequest request)</span> &#123;</span><br><span class="line">       searchParam.set_queryString(request.getQueryString());</span><br><span class="line">       SearchResult result=searchService.getSearchResult(searchParam);</span><br><span class="line">       model.addAttribute(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;search&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> SearchResult <span class="title function_">getSearchResult</span><span class="params">(SearchParam searchParam)</span> &#123;</span><br><span class="line">       SearchResult searchResult= <span class="literal">null</span>;</span><br><span class="line">       <span class="comment">//通过请求参数构建查询请求</span></span><br><span class="line">       <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> bulidSearchRequest(searchParam);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(request, GulimallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">           <span class="comment">//将es响应数据封装成结果</span></span><br><span class="line">           searchResult = bulidSearchResult(searchParam,searchResponse);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> searchResult;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-构建查询条件"><a href="#3-构建查询条件" class="headerlink" title="3)  构建查询条件"></a>3)  构建查询条件</h3><p>这一部分就是对着前面分析的DSL，将每个条件封装进请求中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SearchRequest <span class="title function_">bulidSearchRequest</span><span class="params">(SearchParam searchParam)</span> &#123;</span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        <span class="comment">//1. 构建bool query</span></span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoolQueryBuilder</span>();</span><br><span class="line">        <span class="comment">//1.1 bool must</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;</span><br><span class="line">            boolQueryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;skuTitle&quot;</span>, searchParam.getKeyword()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.2 bool filter</span></span><br><span class="line">        <span class="comment">//1.2.1 catalog</span></span><br><span class="line">        <span class="keyword">if</span> (searchParam.getCatalog3Id()!=<span class="literal">null</span>)&#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;catalogId&quot;</span>, searchParam.getCatalog3Id()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.2 brand</span></span><br><span class="line">        <span class="keyword">if</span> (searchParam.getBrandId()!=<span class="literal">null</span>&amp;&amp;searchParam.getBrandId().size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termsQuery(<span class="string">&quot;brandId&quot;</span>,searchParam.getBrandId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.3 hasStock</span></span><br><span class="line">        <span class="keyword">if</span> (searchParam.getHasStock() != <span class="literal">null</span>) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;hasStock&quot;</span>, searchParam.getHasStock() == <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.4 priceRange</span></span><br><span class="line">        <span class="type">RangeQueryBuilder</span> <span class="variable">rangeQueryBuilder</span> <span class="operator">=</span> QueryBuilders.rangeQuery(<span class="string">&quot;skuPrice&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getSkuPrice())) &#123;</span><br><span class="line">            String[] prices = searchParam.getSkuPrice().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (prices.length == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (searchParam.getSkuPrice().startsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">                    rangeQueryBuilder.lte(Integer.parseInt(prices[<span class="number">0</span>]));</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    rangeQueryBuilder.gte(Integer.parseInt(prices[<span class="number">0</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prices.length == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">//_6000会截取成[&quot;&quot;,&quot;6000&quot;]</span></span><br><span class="line">                <span class="keyword">if</span> (!prices[<span class="number">0</span>].isEmpty()) &#123;</span><br><span class="line">                    rangeQueryBuilder.gte(Integer.parseInt(prices[<span class="number">0</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">                rangeQueryBuilder.lte(Integer.parseInt(prices[<span class="number">1</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            boolQueryBuilder.filter(rangeQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.5 attrs-nested</span></span><br><span class="line">        <span class="comment">//attrs=1_5寸:8寸&amp;2_16G:8G</span></span><br><span class="line">        List&lt;String&gt; attrs = searchParam.getAttrs();</span><br><span class="line">        <span class="type">BoolQueryBuilder</span> <span class="variable">queryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BoolQueryBuilder</span>();</span><br><span class="line">        <span class="keyword">if</span> (attrs!=<span class="literal">null</span>&amp;&amp;attrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            attrs.forEach(attr-&gt;&#123;</span><br><span class="line">                String[] attrSplit = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">                queryBuilder.must(QueryBuilders.termQuery(<span class="string">&quot;attrs.attrId&quot;</span>, attrSplit[<span class="number">0</span>]));</span><br><span class="line">                String[] attrValues = attrSplit[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                queryBuilder.must(QueryBuilders.termsQuery(<span class="string">&quot;attrs.attrValue&quot;</span>, attrValues));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">NestedQueryBuilder</span> <span class="variable">nestedQueryBuilder</span> <span class="operator">=</span> QueryBuilders.nestedQuery(<span class="string">&quot;attrs&quot;</span>, queryBuilder, ScoreMode.None);</span><br><span class="line">        boolQueryBuilder.filter(nestedQueryBuilder);</span><br><span class="line">        <span class="comment">//1. bool query构建完成</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. sort  eg:sort=saleCount_desc/asc</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getSort())) &#123;</span><br><span class="line">            String[] sortSplit = searchParam.getSort().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            searchSourceBuilder.sort(sortSplit[<span class="number">0</span>], sortSplit[<span class="number">1</span>].equalsIgnoreCase(<span class="string">&quot;asc&quot;</span>) ? SortOrder.ASC : SortOrder.DESC);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 分页</span></span><br><span class="line">        searchSourceBuilder.from((searchParam.getPageNum() - <span class="number">1</span>) * EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line">        searchSourceBuilder.size(EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 高亮highlight</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;</span><br><span class="line">            <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">            highlightBuilder.field(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">            highlightBuilder.preTags(<span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">            highlightBuilder.postTags(<span class="string">&quot;&lt;/b&gt;&quot;</span>);</span><br><span class="line">            searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 聚合</span></span><br><span class="line">        <span class="comment">//5.1 按照brand聚合</span></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">brandAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;brandAgg&quot;</span>).field(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">brandNameAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;brandNameAgg&quot;</span>).field(<span class="string">&quot;brandName&quot;</span>);</span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">brandImgAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;brandImgAgg&quot;</span>).field(<span class="string">&quot;brandImg&quot;</span>);</span><br><span class="line">        brandAgg.subAggregation(brandNameAgg);</span><br><span class="line">        brandAgg.subAggregation(brandImgAgg);</span><br><span class="line">        searchSourceBuilder.aggregation(brandAgg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.2 按照catalog聚合</span></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">catalogAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;catalogAgg&quot;</span>).field(<span class="string">&quot;catalogId&quot;</span>);</span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">catalogNameAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;catalogNameAgg&quot;</span>).field(<span class="string">&quot;catalogName&quot;</span>);</span><br><span class="line">        catalogAgg.subAggregation(catalogNameAgg);</span><br><span class="line">        searchSourceBuilder.aggregation(catalogAgg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.3 按照attrs聚合</span></span><br><span class="line">        <span class="type">NestedAggregationBuilder</span> <span class="variable">nestedAggregationBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NestedAggregationBuilder</span>(<span class="string">&quot;attrs&quot;</span>, <span class="string">&quot;attrs&quot;</span>);</span><br><span class="line">        <span class="comment">//按照attrId聚合</span></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">attrIdAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;attrIdAgg&quot;</span>).field(<span class="string">&quot;attrs.attrId&quot;</span>);</span><br><span class="line">        <span class="comment">//按照attrId聚合之后再按照attrName和attrValue聚合</span></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">attrNameAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;attrNameAgg&quot;</span>).field(<span class="string">&quot;attrs.attrName&quot;</span>);</span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">attrValueAgg</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;attrValueAgg&quot;</span>).field(<span class="string">&quot;attrs.attrValue&quot;</span>);</span><br><span class="line">        attrIdAgg.subAggregation(attrNameAgg);</span><br><span class="line">        attrIdAgg.subAggregation(attrValueAgg);</span><br><span class="line"></span><br><span class="line">        nestedAggregationBuilder.subAggregation(attrIdAgg);</span><br><span class="line">        searchSourceBuilder.aggregation(nestedAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;构建的DSL语句 &#123;&#125;&quot;</span>,searchSourceBuilder.toString());</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;EsConstant.PRODUCT_INDEX&#125;, searchSourceBuilder);</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-封装响应结果"><a href="#4-封装响应结果" class="headerlink" title="4) 封装响应结果"></a>4) 封装响应结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SearchResult <span class="title function_">bulidSearchResult</span><span class="params">(SearchParam searchParam, SearchResponse searchResponse)</span> &#123;</span><br><span class="line">    <span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>();</span><br><span class="line">    <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">    <span class="comment">//1. 封装查询到的商品信息</span></span><br><span class="line">    <span class="keyword">if</span> (hits.getHits()!=<span class="literal">null</span>&amp;&amp;hits.getHits().length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        List&lt;SkuEsModel&gt; skuEsModels = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> hit.getSourceAsString();</span><br><span class="line">            <span class="type">SkuEsModel</span> <span class="variable">skuEsModel</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, SkuEsModel.class);</span><br><span class="line">            <span class="comment">//设置高亮属性</span></span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;</span><br><span class="line">                <span class="type">HighlightField</span> <span class="variable">skuTitle</span> <span class="operator">=</span> hit.getHighlightFields().get(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">highLight</span> <span class="operator">=</span> skuTitle.getFragments()[<span class="number">0</span>].string();</span><br><span class="line">                skuEsModel.setSkuTitle(highLight);</span><br><span class="line">            &#125;</span><br><span class="line">            skuEsModels.add(skuEsModel);</span><br><span class="line">        &#125;</span><br><span class="line">        result.setProduct(skuEsModels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 封装分页信息</span></span><br><span class="line">    <span class="comment">//2.1 当前页码</span></span><br><span class="line">    result.setPageNum(searchParam.getPageNum());</span><br><span class="line">    <span class="comment">//2.2 总记录数</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> hits.getTotalHits().value;</span><br><span class="line">    result.setTotal(total);</span><br><span class="line">    <span class="comment">//2.3 总页码</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">totalPages</span> <span class="operator">=</span> (<span class="type">int</span>)total % EsConstant.PRODUCT_PAGESIZE == <span class="number">0</span> ?</span><br><span class="line">            (<span class="type">int</span>)total / EsConstant.PRODUCT_PAGESIZE : (<span class="type">int</span>)total / EsConstant.PRODUCT_PAGESIZE + <span class="number">1</span>;</span><br><span class="line">    result.setTotalPages(totalPages);</span><br><span class="line">    List&lt;Integer&gt; pageNavs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= totalPages; i++) &#123;</span><br><span class="line">        pageNavs.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setPageNavs(pageNavs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 查询结果涉及到的品牌</span></span><br><span class="line">    List&lt;SearchResult.BrandVo&gt; brandVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">    <span class="comment">//ParsedLongTerms用于接收terms聚合的结果，并且可以把key转化为Long类型的数据</span></span><br><span class="line">    <span class="type">ParsedLongTerms</span> <span class="variable">brandAgg</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;brandAgg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : brandAgg.getBuckets()) &#123;</span><br><span class="line">        <span class="comment">//3.1 得到品牌id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> bucket.getKeyAsNumber().longValue();</span><br><span class="line"></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">subBrandAggs</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line">        <span class="comment">//3.2 得到品牌图片</span></span><br><span class="line">        ParsedStringTerms brandImgAgg=subBrandAggs.get(<span class="string">&quot;brandImgAgg&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">brandImg</span> <span class="operator">=</span> brandImgAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        <span class="comment">//3.3 得到品牌名字</span></span><br><span class="line">        Terms brandNameAgg=subBrandAggs.get(<span class="string">&quot;brandNameAgg&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">brandName</span> <span class="operator">=</span> brandNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        SearchResult.<span class="type">BrandVo</span> <span class="variable">brandVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.BrandVo(brandId, brandName, brandImg);</span><br><span class="line">        brandVos.add(brandVo);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setBrands(brandVos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 查询涉及到的所有分类</span></span><br><span class="line">    List&lt;SearchResult.CatalogVo&gt; catalogVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">ParsedLongTerms</span> <span class="variable">catalogAgg</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;catalogAgg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : catalogAgg.getBuckets()) &#123;</span><br><span class="line">        <span class="comment">//4.1 获取分类id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">catalogId</span> <span class="operator">=</span> bucket.getKeyAsNumber().longValue();</span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">subcatalogAggs</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line">        <span class="comment">//4.2 获取分类名</span></span><br><span class="line">        ParsedStringTerms catalogNameAgg=subcatalogAggs.get(<span class="string">&quot;catalogNameAgg&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogName</span> <span class="operator">=</span> catalogNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        SearchResult.<span class="type">CatalogVo</span> <span class="variable">catalogVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.CatalogVo(catalogId, catalogName);</span><br><span class="line">        catalogVos.add(catalogVo);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setCatalogs(catalogVos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5 查询涉及到的所有属性</span></span><br><span class="line">    List&lt;SearchResult.AttrVo&gt; attrVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//ParsedNested用于接收内置属性的聚合</span></span><br><span class="line">    ParsedNested parsedNested=aggregations.get(<span class="string">&quot;attrs&quot;</span>);</span><br><span class="line">    ParsedLongTerms attrIdAgg=parsedNested.getAggregations().get(<span class="string">&quot;attrIdAgg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : attrIdAgg.getBuckets()) &#123;</span><br><span class="line">        <span class="comment">//5.1 查询属性id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">attrId</span> <span class="operator">=</span> bucket.getKeyAsNumber().longValue();</span><br><span class="line"></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">subAttrAgg</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line">        <span class="comment">//5.2 查询属性名</span></span><br><span class="line">        ParsedStringTerms attrNameAgg=subAttrAgg.get(<span class="string">&quot;attrNameAgg&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> attrNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">        <span class="comment">//5.3 查询属性值</span></span><br><span class="line">        <span class="type">ParsedStringTerms</span> <span class="variable">attrValueAgg</span> <span class="operator">=</span> subAttrAgg.get(<span class="string">&quot;attrValueAgg&quot;</span>);</span><br><span class="line">        List&lt;String&gt; attrValues = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket attrValueAggBucket : attrValueAgg.getBuckets()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">attrValue</span> <span class="operator">=</span> attrValueAggBucket.getKeyAsString();</span><br><span class="line">            attrValues.add(attrValue);</span><br><span class="line">            List&lt;SearchResult.NavVo&gt; navVos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        SearchResult.<span class="type">AttrVo</span> <span class="variable">attrVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.AttrVo(attrId, attrName, attrValues);</span><br><span class="line">        attrVos.add(attrVo);</span><br><span class="line">    &#125;</span><br><span class="line">    result.setAttrs(attrVos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 构建面包屑导航</span></span><br><span class="line">    List&lt;String&gt; attrs = searchParam.getAttrs();</span><br><span class="line">    <span class="keyword">if</span> (attrs != <span class="literal">null</span> &amp;&amp; attrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        List&lt;SearchResult.NavVo&gt; navVos = attrs.stream().map(attr -&gt; &#123;</span><br><span class="line">            String[] split = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            SearchResult.<span class="type">NavVo</span> <span class="variable">navVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.NavVo();</span><br><span class="line">            <span class="comment">//6.1 设置属性值</span></span><br><span class="line">            navVo.setNavValue(split[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">//6.2 查询并设置属性名</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.info(Long.parseLong(split[<span class="number">0</span>]));</span><br><span class="line">                <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">AttrResponseVo</span> <span class="variable">attrResponseVo</span> <span class="operator">=</span> JSON.parseObject(JSON.toJSONString(r.get(<span class="string">&quot;attr&quot;</span>)), <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;AttrResponseVo&gt;() &#123;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    navVo.setNavName(attrResponseVo.getAttrName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;远程调用商品服务查询属性失败&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//6.3 设置面包屑跳转链接</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">queryString</span> <span class="operator">=</span> searchParam.get_queryString();</span><br><span class="line">            <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> queryString.replace(<span class="string">&quot;&amp;attrs=&quot;</span> + attr, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;attrs=&quot;</span> + attr+<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;attrs=&quot;</span> + attr, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            navVo.setLink(<span class="string">&quot;http://search.gulimall.com/search.html&quot;</span> + (replace.isEmpty()?<span class="string">&quot;&quot;</span>:<span class="string">&quot;?&quot;</span>+replace));</span><br><span class="line">            <span class="keyword">return</span> navVo;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        result.setNavs(navVos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-页面效果"><a href="#4-页面效果" class="headerlink" title="4. 页面效果"></a>4. 页面效果</h2><h3 id="1-基本数据渲染"><a href="#1-基本数据渲染" class="headerlink" title="1)  基本数据渲染"></a>1)  基本数据渲染</h3><p>将商品的基本属性渲染出来</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;rig_tab&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 遍历各个商品--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:each</span>=<span class="string">&quot;product : $&#123;result.getProduct()&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ico&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;iconfont icon-weiguanzhu&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span>&gt;</span>关注<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;da&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;|http://item.gulimall.com/$&#123;product.skuId&#125;.html|&quot;</span> &gt;</span></span><br><span class="line">                <span class="comment">&lt;!--图片 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span>   <span class="attr">class</span>=<span class="string">&quot;dim&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;product.skuImg&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;tab_im&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span> <span class="attr">title</span>=<span class="string">&quot;黑色&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;product.skuImg&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_R&quot;</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 价格 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;&#x27;￥&#x27; + $&#123;product.skuPrice&#125;&quot;</span>&gt;</span>¥5199.00<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_JE&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 标题 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 使用utext标签,使检索时高亮不会被转义--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;product.skuTitle&#125;&quot;</span>&gt;</span></span><br><span class="line">                Apple iPhone 7 Plus (A1661) 32G 黑色 移动联通电信4G手机</span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_PI&quot;</span>&gt;</span>已有<span class="tag">&lt;<span class="name">span</span>&gt;</span>11万+<span class="tag">&lt;/<span class="name">span</span>&gt;</span>热门评价</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span>&gt;</span>二手有售<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;tab_CP&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/static/search/#&quot;</span> <span class="attr">title</span>=<span class="string">&quot;谷粒商城Apple产品专营店&quot;</span>&gt;</span>谷粒商城Apple产品...<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">title</span>=<span class="string">&quot;联系供应商进行咨询&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/search/img/xcxc.png&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tab_FO&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;FO_one&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>自营</span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>谷粒商城自营,品质保证<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>满赠</span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>该商品参加满赠活动<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-筛选条件渲染"><a href="#2-筛选条件渲染" class="headerlink" title="2) 筛选条件渲染"></a>2) 筛选条件渲染</h3><p>将结果的品牌、分类、商品属性进行遍历显示，并且点击某个属性值时可以通过拼接url进行跳转</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;JD_nav_logo&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--品牌--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;JD_nav_wrap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_key&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>品牌：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_value_logo&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;brand: $&#123;result.getBrands()&#125;&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--替换url--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>  <span class="attr">th:href</span>=<span class="string">&quot;$&#123;&#x27;javascript:searchProducts(<span class="symbol">&amp;quot;</span>brandId<span class="symbol">&amp;quot;</span>,&#x27;+brand.brandId+&#x27;)&#x27;&#125;&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/search/img/598033b4nd6055897.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;brand.brandImg&#125;&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;brand.brandName&#125;&quot;</span>&gt;</span></span><br><span class="line">                                华为(HUAWEI)</span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_ext&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><br><span class="line">                更多</span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">&#x27;background: url(&quot;image/search.ele.png&quot;)no-repeat 3px 7px&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">b</span> <span class="attr">style</span>=<span class="string">&#x27;background: url(&quot;image/search.ele.png&quot;)no-repeat 3px -44px&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><br><span class="line">                多选</span><br><span class="line">                <span class="tag">&lt;<span class="name">i</span>&gt;</span>+<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>+<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--分类--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;JD_pre&quot;</span> <span class="attr">th:each</span>=<span class="string">&quot;catalog: $&#123;result.getCatalogs()&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_key&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>分类：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;catalog.getCatalogName()&#125;&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;$&#123;&#x27;javascript:searchProducts(<span class="symbol">&amp;quot;</span>catalogId<span class="symbol">&amp;quot;</span>,&#x27;+catalog.catalogId+&#x27;)&#x27;&#125;&quot;</span>&gt;</span>0-安卓（Android）<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--价格--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;JD_pre&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_key&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>价格：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>0-499<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>500-999<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>1000-1699<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>1700-2799<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>2800-4499<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>4500-11999<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>12000以上<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;sl_value_li&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">p</span>&gt;</span>-<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--商品属性--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;JD_pre&quot;</span> <span class="attr">th:each</span>=<span class="string">&quot;attr: $&#123;result.getAttrs()&#125;&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_key&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;attr.getAttrName()&#125;&quot;</span>&gt;</span>系统：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sl_value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;val: $&#123;attr.getAttrValue()&#125;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">th:text</span>=<span class="string">&quot;$&#123;val&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">th:href</span>=<span class="string">&quot;$&#123;&#x27;javascript:searchProducts(<span class="symbol">&amp;quot;</span>attrs<span class="symbol">&amp;quot;</span>,<span class="symbol">&amp;quot;</span>&#x27;+attr.attrId+&#x27;_&#x27;+val+&#x27;<span class="symbol">&amp;quot;</span>)&#x27;&#125;&quot;</span>&gt;</span>0-安卓（Android）<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">searchProducts</span>(<span class="params">name, value</span>) &#123;</span><br><span class="line">    <span class="comment">//原來的页面</span></span><br><span class="line">    location.<span class="property">href</span> = <span class="title function_">replaceParamVal</span>(location.<span class="property">href</span>,name,value,<span class="literal">true</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 目前的url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramName 需要替换的参数属性名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replaceVal 需要替换的参数的新属性值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> forceAdd 该参数是否可以重复查询(attrs=1_3G:4G:5G&amp;attrs=2_骁龙845&amp;attrs=4_高清屏)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">string</span>&#125; 替换或添加后的url</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replaceParamVal</span>(<span class="params">url, paramName, replaceVal,forceAdd</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> oUrl = url.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">var</span> nUrl;</span><br><span class="line">    <span class="keyword">if</span> (oUrl.<span class="title function_">indexOf</span>(paramName) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>( forceAdd &amp;&amp; oUrl.<span class="title function_">indexOf</span>(paramName+<span class="string">&quot;=&quot;</span>+replaceVal)==-<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (oUrl.<span class="title function_">indexOf</span>(<span class="string">&quot;?&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                nUrl = oUrl + <span class="string">&quot;&amp;&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nUrl = oUrl + <span class="string">&quot;?&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> re = <span class="built_in">eval</span>(<span class="string">&#x27;/(&#x27;</span> + paramName + <span class="string">&#x27;=)([^&amp;]*)/gi&#x27;</span>);</span><br><span class="line">            nUrl = oUrl.<span class="title function_">replace</span>(re, paramName + <span class="string">&#x27;=&#x27;</span> + replaceVal);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (oUrl.<span class="title function_">indexOf</span>(<span class="string">&quot;?&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            nUrl = oUrl + <span class="string">&quot;&amp;&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nUrl = oUrl + <span class="string">&quot;?&quot;</span> + paramName + <span class="string">&quot;=&quot;</span> + replaceVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nUrl;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-分页数据渲染"><a href="#3-分页数据渲染" class="headerlink" title="3) 分页数据渲染"></a>3) 分页数据渲染</h3><p>将页码绑定至属性pn，当点击某页码时，通过获取pn值进行url拼接跳转页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;filter_page&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page_wrap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;page_span1&quot;</span>&gt;</span></span><br><span class="line">               <span class="comment">&lt;!-- 不是第一页时显示上一页 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;page_a&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;result.pageNum&gt;1&#125;&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;pn=$&#123;result.getPageNum()-1&#125;&quot;</span>&gt;</span></span><br><span class="line">                &lt; 上一页</span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">             <span class="comment">&lt;!-- 将各个页码遍历显示，并将当前页码绑定至属性pn --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;page_a&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">th:each</span>=<span class="string">&quot;page: $&#123;result.pageNavs&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">th:text</span>=<span class="string">&quot;$&#123;page&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">th:style</span>=<span class="string">&quot;$&#123;page==result.pageNum?&#x27;border: 0;color:#ee2222;background: #fff&#x27;:&#x27;&#x27;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">th:attr</span>=<span class="string">&quot;pn=$&#123;page&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            &gt;</span>1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 不是最后一页时显示下一页 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;page_a&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;result.pageNum&lt;result.totalPages&#125;&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;pn=$&#123;result.getPageNum()+1&#125;&quot;</span>&gt;</span></span><br><span class="line">                下一页 &gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;page_span2&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">em</span>&gt;</span>共<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;result.totalPages&#125;&quot;</span>&gt;</span>169<span class="tag">&lt;/<span class="name">b</span>&gt;</span>页<span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>到第<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;page_input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">em</span>&gt;</span>页<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;.page_a&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pn=$(<span class="variable language_">this</span>).<span class="title function_">attr</span>(<span class="string">&quot;pn&quot;</span>);</span><br><span class="line">    location.<span class="property">href</span>=<span class="title function_">replaceParamVal</span>(location.<span class="property">href</span>,<span class="string">&quot;pageNum&quot;</span>,pn,<span class="literal">false</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">replaceParamVal</span>(location.<span class="property">href</span>,<span class="string">&quot;pageNum&quot;</span>,pn,<span class="literal">false</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="4-页面排序和价格区间"><a href="#4-页面排序和价格区间" class="headerlink" title="4) 页面排序和价格区间"></a>4) 页面排序和价格区间</h3><p>页面排序功能需要保证，点击某个按钮时，样式会变红，并且其他的样式保持最初的样子；</p>
<p>点击某个排序时首先按升序显示，再次点击再变为降序，并且还会显示上升或下降箭头</p>
<p>页面排序跳转的思路是通过点击某个按钮时会向其<code>class</code>属性添加/去除<code>desc</code>，并根据属性值进行url拼接</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;filter_top&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;filter_top_left&quot;</span> <span class="attr">th:with</span>=<span class="string">&quot;p = $&#123;param.sort&#125;, priceRange = $&#123;param.skuPrice&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过判断当前class是否有desc来进行样式的渲染和箭头的显示--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">sort</span>=<span class="string">&quot;hotScore&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">th:class</span>=<span class="string">&quot;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;hotScore&#x27;) &amp;&amp; #strings.endsWith(p,&#x27;desc&#x27;)) ? &#x27;sort_a desc&#x27; : &#x27;sort_a&#x27;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">th:attr</span>=<span class="string">&quot;style=$&#123;(#strings.isEmpty(p) || #strings.startsWith(p,&#x27;hotScore&#x27;)) ?</span></span></span><br><span class="line"><span class="string"><span class="tag">               &#x27;color: #fff; border-color: #e4393c; background: #e4393c;&#x27;:&#x27;color: #333; border-color: #ccc; background: #fff;&#x27; &#125;&quot;</span>&gt;</span></span><br><span class="line">            综合排序[[$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;hotScore&#x27;) &amp;&amp;</span><br><span class="line">            #strings.endsWith(p,&#x27;desc&#x27;)) ?&#x27;↓&#x27;:&#x27;↑&#x27; &#125;]]<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">sort</span>=<span class="string">&quot;saleCount&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">th:class</span>=<span class="string">&quot;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;saleCount&#x27;) &amp;&amp; #strings.endsWith(p,&#x27;desc&#x27;)) ? &#x27;sort_a desc&#x27; : &#x27;sort_a&#x27;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">th:attr</span>=<span class="string">&quot;style=$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;saleCount&#x27;)) ?</span></span></span><br><span class="line"><span class="string"><span class="tag">               &#x27;color: #fff; border-color: #e4393c; background: #e4393c;&#x27;:&#x27;color: #333; border-color: #ccc; background: #fff;&#x27; &#125;&quot;</span>&gt;</span></span><br><span class="line">            销量[[$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;saleCount&#x27;) &amp;&amp;</span><br><span class="line">            #strings.endsWith(p,&#x27;desc&#x27;))?&#x27;↓&#x27;:&#x27;↑&#x27;  &#125;]]<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">sort</span>=<span class="string">&quot;skuPrice&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">th:class</span>=<span class="string">&quot;$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;skuPrice&#x27;) &amp;&amp; #strings.endsWith(p,&#x27;desc&#x27;)) ? &#x27;sort_a desc&#x27; : &#x27;sort_a&#x27;&#125;&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">th:attr</span>=<span class="string">&quot;style=$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;skuPrice&#x27;)) ?</span></span></span><br><span class="line"><span class="string"><span class="tag">               &#x27;color: #fff; border-color: #e4393c; background: #e4393c;&#x27;:&#x27;color: #333; border-color: #ccc; background: #fff;&#x27; &#125;&quot;</span>&gt;</span></span><br><span class="line">            价格[[$&#123;(!#strings.isEmpty(p) &amp;&amp; #strings.startsWith(p,&#x27;skuPrice&#x27;) &amp;&amp;</span><br><span class="line">            #strings.endsWith(p,&#x27;desc&#x27;))?&#x27;↓&#x27;:&#x27;↑&#x27;  &#125;]]<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">sort</span>=<span class="string">&quot;hotScore&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sort_a&quot;</span>&gt;</span>评论分<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">sort</span>=<span class="string">&quot;hotScore&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sort_a&quot;</span>&gt;</span>上架时间<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--价格区间搜索--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;skuPriceFrom&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">th:value</span>=<span class="string">&quot;$&#123;#strings.isEmpty(priceRange)?&#x27;&#x27;:#strings.substringBefore(priceRange,&#x27;_&#x27;)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">style</span>=<span class="string">&quot;width: 100px; margin-left: 30px&quot;</span>&gt;</span></span><br><span class="line">        -</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;skuPriceTo&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">th:value</span>=<span class="string">&quot;$&#123;#strings.isEmpty(priceRange)?&#x27;&#x27;:#strings.substringAfter(priceRange,&#x27;_&#x27;)&#125;&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">style</span>=<span class="string">&quot;width: 100px&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;skuPriceSearchBtn&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;filter_top_right&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;fp-text&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">b</span>&gt;</span>1<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>/<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;<span class="name">i</span>&gt;</span>169<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;prev&quot;</span>&gt;</span>&lt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;next&quot;</span>&gt;</span> &gt; <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;.sort_a&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    	<span class="comment">//添加、剔除desc</span></span><br><span class="line">        $(<span class="variable language_">this</span>).<span class="title function_">toggleClass</span>(<span class="string">&quot;desc&quot;</span>);</span><br><span class="line">    	<span class="comment">//获取sort属性值并进行url跳转</span></span><br><span class="line">        <span class="keyword">let</span> sort = $(<span class="variable language_">this</span>).<span class="title function_">attr</span>(<span class="string">&quot;sort&quot;</span>);</span><br><span class="line">        sort = $(<span class="variable language_">this</span>).<span class="title function_">hasClass</span>(<span class="string">&quot;desc&quot;</span>) ? sort + <span class="string">&quot;_desc&quot;</span> : sort + <span class="string">&quot;_asc&quot;</span>;</span><br><span class="line">        location.<span class="property">href</span> = <span class="title function_">replaceParamVal</span>(location.<span class="property">href</span>, <span class="string">&quot;sort&quot;</span>, sort,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>价格区间搜索函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;#skuPriceSearchBtn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> skuPriceFrom = $(<span class="string">&quot;#skuPriceFrom&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> skuPriceTo = $(<span class="string">&quot;#skuPriceTo&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    location.<span class="property">href</span> = <span class="title function_">replaceParamVal</span>(location.<span class="property">href</span>, <span class="string">&quot;skuPrice&quot;</span>, skuPriceFrom + <span class="string">&quot;_&quot;</span> + skuPriceTo, <span class="literal">false</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-面包屑导航"><a href="#5-面包屑导航" class="headerlink" title="5) 面包屑导航"></a>5) 面包屑导航</h3><p>在封装结果时，将查询的属性值进行封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6. 构建面包屑导航</span></span><br><span class="line">     List&lt;String&gt; attrs = searchParam.getAttrs();</span><br><span class="line">     <span class="keyword">if</span> (attrs != <span class="literal">null</span> &amp;&amp; attrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">         List&lt;SearchResult.NavVo&gt; navVos = attrs.stream().map(attr -&gt; &#123;</span><br><span class="line">             String[] split = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">             SearchResult.<span class="type">NavVo</span> <span class="variable">navVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>.NavVo();</span><br><span class="line">             <span class="comment">//6.1 设置属性值</span></span><br><span class="line">             navVo.setNavValue(split[<span class="number">1</span>]);</span><br><span class="line">             <span class="comment">//6.2 查询并设置属性名</span></span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.info(Long.parseLong(split[<span class="number">0</span>]));</span><br><span class="line">                 <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                     <span class="type">AttrResponseVo</span> <span class="variable">attrResponseVo</span> <span class="operator">=</span> JSON.parseObject(JSON.toJSONString(r.get(<span class="string">&quot;attr&quot;</span>)), <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;AttrResponseVo&gt;() &#123;</span><br><span class="line">                     &#125;);</span><br><span class="line">                     navVo.setNavName(attrResponseVo.getAttrName());</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                 log.error(<span class="string">&quot;远程调用商品服务查询属性失败&quot;</span>, e);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//6.3 设置面包屑跳转链接(当点击该链接时剔除点击属性)</span></span><br><span class="line">             <span class="type">String</span> <span class="variable">queryString</span> <span class="operator">=</span> searchParam.get_queryString();</span><br><span class="line">             <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> queryString.replace(<span class="string">&quot;&amp;attrs=&quot;</span> + attr, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;attrs=&quot;</span> + attr+<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;attrs=&quot;</span> + attr, <span class="string">&quot;&quot;</span>);</span><br><span class="line">             navVo.setLink(<span class="string">&quot;http://search.gulimall.com/search.html&quot;</span> + (replace.isEmpty()?<span class="string">&quot;&quot;</span>:<span class="string">&quot;?&quot;</span>+replace));</span><br><span class="line">             <span class="keyword">return</span> navVo;</span><br><span class="line">         &#125;).collect(Collectors.toList());</span><br><span class="line">         result.setNavs(navVos);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>页面渲染</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;JD_ipone_one c&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 遍历面包屑功能 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;$&#123;nav.link&#125;&quot;</span> <span class="attr">th:each</span>=<span class="string">&quot;nav:$&#123;result.navs&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;nav.navName&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>：<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;nav.navValue&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> x<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-条件筛选联动"><a href="#6-条件筛选联动" class="headerlink" title="6) 条件筛选联动"></a>6) 条件筛选联动</h3><p>就是将品牌和分类也封装进面包屑数据中，并且在页面进行th:if的判断，当url有该属性的查询条件时就不进行显示了</p>
<h1 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h1><h2 id="1-线程"><a href="#1-线程" class="headerlink" title="1. 线程"></a>1. 线程</h2><h3 id="1-初始化线程的4-种方式"><a href="#1-初始化线程的4-种方式" class="headerlink" title="1) 初始化线程的4 种方式"></a>1) 初始化线程的4 种方式</h3><p>1）、继承 Thread<br>2）、实现 Runnable 接口<br>3）、实现 Callable 接口 + FutureTask （可以拿到返回结果，可以处理异常）<br>4）    、线程池</p>
<p>方式 1 和方式 2：主进程无法获取线程的运算结果。不适合当前场景<br>方式 3：主进程可以获取线程的运算结果，但是不利于控制服务器中的线程资源。可以导致服务器资源耗尽。</p>
<p>方式 4：通过如下两种方式初始化线程池</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">Executors</span>.</span></span><span class="keyword">new</span><span class="constructor">FiexedThreadPool(3)</span>;</span><br></pre></td></tr></table></figure>

<p> 或者</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="constructor">ThreadPoolExecutor(<span class="params">corePoolSize</span>, <span class="params">maximumPoolSize</span>, <span class="params">keepAliveTime</span>, TimeUnit <span class="params">unit</span>, <span class="params">workQueue</span>, <span class="params">threadFactory</span>, <span class="params">handler</span>)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>通过线程池性能稳定，也可以获取执行结果，并捕获异常。但是，在业务复杂情况下，一个异步调用可能会依赖于另一个异步调用的执行结果。</strong></p>
<h3 id="2-线程池的七大参数"><a href="#2-线程池的七大参数" class="headerlink" title="2) 线程池的七大参数"></a>2) 线程池的七大参数</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650252557.png" alt="desc"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650252575.png" alt="desc"></p>
<p>运行流程：<br>1、线程池创建，准备好 core 数量的核心线程，准备接受任务</p>
<p>2、新的任务进来，用 core 准备好的空闲线程执行。</p>
<p>​    (1)core 满了，就将再进来的任务放入阻塞队列中。空闲的 core 就会自己去阻塞队列获取任务执行<br>​    (2)阻塞队列满了，就直接开新线程执行，最大只能开到 max 指定的数量<br>​    (3)max 都执行好了。Max-core 数量空闲的线程会在 keepAliveTime 指定的时间后自动销毁。最终保持到 core 大小<br>​    (4)如果线程数开到了 max 的数量，还有新任务进来，就会使用 reject 指定的拒绝策略进行处理</p>
<p>3、所有的线程创建都是由指定的 factory 创建的。</p>
<h3 id="3-常见的4-种线程池"><a href="#3-常见的4-种线程池" class="headerlink" title="3) 常见的4 种线程池"></a>3) 常见的4 种线程池</h3><ul>
<li><p>newCachedThreadPool</p>
<ul>
<li>创建一个可缓存线程池，如果线程池长度超过处理需要，可灵活回收空闲线程，若无可回收，则新建线程</li>
</ul>
</li>
<li><p>newFixedThreadPool</p>
<ul>
<li>创建一个定长线程池，可控制线程最大并发数，超出的线程会在队列中等待。</li>
</ul>
</li>
<li><p>newScheduledThreadPool</p>
<ul>
<li>创建一个定长线程池，支持定时及周期性任务执行。</li>
</ul>
</li>
<li><p>newSingleThreadExecutor</p>
<ul>
<li>创建一个单线程化的线程池，它只会用唯一的工作线程来执行任务，保证所有任务按照指定顺序(FIFO, LIFO, 优先级)执行。</li>
</ul>
</li>
</ul>
<h3 id="4-开发中为什么使用线程池"><a href="#4-开发中为什么使用线程池" class="headerlink" title="4) 开发中为什么使用线程池"></a>4) 开发中为什么使用线程池</h3><ul>
<li>降低资源的消耗<ul>
<li>通过重复利用已经创建好的线程降低线程的创建和销毁带来的损耗</li>
</ul>
</li>
<li>提高响应速度<ul>
<li>因为线程池中的线程数没有超过线程池的最大上限时，有的线程处于等待分配任务的状态，当任务来时无需创建新的线程就能执行</li>
</ul>
</li>
<li>提高线程的可管理性<ul>
<li>线程池会根据当前系统特点对池内的线程进行优化处理，减少创建和销毁线程带来的系统开销。无限的创建和销毁线程不仅消耗系统资源，还降低系统的稳定性，使用线程池进行统一分配</li>
</ul>
</li>
</ul>
<h2 id="2-CompletableFuture组合式异步编程"><a href="#2-CompletableFuture组合式异步编程" class="headerlink" title="2.CompletableFuture组合式异步编程"></a>2.CompletableFuture组合式异步编程</h2><h3 id="1-runAsync-和-supplyAsync方法"><a href="#1-runAsync-和-supplyAsync方法" class="headerlink" title="(1)  runAsync 和 supplyAsync方法"></a>(1)  runAsync 和 supplyAsync方法</h3><p>CompletableFuture 提供了四个静态方法来创建一个异步操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span></span><br></pre></td></tr></table></figure>

<p>没有指定Executor的方法会使用ForkJoinPool.commonPool() 作为它的线程池执行异步代码。如果指定线程池，则使用指定的线程池运行。以下所有的方法都类同。</p>
<ul>
<li>runAsync方法不支持返回值。</li>
<li>supplyAsync可以支持返回值。</li>
</ul>
<h3 id="2-计算结果完成时的回调方法"><a href="#2-计算结果完成时的回调方法" class="headerlink" title="(2) 计算结果完成时的回调方法"></a>(2) 计算结果完成时的回调方法</h3><p>当CompletableFuture的计算结果完成，或者抛出异常的时候，可以执行特定的Action。主要是下面的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以处理异常，无返回值</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenComplete</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> Throwable&gt; action)</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenCompleteAsync</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> Throwable&gt; action)</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenCompleteAsync</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> Throwable&gt; action, Executor executor)</span></span><br><span class="line"><span class="comment">//可以处理异常，有返回值</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">exceptionally</span><span class="params">(Function&lt;Throwable,? extends T&gt; fn)</span></span><br></pre></td></tr></table></figure>

<p>可以看到Action的类型是BiConsumer&lt;? super T,? super Throwable&gt;它可以处理正常的计算结果，或者异常情况。</p>
<p>whenComplete 可以处理正常和异常的计算结果，exceptionally 处理异常情况。 whenComplete 和 whenCompleteAsync 的区别：</p>
<ul>
<li>whenComplete：是执行当前任务的线程执行继续执whenComplete 的任务。 </li>
<li>whenCompleteAsync：是执行把 whenCompleteAsync 这个任务继续提交给线程池来进行执行。</li>
</ul>
<p>方法不以 Async 结尾，意味着 Action 使用相同的线程执行，而 Async 可能会使用其他线程执行（如果是使用相同的线程池，也可能会被同一个线程选中执行）</p>
<h3 id="3-handle-方法"><a href="#3-handle-方法" class="headerlink" title="(3) handle 方法"></a>(3) handle 方法</h3><p>handle 是执行任务完成时对结果的处理。<br> handle 方法和 thenApply 方法处理方式基本一样。不同的是 handle 是在任务完成后再执行，还可以处理异常的任务。thenApply 只可以执行正常的任务，任务出现异常则不执行 thenApply 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">handle</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">handleAsync</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">handleAsync</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn,Execut</span></span><br></pre></td></tr></table></figure>

<p>和 complete 一样，可对结果做最后的处理（可处理异常），可改变返回值。</p>
<h3 id="4-线程串行化"><a href="#4-线程串行化" class="headerlink" title="(4)  线程串行化"></a>(4)  线程串行化</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650274901.png" alt="desc"></p>
<p>thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前任务的返回值。</p>
<p>thenAccept 方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。 </p>
<p>thenRun 方法：只要上面的任务执行完成，就开始执行 thenRun，只是处理完任务后，执行thenRun 的后续操作</p>
<p>带有 Async 默认是异步执行的。同之前。</p>
<p>以上都要前置任务成功完成。<br>Function&lt;? super T,? extends U&gt;</p>
<ul>
<li>T：上一个任务返回结果的类型</li>
<li>U：当前任务的返回值类型</li>
</ul>
<ul>
<li>thenRun：不能获取上一步的执行结果</li>
<li>thenAcceptAsync：能接受上一步结果，但是无返回值</li>
<li>thenApplyAsync：能接受上一步结果，有返回值</li>
</ul>
<h3 id="5-两任务组合-都要完成"><a href="#5-两任务组合-都要完成" class="headerlink" title="(5) 两任务组合 - 都要完成"></a>(5) 两任务组合 - 都要完成</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276475.png" alt="desc"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276490.png" alt="desc"></p>
<p>两个任务必须都完成，触发该任务。</p>
<p>thenCombine：组合两个 future，获取两个 future 的返回结果，并返回当前任务的返回值thenAcceptBoth：组合两个 future，获取两个 future 任务的返回结果，然后处理任务，没有返回值。<br>runAfterBoth：组合两个 future，不需要获取 future 的结果，只需两个 future 处理完任务后，处理该任务。</p>
<h3 id="6-两任务组合-一个完成"><a href="#6-两任务组合-一个完成" class="headerlink" title="(6) 两任务组合 - 一个完成"></a>(6) 两任务组合 - 一个完成</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276784.png" alt="desc"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276799.png" alt="desc"></p>
<p>当两个任务中，任意一个 future 任务完成的时候，执行任务。</p>
<p>applyToEither：两个任务有一个执行完成，获取它的返回值，处理任务并有新的返回值。 acceptEither：两个任务有一个执行完成，获取它的返回值，处理任务，没有新的返回值。 runAfterEither：两个任务有一个执行完成，不需要获取 future 的结果，处理任务，也没有返回值。</p>
<h3 id="7-多任务组合"><a href="#7-多任务组合" class="headerlink" title="(7) 多任务组合"></a>(7) 多任务组合</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/18/1650276868.png" alt="desc"></p>
<p>allOf：等待所有任务完成</p>
<p>anyOf：只要有一个任务完成</p>
<h1 id="商品详情"><a href="#商品详情" class="headerlink" title="商品详情"></a>商品详情</h1><h2 id="1-模型抽取"><a href="#1-模型抽取" class="headerlink" title="1. 模型抽取"></a>1. 模型抽取</h2><p>模仿京东商品详情页，如下图所示，包括sku基本信息，图片信息，销售属性，图片介绍和规格参数</p>
<p>因此建立以下vo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuItemVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、sku基本信息的获取  pms_sku_info</span></span><br><span class="line">    <span class="keyword">private</span> SkuInfoEntity info;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">hasStock</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、sku的图片信息    pms_sku_images</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuImagesEntity&gt; images;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、获取spu的销售属性组合</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuItemSaleAttrVo&gt; saleAttr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、获取spu的介绍</span></span><br><span class="line">    <span class="keyword">private</span> SpuInfoDescEntity desc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、获取spu的规格参数信息</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SpuItemAttrGroupVo&gt; groupAttrs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuItemSaleAttrVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String attrName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrValueWithSkuIdVo&gt; attrValues;</span><br><span class="line">	<span class="comment">//private String attrValue 属性值</span></span><br><span class="line">    <span class="comment">//private String skuIds 该属性值对应的skuId的集合</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpuItemAttrGroupVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//attrId,attrName,attrValue</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Attr&gt; attrs;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-封装商品属性"><a href="#2-封装商品属性" class="headerlink" title="2. 封装商品属性"></a>2. 封装商品属性</h2><h3 id="1-总体思路"><a href="#1-总体思路" class="headerlink" title="(1) 总体思路"></a>(1) 总体思路</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;skuId&#125;.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">skuItem</span><span class="params">(<span class="meta">@PathVariable(&quot;skuId&quot;)</span> Long skuId, Model model)</span> &#123;</span><br><span class="line">    SkuItemVo skuItemVo=skuInfoService.item(skuId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;item&quot;</span>, skuItemVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;item&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> 	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SkuItemVo <span class="title function_">item</span><span class="params">(Long skuId)</span> &#123;</span><br><span class="line">        <span class="type">SkuItemVo</span> <span class="variable">skuItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuItemVo</span>();</span><br><span class="line">        <span class="comment">//1、sku基本信息的获取  pms_sku_info</span></span><br><span class="line">        <span class="type">SkuInfoEntity</span> <span class="variable">skuInfoEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(skuId);</span><br><span class="line">        skuItemVo.setInfo(skuInfoEntity);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">spuId</span> <span class="operator">=</span> skuInfoEntity.getSpuId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">catalogId</span> <span class="operator">=</span> skuInfoEntity.getCatalogId();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、sku的图片信息    pms_sku_images</span></span><br><span class="line">        List&lt;SkuImagesEntity&gt; skuImagesEntities = skuImagesService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SkuImagesEntity&gt;().eq(<span class="string">&quot;sku_id&quot;</span>, skuId));</span><br><span class="line">        skuItemVo.setImages(skuImagesEntities);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、获取spu的销售属性组合-&gt; 依赖1 获取spuId</span></span><br><span class="line">        List&lt;SkuItemSaleAttrVo&gt; saleAttrVos=skuSaleAttrValueService.listSaleAttrs(spuId);</span><br><span class="line">        skuItemVo.setSaleAttr(saleAttrVos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、获取spu的介绍-&gt; 依赖1 获取spuId</span></span><br><span class="line">        <span class="type">SpuInfoDescEntity</span> <span class="variable">byId</span> <span class="operator">=</span> spuInfoDescService.getById(spuId);</span><br><span class="line">        skuItemVo.setDesc(byId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5、获取spu的规格参数信息-&gt; 依赖1 获取spuId catalogId</span></span><br><span class="line">        List&lt;SpuItemAttrGroupVo&gt; spuItemAttrGroupVos=productAttrValueService.getProductGroupAttrsBySpuId(spuId, catalogId);</span><br><span class="line">        skuItemVo.setGroupAttrs(spuItemAttrGroupVos);</span><br><span class="line">        <span class="comment">//TODO 6、秒杀商品的优惠信息</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> skuItemVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-获取spu的销售属性"><a href="#2-获取spu的销售属性" class="headerlink" title="(2) 获取spu的销售属性"></a>(2) 获取spu的销售属性</h3><p>由于我们需要获取该spu下所有sku的销售属性，因此我们需要先从<code>pms_sku_info</code>查出该<code>spuId</code>对应的<code>skuId</code>，</p>
<p>再在<code>pms_sku_sale_attr_value</code>表中查出上述<code>skuId</code>对应的属性</p>
<p>因此我们需要使用连表查询，并且通过分组将单个属性值对应的多个<code>spuId</code>组成集合，效果如下</p>
<p>==为什么要设计成这种模式呢？==</p>
<p>因为这样可以在页面显示切换属性时，快速得到对应skuId的值，比如白色对应的<code>sku_ids</code>为30,29，8+128GB对应的<code>sku_ids</code>为29,31,27，那么销售属性为<code>白色、8+128GB</code>的商品的<code>skuId</code>则为二者的交集29</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;SkuItemSaleAttrMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;io.niceseason.gulimall.product.vo.SkuItemSaleAttrVo&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;attrId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;attrName&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;attrValues&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;io.niceseason.gulimall.product.vo.AttrValueWithSkuIdVo&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;attrValue&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_value&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;skuIds&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sku_ids&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;listSaleAttrs&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SkuItemSaleAttrMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT attr_id,attr_name,attr_value,GROUP_CONCAT(info.sku_id) sku_ids FROM pms_sku_info info</span><br><span class="line">        LEFT JOIN pms_sku_sale_attr_value ssav ON info.sku_id=ssav.sku_id</span><br><span class="line">        WHERE info.spu_id=#&#123;spuId&#125;</span><br><span class="line">        GROUP BY ssav.attr_id,ssav.attr_name,ssav.attr_value</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-获取spu的规格参数信息"><a href="#3-获取spu的规格参数信息" class="headerlink" title="(3) 获取spu的规格参数信息"></a>(3) 获取spu的规格参数信息</h3><p>由于需要通过<code>spuId</code>和<code>catalogId</code>查询对应规格参数，所以我们需要通过<code>pms_attr_group表</code>获得<code>catalogId</code>和<code>attrGroupName</code></p>
<p>然后通过<code> pms_attr_attrgroup_relation</code>获取分组对应属性id</p>
<p>再到<code>   pms_product_attr_value</code>查询spuId对应的属性</p>
<p>最终sql效果,联表含有需要的所有属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductAttrValueDao</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;ProductAttrValueEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;SpuItemAttrGroupVo&gt; <span class="title function_">getProductGroupAttrsBySpuId</span><span class="params">(<span class="meta">@Param(&quot;spuId&quot;)</span> Long spuId, <span class="meta">@Param(&quot;catalogId&quot;)</span> Long catalogId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;ProductGroupAttrsMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;io.niceseason.gulimall.product.vo.SpuItemAttrGroupVo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;groupName&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_group_name&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;attrs&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;io.niceseason.gulimall.product.vo.Attr&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;attrId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;attrName&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_name&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;attrValue&quot;</span> <span class="attr">column</span>=<span class="string">&quot;attr_value&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getProductGroupAttrsBySpuId&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;ProductGroupAttrsMap&quot;</span>&gt;</span></span><br><span class="line">    SELECT ag.attr_group_name,attr.attr_id,attr.attr_name,attr.attr_value</span><br><span class="line">    FROM pms_attr_attrgroup_relation aar </span><br><span class="line">    LEFT JOIN pms_attr_group ag ON aar.attr_group_id=ag.attr_group_id</span><br><span class="line">    LEFT JOIN pms_product_attr_value attr ON aar.attr_id=attr.attr_id</span><br><span class="line">    WHERE attr.spu_id = #&#123;spuId&#125; AND ag.catelog_id = #&#123;catalogId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-使用异步编排"><a href="#3-使用异步编排" class="headerlink" title="3. 使用异步编排"></a>3. 使用异步编排</h2><p>为了使我们的任务进行的更快，我们可以让查询的各个子任务多线程执行，但是由于各个任务之间可能有相互依赖的关系，因此就涉及到了异步编排。</p>
<p>在这次查询中spu的销售属性、介绍、规格参数信息都需要<code>spuId</code>,因此依赖sku基本信息的获取,所以我们要让这些任务在1之后运行。因为我们需要1运行的结果，因此调用<code>thenAcceptAsync()</code>可以接受上一步的结果且没有返回值。</p>
<p>最后时，我们需要调用<code>get()</code>方法使得所有方法都已经执行完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SkuItemVo <span class="title function_">item</span><span class="params">(Long skuId)</span> &#123;</span><br><span class="line">    <span class="type">SkuItemVo</span> <span class="variable">skuItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuItemVo</span>();</span><br><span class="line">    CompletableFuture&lt;SkuInfoEntity&gt; infoFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//1、sku基本信息的获取  pms_sku_info</span></span><br><span class="line">        <span class="type">SkuInfoEntity</span> <span class="variable">skuInfoEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(skuId);</span><br><span class="line">        skuItemVo.setInfo(skuInfoEntity);</span><br><span class="line">        <span class="keyword">return</span> skuInfoEntity;</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、sku的图片信息    pms_sku_images</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; imageFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        List&lt;SkuImagesEntity&gt; skuImagesEntities = skuImagesService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SkuImagesEntity&gt;().eq(<span class="string">&quot;sku_id&quot;</span>, skuId));</span><br><span class="line">        skuItemVo.setImages(skuImagesEntities);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、获取spu的销售属性组合-&gt; 依赖1 获取spuId</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; saleFuture = infoFuture.thenAcceptAsync((info) -&gt; &#123;</span><br><span class="line">        List&lt;SkuItemSaleAttrVo&gt; saleAttrVos = skuSaleAttrValueService.listSaleAttrs(info.getSpuId());</span><br><span class="line">        skuItemVo.setSaleAttr(saleAttrVos);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、获取spu的介绍-&gt; 依赖1 获取spuId</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; descFuture = infoFuture.thenAcceptAsync((info) -&gt; &#123;</span><br><span class="line">        <span class="type">SpuInfoDescEntity</span> <span class="variable">byId</span> <span class="operator">=</span> spuInfoDescService.getById(info.getSpuId());</span><br><span class="line">        skuItemVo.setDesc(byId);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、获取spu的规格参数信息-&gt; 依赖1 获取spuId catalogId</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; attrFuture = infoFuture.thenAcceptAsync((info) -&gt; &#123;</span><br><span class="line">        List&lt;SpuItemAttrGroupVo&gt; spuItemAttrGroupVos=productAttrValueService.getProductGroupAttrsBySpuId(info.getSpuId(), info.getCatalogId());</span><br><span class="line">        skuItemVo.setGroupAttrs(spuItemAttrGroupVos);</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//TODO 6、秒杀商品的优惠信息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待所有任务执行完成</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        CompletableFuture.allOf(imageFuture, saleFuture, descFuture, attrFuture).get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> skuItemVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-页面的sku切换"><a href="#4-页面的sku切换" class="headerlink" title="4. 页面的sku切换"></a>4. 页面的sku切换</h2><p>通过控制class中是否包换<code>checked</code>属性来控制显示样式，因此要根据<code>skuId</code>判断</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dd</span> <span class="attr">th:each</span>=<span class="string">&quot;val : $&#123;attr.attrValues&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--当前属性值的skuIds集合中是否含有当前商品的skuId,如果有说明是选中状态，加上checked--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:attr</span>=<span class="string">&quot; class=$&#123;#lists.contains(#strings.listSplit(val.skuIds,&#x27;,&#x27;),item.info.skuId.toString())</span></span></span><br><span class="line"><span class="string"><span class="tag">                            ? &#x27;sku_attr_value checked&#x27;: &#x27;sku_attr_value&#x27;&#125;, skus=$&#123;val.skuIds&#125; &quot;</span></span></span><br><span class="line"><span class="tag">   &gt;</span></span><br><span class="line">      [[$&#123;val.attrValue&#125;]]</span><br><span class="line">   <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;.sku_attr_value&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//1、改变样式</span></span><br><span class="line">    <span class="keyword">let</span> curr = $(<span class="variable language_">this</span>).<span class="title function_">attr</span>(<span class="string">&quot;skus&quot;</span>).<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="comment">//1.1 给点击元素的兄弟节点去除checked</span></span><br><span class="line">    $(<span class="variable language_">this</span>).<span class="title function_">parent</span>().<span class="title function_">parent</span>().<span class="title function_">find</span>(<span class="string">&quot;.sku_attr_value&quot;</span>).<span class="title function_">removeClass</span>(<span class="string">&quot;checked&quot;</span>);</span><br><span class="line">    <span class="comment">//1.2 给点击元素加上checked</span></span><br><span class="line">    $(<span class="variable language_">this</span>).<span class="title function_">addClass</span>(<span class="string">&quot;checked&quot;</span>);</span><br><span class="line">    <span class="comment">//1.3 为sku_attr_value设置未选中样式，为sku_attr_value checked设置选中的样式</span></span><br><span class="line">    <span class="title function_">changeCheckedStyle</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 切换spuId</span></span><br><span class="line">    <span class="keyword">let</span> skus = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line">    <span class="comment">//2.1 将每个skuIds变成数组放入skus这个数组集合中</span></span><br><span class="line">    $(<span class="string">&quot;a[class=&#x27;sku_attr_value checked&#x27;]&quot;</span>).<span class="title function_">each</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        skus.<span class="title function_">push</span>($(<span class="variable language_">this</span>).<span class="title function_">attr</span>(<span class="string">&quot;skus&quot;</span>).<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> filterEle = skus[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; skus.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//2.2 遍历每个属性的skuIds获取交集</span></span><br><span class="line">        <span class="comment">//比如sku[0]=&#123;1,3,5&#125;,sku[1]=&#123;4,5,6&#125; 那么 $(sku[0]).filter(sku[1])=5</span></span><br><span class="line">        filterEle = $(filterEle).<span class="title function_">filter</span>(skus[i])[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.3 url 拼串</span></span><br><span class="line">    location.<span class="property">href</span> = <span class="string">&quot;http://item.gulimall.com/&quot;</span> + filterEle + <span class="string">&quot;.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">changeCheckedStyle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $(<span class="string">&quot;.sku_attr_value&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">css</span>(&#123;<span class="string">&quot;border&quot;</span>: <span class="string">&quot;solid 1px #ccc&quot;</span>&#125;);</span><br><span class="line">    $(<span class="string">&quot;a[class=&#x27;sku_attr_value checked&#x27;]&quot;</span>).<span class="title function_">parent</span>().<span class="title function_">css</span>(&#123;<span class="string">&quot;border&quot;</span>: <span class="string">&quot;solid 1px red&quot;</span>&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="认证服务"><a href="#认证服务" class="headerlink" title="认证服务"></a>认证服务</h1><h2 id="1-环境搭建-1"><a href="#1-环境搭建-1" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h2><p>创建<code>gulimall-auth-server</code>模块，导依赖，引入<code>login.html</code>和<code>reg.html</code>，并把静态资源放到nginx的static目录下</p>
<h2 id="2-注册功能"><a href="#2-注册功能" class="headerlink" title="2.  注册功能"></a>2.  注册功能</h2><h3 id="1-验证码倒计时"><a href="#1-验证码倒计时" class="headerlink" title="(1) 验证码倒计时"></a>(1) 验证码倒计时</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击发送验证码按钮触发下面函数</span></span><br><span class="line">$(<span class="string">&quot;#sendCode&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">		<span class="comment">//如果有disabled，说明最近已经点过，则什么都不做</span></span><br><span class="line">		<span class="keyword">if</span>($(<span class="variable language_">this</span>).<span class="title function_">hasClass</span>(<span class="string">&quot;disabled&quot;</span>))&#123;</span><br><span class="line"></span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//调用函数使得当前的文本进行倒计时功能</span></span><br><span class="line">			<span class="title function_">timeOutChangeStyle</span>();</span><br><span class="line">			<span class="comment">//发送验证码</span></span><br><span class="line">			<span class="keyword">var</span> phone=$(<span class="string">&quot;#phoneNum&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">			$.<span class="title function_">get</span>(<span class="string">&quot;/sms/sendCode?phone=&quot;</span>+phone,<span class="keyword">function</span> (<span class="params">data</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span> (data.<span class="property">code</span>!=<span class="number">0</span>)&#123;</span><br><span class="line">					<span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> time = <span class="number">60</span>;</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">timeOutChangeStyle</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="comment">//开启倒计时后设置标志属性disable，使得该按钮不能再次被点击</span></span><br><span class="line">		$(<span class="string">&quot;#sendCode&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;disabled&quot;</span>);</span><br><span class="line">        <span class="comment">//当时间为0时，说明倒计时完成，则重置</span></span><br><span class="line">		<span class="keyword">if</span>(time==<span class="number">0</span>)&#123;</span><br><span class="line">			$(<span class="string">&quot;#sendCode&quot;</span>).<span class="title function_">text</span>(<span class="string">&quot;点击发送验证码&quot;</span>);</span><br><span class="line">			time=<span class="number">60</span>;</span><br><span class="line">			$(<span class="string">&quot;#sendCode&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//每秒调用一次当前函数，使得time--</span></span><br><span class="line">			$(<span class="string">&quot;#sendCode&quot;</span>).<span class="title function_">text</span>(time+<span class="string">&quot;s后再次发送&quot;</span>);</span><br><span class="line">			time--;</span><br><span class="line">			<span class="built_in">setTimeout</span>(<span class="string">&quot;timeOutChangeStyle()&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-整合短信服务"><a href="#2-整合短信服务" class="headerlink" title="(2) 整合短信服务"></a>(2) 整合短信服务</h3><p>在阿里云网页购买试用的短信服务</p>
<p>在<code>gulimall-third-party</code>中编写发送短信组件,其中<code>host</code>、<code>path</code>、<code>appcode</code>可以在配置文件中使用前缀<code>spring.cloud.alicloud.sms</code>进行配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.cloud.alicloud.sms&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="keyword">private</span> String appcode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendCode</span><span class="params">(String phone,String code)</span> &#123;</span><br><span class="line"><span class="comment">//        String host = &quot;http://dingxin.market.alicloudapi.com&quot;;</span></span><br><span class="line"><span class="comment">//        String path = &quot;/dx/sendSms&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> <span class="string">&quot;POST&quot;</span>;</span><br><span class="line"><span class="comment">//        String appcode = &quot;你自己的AppCode&quot;;</span></span><br><span class="line">        Map&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="comment">//最后在header中的格式(中间是英文空格)为Authorization:APPCODE 83359fd73fe94948385f570e3c139105</span></span><br><span class="line">        headers.put(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;APPCODE &quot;</span> + appcode);</span><br><span class="line">        Map&lt;String, String&gt; querys = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        querys.put(<span class="string">&quot;mobile&quot;</span>,phone);</span><br><span class="line">        querys.put(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;code:&quot;</span>+code);</span><br><span class="line">        querys.put(<span class="string">&quot;tpl_id&quot;</span>, <span class="string">&quot;TP1711063&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; bodys = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 重要提示如下:</span></span><br><span class="line"><span class="comment">             * HttpUtils请从</span></span><br><span class="line"><span class="comment">             * https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/src/main/java/com/aliyun/api/gateway/demo/util/HttpUtils.java</span></span><br><span class="line"><span class="comment">             * 下载</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * 相应的依赖请参照</span></span><br><span class="line"><span class="comment">             * https://github.com/aliyun/api-gateway-demo-sign-java/blob/master/pom.xml</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> HttpUtils.doPost(host, path, method, headers, querys, bodys);</span><br><span class="line">            System.out.println(response.toString());</span><br><span class="line">            <span class="comment">//获取response的body</span></span><br><span class="line">            <span class="comment">//System.out.println(EntityUtils.toString(response.getEntity()));</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写controller，给别的服务提供远程调用发送验证码的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/sms&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmsSendController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SmsComponent smsComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供给别的服务进行调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone 电话号码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code 验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sendCode&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span> String phone, <span class="meta">@RequestParam(&quot;code&quot;)</span> String code)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送验证码</span></span><br><span class="line">        smsComponent.sendCode(phone,code);</span><br><span class="line">        System.out.println(phone+code);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-接口防刷"><a href="#3-接口防刷" class="headerlink" title="(3) 接口防刷"></a>(3) 接口防刷</h3><p>由于发送验证码的接口暴露，为了防止恶意攻击，我们不能随意让接口被调用。</p>
<ul>
<li>在redis中以<code>phone-code</code>将电话号码和验证码进行存储并将当前时间与code一起存储<ul>
<li>如果调用时以当前<code>phone</code>取出的v不为空且当前时间在存储时间的60s以内，说明60s内该号码已经调用过，返回错误信息</li>
<li>60s以后再次调用，需要删除之前存储的<code>phone-code</code></li>
<li>code存在一个过期时间，我们设置为10min，10min内验证该验证码有效</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/sms/sendCode&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">sendCode</span><span class="params">(<span class="meta">@RequestParam(&quot;phone&quot;)</span>String phone)</span> &#123;</span><br><span class="line">   <span class="comment">//接口防刷,在redis中缓存phone-code</span></span><br><span class="line">    ValueOperations&lt;String, String&gt; ops = redisTemplate.opsForValue();</span><br><span class="line">    <span class="type">String</span> <span class="variable">prePhone</span> <span class="operator">=</span> AuthServerConstant.SMS_CODE_CACHE_PREFIX + phone;</span><br><span class="line">    <span class="type">String</span> <span class="variable">v</span> <span class="operator">=</span> ops.get(prePhone);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(v)) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">pre</span> <span class="operator">=</span> Long.parseLong(v.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">//如果存储的时间小于60s，说明60s内发送过验证码</span></span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() - pre &lt; <span class="number">60000</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> R.error(BizCodeEnum.SMS_CODE_EXCEPTION.getCode(), BizCodeEnum.SMS_CODE_EXCEPTION.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果存在的话，删除之前的验证码</span></span><br><span class="line">    redisTemplate.delete(prePhone);</span><br><span class="line">    <span class="comment">//获取到6位数字的验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> String.valueOf((<span class="type">int</span>)((Math.random() + <span class="number">1</span>) * <span class="number">100000</span>));</span><br><span class="line">    <span class="comment">//在redis中进行存储并设置过期时间</span></span><br><span class="line">    ops.set(prePhone,code+<span class="string">&quot;_&quot;</span>+System.currentTimeMillis(),<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    thirdPartFeignService.sendCode(phone, code);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-注册接口编写"><a href="#4-注册接口编写" class="headerlink" title="(4) 注册接口编写"></a>(4) 注册接口编写</h3><p>在<code>gulimall-auth-server</code>服务中编写注册的主体逻辑</p>
<ul>
<li>若JSR303校验未通过，则通过<code>BindingResult</code>封装错误信息，并重定向至注册页面</li>
<li>若通过JSR303校验，则需要从<code>redis</code>中取值判断验证码是否正确，正确的话通过会员服务注册</li>
<li>会员服务调用成功则重定向至登录页，否则封装远程服务返回的错误信息返回至注册页面</li>
</ul>
<p>注： <code>RedirectAttributes</code>可以通过session保存信息并在重定向的时候携带过去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(<span class="meta">@Valid</span> UserRegisterVo registerVo, BindingResult result, RedirectAttributes attributes)</span> &#123;</span><br><span class="line">       <span class="comment">//1.判断校验是否通过</span></span><br><span class="line">       Map&lt;String, String&gt; errors = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       <span class="keyword">if</span> (result.hasErrors())&#123;</span><br><span class="line">           <span class="comment">//1.1 如果校验不通过，则封装校验结果</span></span><br><span class="line">           result.getFieldErrors().forEach(item-&gt;&#123;</span><br><span class="line">               errors.put(item.getField(), item.getDefaultMessage());</span><br><span class="line">               <span class="comment">//1.2 将错误信息封装到session中</span></span><br><span class="line">               attributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">           &#125;);</span><br><span class="line">           <span class="comment">//1.2 重定向到注册页</span></span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//2.若JSR303校验通过</span></span><br><span class="line">           <span class="comment">//判断验证码是否正确</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> redisTemplate.opsForValue().get(AuthServerConstant.SMS_CODE_CACHE_PREFIX + registerVo.getPhone());</span><br><span class="line">           <span class="comment">//2.1 如果对应手机的验证码不为空且与提交上的相等-》验证码正确</span></span><br><span class="line">           <span class="keyword">if</span> (!StringUtils.isEmpty(code) &amp;&amp; registerVo.getCode().equals(code.split(<span class="string">&quot;_&quot;</span>)[<span class="number">0</span>])) &#123;</span><br><span class="line">               <span class="comment">//2.1.1 使得验证后的验证码失效</span></span><br><span class="line">               redisTemplate.delete(AuthServerConstant.SMS_CODE_CACHE_PREFIX + registerVo.getPhone());</span><br><span class="line"></span><br><span class="line">               <span class="comment">//2.1.2 远程调用会员服务注册</span></span><br><span class="line">               <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> memberFeignService.register(registerVo);</span><br><span class="line">               <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">//调用成功，重定向登录页</span></span><br><span class="line">                   <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">               &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//调用失败，返回注册页并显示错误信息</span></span><br><span class="line">                   <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">                   errors.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">                   attributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">                   <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//2.2 验证码错误</span></span><br><span class="line">               errors.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">               attributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/reg.html&quot;</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>gulimall-member</code>会员服务注册逻辑</p>
<ul>
<li>通过异常机制判断当前注册会员名和电话号码是否已经注册，如果已经注册，则抛出对应的自定义异常，并在返回时封装对应的错误信息</li>
<li>如果没有注册，则封装传递过来的会员信息，并设置默认的会员等级、创建时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/register&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> R <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> MemberRegisterVo registerVo)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           memberService.register(registerVo);</span><br><span class="line">           <span class="comment">//异常机制：通过捕获对应的自定义异常判断出现何种错误并封装错误信息</span></span><br><span class="line">       &#125; <span class="keyword">catch</span> (UserExistException userException) &#123;</span><br><span class="line">           <span class="keyword">return</span> R.error(BizCodeEnum.USER_EXIST_EXCEPTION.getCode(), BizCodeEnum.USER_EXIST_EXCEPTION.getMsg());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PhoneNumExistException phoneException) &#123;</span><br><span class="line">           <span class="keyword">return</span> R.error(BizCodeEnum.PHONE_EXIST_EXCEPTION.getCode(), BizCodeEnum.PHONE_EXIST_EXCEPTION.getMsg());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> R.ok();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(MemberRegisterVo registerVo)</span> &#123;</span><br><span class="line">    <span class="comment">//1 检查电话号是否唯一</span></span><br><span class="line">    checkPhoneUnique(registerVo.getPhone());</span><br><span class="line">    <span class="comment">//2 检查用户名是否唯一</span></span><br><span class="line">    checkUserNameUnique(registerVo.getUserName());</span><br><span class="line">    <span class="comment">//3 该用户信息唯一，进行插入</span></span><br><span class="line">    <span class="type">MemberEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberEntity</span>();</span><br><span class="line">    <span class="comment">//3.1 保存基本信息</span></span><br><span class="line">    entity.setUsername(registerVo.getUserName());</span><br><span class="line">    entity.setMobile(registerVo.getPhone());</span><br><span class="line">    entity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="comment">//3.2 使用加密保存密码</span></span><br><span class="line">    <span class="type">BCryptPasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">encodePassword</span> <span class="operator">=</span> passwordEncoder.encode(registerVo.getPassword());</span><br><span class="line">    entity.setPassword(encodePassword);</span><br><span class="line">    <span class="comment">//3.3 设置会员默认等级</span></span><br><span class="line">    <span class="comment">//3.3.1 找到会员默认登记</span></span><br><span class="line">    <span class="type">MemberLevelEntity</span> <span class="variable">defaultLevel</span> <span class="operator">=</span> memberLevelService.getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;MemberLevelEntity&gt;().eq(<span class="string">&quot;default_status&quot;</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="comment">//3.3.2 设置会员等级为默认</span></span><br><span class="line">    entity.setLevelId(defaultLevel.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4 保存用户信息</span></span><br><span class="line">    <span class="built_in">this</span>.save(entity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkUserNameUnique</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> baseMapper.selectCount(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;MemberEntity&gt;().eq(<span class="string">&quot;username&quot;</span>, userName));</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UserExistException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkPhoneUnique</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> baseMapper.selectCount(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;MemberEntity&gt;().eq(<span class="string">&quot;mobile&quot;</span>, phone));</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PhoneNumExistException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-用户名密码登录"><a href="#3-用户名密码登录" class="headerlink" title="3. 用户名密码登录"></a>3. 用户名密码登录</h2><p>在<code>gulimall-auth-server</code>模块中的主体逻辑</p>
<ul>
<li>通过会员服务远程调用登录接口<ul>
<li>如果调用成功，重定向至首页</li>
<li>如果调用失败，则封装错误信息并携带错误信息重定向至登录页</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(UserLoginVo vo,RedirectAttributes attributes)</span>&#123;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> memberFeignService.login(vo);</span><br><span class="line">    <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://gulimall.com/&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; errors = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        errors.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        attributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>gulimall-member</code>模块中完成登录</p>
<ul>
<li>当数据库中含有以当前登录名为用户名或电话号且密码匹配时，验证通过，返回查询到的实体</li>
<li>否则返回null，并在controller返回<code>用户名或密码错误</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> MemberLoginVo loginVo)</span> &#123;</span><br><span class="line">    MemberEntity entity=memberService.login(loginVo);</span><br><span class="line">    <span class="keyword">if</span> (entity!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCodeEnum.LOGINACCT_PASSWORD_EXCEPTION.getCode(), BizCodeEnum.LOGINACCT_PASSWORD_EXCEPTION.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MemberEntity <span class="title function_">login</span><span class="params">(MemberLoginVo loginVo)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">loginAccount</span> <span class="operator">=</span> loginVo.getLoginAccount();</span><br><span class="line">        <span class="comment">//以用户名或电话号登录的进行查询</span></span><br><span class="line">        <span class="type">MemberEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;MemberEntity&gt;().eq(<span class="string">&quot;username&quot;</span>, loginAccount).or().eq(<span class="string">&quot;mobile&quot;</span>, loginAccount));</span><br><span class="line">        <span class="keyword">if</span> (entity!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="type">BCryptPasswordEncoder</span> <span class="variable">bCryptPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">matches</span> <span class="operator">=</span> bCryptPasswordEncoder.matches(loginVo.getPassword(), entity.getPassword());</span><br><span class="line">            <span class="keyword">if</span> (matches)&#123;</span><br><span class="line">                entity.setPassword(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> entity;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-社交登录"><a href="#4-社交登录" class="headerlink" title="4. 社交登录"></a>4. 社交登录</h2><h3 id="1-oauth2-0"><a href="#1-oauth2-0" class="headerlink" title="(1) oauth2.0"></a>(1) oauth2.0</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504286.png" alt="desc"></p>
<h3 id="2-在微博开放平台创建应用"><a href="#2-在微博开放平台创建应用" class="headerlink" title="(2) 在微博开放平台创建应用"></a>(2) 在微博开放平台创建应用</h3><h3 id="3-在登录页引导用户至授权页"><a href="#3-在登录页引导用户至授权页" class="headerlink" title="(3) 在登录页引导用户至授权页"></a>(3) 在登录页引导用户至授权页</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET</span><br><span class="line">https:<span class="regexp">//</span>api.weibo.com<span class="regexp">/oauth2/</span>authorize?client_id=YOUR_CLIENT_ID&amp;response_type=code&amp;redirect_uri=YOUR_REGISTERED_REDIRECT_URI</span><br></pre></td></tr></table></figure>

<ul>
<li><code>client_id</code>: 创建网站应用时的<code>app key</code> </li>
<li><code>YOUR_REGISTERED_REDIRECT_URI</code>: 认证完成后的跳转链接(需要和平台高级设置一致)</li>
</ul>
<p>如果用户同意授权，页面跳转至 YOUR_REGISTERED_REDIRECT_URI/?code=CODE</p>
<p>code是我们用来换取令牌的参数</p>
<h3 id="4-换取token"><a href="#4-换取token" class="headerlink" title="(4) 换取token"></a>(4) 换取token</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">https:<span class="regexp">//</span>api.weibo.com<span class="regexp">/oauth2/</span>access_token?client_id=YOUR_CLIENT_ID&amp;client_secret=YOUR_CLIENT_SECRET&amp;grant_type=authorization_code&amp;redirect_uri=YOUR_REGISTERED_REDIRECT_URI&amp;code=CODE</span><br></pre></td></tr></table></figure>

<ul>
<li><code>client_id</code>: 创建网站应用时的<code>app key</code> </li>
<li><code>client_secret</code>: 创建网站应用时的<code>app secret</code> </li>
<li><code>YOUR_REGISTERED_REDIRECT_URI</code>: 认证完成后的跳转链接(需要和平台高级设置一致)</li>
<li><code>code</code>：换取令牌的认证码</li>
</ul>
<p>返回数据如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504363.png" alt="desc"></p>
<h3 id="5-获取用户信息"><a href="#5-获取用户信息" class="headerlink" title="(5) 获取用户信息"></a>(5) 获取用户信息</h3><p><a target="_blank" rel="noopener" href="https://open.weibo.com/wiki/2/users/show">https://open.weibo.com/wiki/2/users/show</a></p>
<p>结果返回json</p>
<h3 id="6-代码编写"><a href="#6-代码编写" class="headerlink" title="(6) 代码编写"></a>(6) 代码编写</h3><p><strong>认证接口</strong></p>
<ul>
<li>通过<code>HttpUtils</code>发送请求获取<code>token</code>,并将<code>token</code>等信息交给<code>member</code>服务进行社交登录</li>
<li>若获取<code>token</code>失败或远程调用服务失败，则封装错误信息重新转回登录页</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OauthController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberFeignService memberFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oauth2.0/weibo/success&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">(String code, RedirectAttributes attributes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1. 使用code换取token，换取成功则继续2，否则重定向至登录页</span></span><br><span class="line">        Map&lt;String, String&gt; query = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        query.put(<span class="string">&quot;client_id&quot;</span>, <span class="string">&quot;2144***074&quot;</span>);</span><br><span class="line">        query.put(<span class="string">&quot;client_secret&quot;</span>, <span class="string">&quot;ff63a0d8d5*****29a19492817316ab&quot;</span>);</span><br><span class="line">        query.put(<span class="string">&quot;grant_type&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>);</span><br><span class="line">        query.put(<span class="string">&quot;redirect_uri&quot;</span>, <span class="string">&quot;http://auth.gulimall.com/oauth2.0/weibo/success&quot;</span>);</span><br><span class="line">        query.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        <span class="comment">//发送post请求换取token</span></span><br><span class="line">        <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> HttpUtils.doPost(<span class="string">&quot;https://api.weibo.com&quot;</span>, <span class="string">&quot;/oauth2/access_token&quot;</span>, <span class="string">&quot;post&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(), query, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;());</span><br><span class="line">        Map&lt;String, String&gt; errors = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">//2. 调用member远程接口进行oauth登录，登录成功则转发至首页并携带返回用户信息，否则转发至登录页</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">            <span class="type">SocialUser</span> <span class="variable">socialUser</span> <span class="operator">=</span> JSON.parseObject(json, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SocialUser&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">R</span> <span class="variable">login</span> <span class="operator">=</span> memberFeignService.login(socialUser);</span><br><span class="line">            <span class="comment">//2.1 远程调用成功，返回首页并携带用户信息</span></span><br><span class="line">            <span class="keyword">if</span> (login.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(login.get(<span class="string">&quot;memberEntity&quot;</span>));</span><br><span class="line">                <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> JSON.parseObject(jsonString, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;MemberResponseVo&gt;() &#123;</span><br><span class="line">                &#125;);</span><br><span class="line">                attributes.addFlashAttribute(<span class="string">&quot;user&quot;</span>, memberResponseVo);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:http://gulimall.com&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//2.2 否则返回登录页</span></span><br><span class="line">                errors.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录失败，请重试&quot;</span>);</span><br><span class="line">                attributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            errors.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;获得第三方授权失败，请重试&quot;</span>);</span><br><span class="line">            attributes.addFlashAttribute(<span class="string">&quot;errors&quot;</span>, errors);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:http://auth.gulimall.com/login.html&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>登录接口</strong></p>
<ul>
<li>登录包含两种流程，实际上包括了注册和登录</li>
<li>如果之前未使用该社交账号登录，则使用<code>token</code>调用开放api获取社交账号相关信息，注册并将结果返回</li>
<li>如果之前已经使用该社交账号登录，则更新<code>token</code>并将结果返回</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/oauth2/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> SocialUser socialUser)</span> &#123;</span><br><span class="line">    MemberEntity entity=memberService.login(socialUser);</span><br><span class="line">    <span class="keyword">if</span> (entity!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;memberEntity&quot;</span>,entity);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MemberEntity <span class="title function_">login</span><span class="params">(SocialUser socialUser)</span>&#123;</span><br><span class="line">        <span class="type">MemberEntity</span> <span class="variable">uid</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;MemberEntity&gt;().eq(<span class="string">&quot;uid&quot;</span>, socialUser.getUid()));</span><br><span class="line">        <span class="comment">//1 如果之前未登陆过，则查询其社交信息进行注册</span></span><br><span class="line">        <span class="keyword">if</span> (uid == <span class="literal">null</span>) &#123;</span><br><span class="line">            Map&lt;String, String&gt; query = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            query.put(<span class="string">&quot;access_token&quot;</span>,socialUser.getAccess_token());</span><br><span class="line">            query.put(<span class="string">&quot;uid&quot;</span>, socialUser.getUid());</span><br><span class="line">            <span class="comment">//调用微博api接口获取用户信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> HttpUtils.doGet(<span class="string">&quot;https://api.weibo.com&quot;</span>, <span class="string">&quot;/2/users/show.json&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), query);</span><br><span class="line">                json = EntityUtils.toString(response.getEntity());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">            <span class="comment">//获得昵称，性别，头像</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">gender</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;gender&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">profile_image_url</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;profile_image_url&quot;</span>);</span><br><span class="line">            <span class="comment">//封装用户信息并保存</span></span><br><span class="line">            uid = <span class="keyword">new</span> <span class="title class_">MemberEntity</span>();</span><br><span class="line">            <span class="type">MemberLevelEntity</span> <span class="variable">defaultLevel</span> <span class="operator">=</span> memberLevelService.getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;MemberLevelEntity&gt;().eq(<span class="string">&quot;default_status&quot;</span>, <span class="number">1</span>));</span><br><span class="line">            uid.setLevelId(defaultLevel.getId());</span><br><span class="line">            uid.setNickname(name);</span><br><span class="line">            uid.setGender(<span class="string">&quot;m&quot;</span>.equals(gender)?<span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">            uid.setHeader(profile_image_url);</span><br><span class="line">            uid.setAccessToken(socialUser.getAccess_token());</span><br><span class="line">            uid.setUid(socialUser.getUid());</span><br><span class="line">            uid.setExpiresIn(socialUser.getExpires_in());</span><br><span class="line">            <span class="built_in">this</span>.save(uid);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//2 否则更新令牌等信息并返回</span></span><br><span class="line">            uid.setAccessToken(socialUser.getAccess_token());</span><br><span class="line">            uid.setUid(socialUser.getUid());</span><br><span class="line">            uid.setExpiresIn(socialUser.getExpires_in());</span><br><span class="line">            <span class="built_in">this</span>.updateById(uid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uid;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-SpringSession"><a href="#5-SpringSession" class="headerlink" title="5. SpringSession"></a>5. SpringSession</h2><h3 id="1-session-原理"><a href="#1-session-原理" class="headerlink" title="(1) session 原理"></a>(1) session 原理</h3><p><code>jsessionid</code>相当于银行卡，存在服务器的<code>session</code>相当于存储的现金，每次通过<code>jsessionid</code>取出保存的数据</p>
<p>问题：但是正常情况下<code>session</code>不可跨域，它有自己的作用范围</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504437.png" alt="desc"></p>
<h3 id="2-分布式下session共享问题"><a href="#2-分布式下session共享问题" class="headerlink" title="(2) 分布式下session共享问题"></a>(2) 分布式下session共享问题</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504492.png" alt="desc"></p>
<h3 id="3-解决方案-1"><a href="#3-解决方案-1" class="headerlink" title="(3) 解决方案"></a>(3) 解决方案</h3><h4 id="1-session复制"><a href="#1-session复制" class="headerlink" title="1) session复制"></a>1) session复制</h4><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504522.png" alt="desc"></p>
<h4 id="2-客户端存储"><a href="#2-客户端存储" class="headerlink" title="2) 客户端存储"></a>2) 客户端存储</h4><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504547.png" alt="desc"></p>
<h4 id="3-hash一致性"><a href="#3-hash一致性" class="headerlink" title="3) hash一致性"></a>3) hash一致性</h4><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504570.png" alt="desc"></p>
<h4 id="4-统一存储"><a href="#4-统一存储" class="headerlink" title="4) 统一存储"></a>4) 统一存储</h4><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504593.png" alt="desc"></p>
<h3 id="4-SpringSession整合redis"><a href="#4-SpringSession整合redis" class="headerlink" title="(4) SpringSession整合redis"></a>(4) SpringSession整合redis</h3><p>通过<code>SpringSession</code>修改<code>session</code>的作用域</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650504634.png" alt="desc"></p>
<h4 id="1-环境搭建-2"><a href="#1-环境搭建-2" class="headerlink" title="1) 环境搭建"></a>1) 环境搭建</h4><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.10</span></span><br><span class="line">  <span class="attr">session:</span></span><br><span class="line">    <span class="attr">store-type:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>

<p>添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableRedisHttpSession</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallAuthServerApplication</span> &#123;</span><br></pre></td></tr></table></figure>

<h4 id="2-自定义配置-1"><a href="#2-自定义配置-1" class="headerlink" title="2) 自定义配置"></a>2) 自定义配置</h4><ul>
<li><p>由于默认使用jdk进行序列化，通过导入<code>RedisSerializer</code>修改为json序列化</p>
</li>
<li><p>并且通过修改<code>CookieSerializer</code>扩大<code>session</code>的作用域至<code>**.gulimall.com</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallSessionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisSerializer&lt;Object&gt; <span class="title function_">springSessionDefaultRedisSerializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CookieSerializer <span class="title function_">cookieSerializer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultCookieSerializer</span> <span class="variable">serializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultCookieSerializer</span>();</span><br><span class="line">        serializer.setCookieName(<span class="string">&quot;GULISESSIONID&quot;</span>);</span><br><span class="line">        serializer.setDomainName(<span class="string">&quot;gulimall.com&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serializer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-SpringSession核心原理-装饰者模式"><a href="#5-SpringSession核心原理-装饰者模式" class="headerlink" title="(5) SpringSession核心原理 - 装饰者模式"></a>(5) SpringSession核心原理 - 装饰者模式</h3><ul>
<li>原生的获取<code>session</code>时是通过<code>HttpServletRequest</code>获取的</li>
<li>这里对request进行包装，并且重写了包装request的<code>getSession()</code>方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">      HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">   request.setAttribute(SESSION_REPOSITORY_ATTR, <span class="built_in">this</span>.sessionRepository);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对原生的request、response进行包装</span></span><br><span class="line">   <span class="type">SessionRepositoryRequestWrapper</span> <span class="variable">wrappedRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SessionRepositoryRequestWrapper</span>(</span><br><span class="line">         request, response, <span class="built_in">this</span>.servletContext);</span><br><span class="line">   <span class="type">SessionRepositoryResponseWrapper</span> <span class="variable">wrappedResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SessionRepositoryResponseWrapper</span>(</span><br><span class="line">         wrappedRequest, response);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      filterChain.doFilter(wrappedRequest, wrappedResponse);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      wrappedRequest.commitSession();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/21/1650510939.png" alt="desc"> </p>
<h1 id="购物车"><a href="#购物车" class="headerlink" title="购物车"></a>购物车</h1><h2 id="1-数据模型分析"><a href="#1-数据模型分析" class="headerlink" title="1. 数据模型分析"></a>1. 数据模型分析</h2><h3 id="1-数据存储"><a href="#1-数据存储" class="headerlink" title="(1) 数据存储"></a>(1) 数据存储</h3><p>购物车是一个读多写多的场景，因此放入数据库并不合适，但购物车又是需要持久化，因此这里我们选用redis存储购物车数据。</p>
<h3 id="2-数据结构"><a href="#2-数据结构" class="headerlink" title="(2) 数据结构"></a>(2) 数据结构</h3><p>一个购物车是由各个购物项组成的，但是我们用<code>List</code>进行存储并不合适，因为使用<code>List</code>查找某个购物项时需要挨个遍历每个购物项，会造成大量时间损耗，为保证查找速度，我们使用<code>hash</code>进行存储</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/30/1651285444.png" alt="desc"></p>
<h3 id="3-VO编写"><a href="#3-VO编写" class="headerlink" title="(3) VO编写"></a>(3) VO编写</h3><p>购物项vo</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/30/1651310436.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartItemVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//是否选中</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">check</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//图片</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//商品套餐属性</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; skuAttrValues;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//价格</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总价</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalPrice;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前购物车项总价等于单价x数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getTotalPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(count));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotalPrice</span><span class="params">(BigDecimal totalPrice)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.totalPrice = totalPrice;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>购物车vo</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/04/30/1651310583.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购物车子项信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;CartItemVo&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer countNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品类型数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer countType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品总价</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减免价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">reduce</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.00&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CartItemVo&gt; <span class="title function_">getItems</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setItems</span><span class="params">(List&lt;CartItemVo&gt; items)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总数量=遍历每个购物项总和</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCountNum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (CartItemVo item : items) &#123;</span><br><span class="line">                count += item.getCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCountNum</span><span class="params">(Integer countNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.countNum = countNum;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//商品类型数量=遍历所有商品类型和</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCountType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (CartItemVo item : items) &#123;</span><br><span class="line">                count += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCountType</span><span class="params">(Integer countType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.countType = countType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//总价为单个购物项总价-优惠</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getTotalAmount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (CartItemVo item : items) &#123;</span><br><span class="line">                total.add(item.getTotalPrice());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        total.subtract(reduce);</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTotalAmount</span><span class="params">(BigDecimal totalAmount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.totalAmount = totalAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getReduce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reduce;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReduce</span><span class="params">(BigDecimal reduce)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.reduce = reduce;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-ThreadLocal用户身份鉴别"><a href="#2-ThreadLocal用户身份鉴别" class="headerlink" title="2. ThreadLocal用户身份鉴别"></a>2. ThreadLocal用户身份鉴别</h2><h3 id="1-用户身份鉴别方式"><a href="#1-用户身份鉴别方式" class="headerlink" title="(1) 用户身份鉴别方式"></a>(1) 用户身份鉴别方式</h3><p>参考京东，在点击购物车时，会为临时用户生成一个<code>name</code>为<code>user-key</code>的<code>cookie</code>临时标识，过期时间为一个月，如果手动清除<code>user-key</code>，那么临时购物车的购物项也被清除，所以<code>user-key</code>是用来标识和存储临时购物车数据的</p>
<h3 id="2-使用ThreadLocal进行用户身份鉴别信息传递"><a href="#2-使用ThreadLocal进行用户身份鉴别信息传递" class="headerlink" title="(2) 使用ThreadLocal进行用户身份鉴别信息传递"></a>(2) 使用ThreadLocal进行用户身份鉴别信息传递</h3><ul>
<li>在调用购物车的接口前，先通过session信息判断是否登录，并分别进行用户身份信息的封装，并把<code>user-key</code>放在cookie中</li>
<li>这个功能使用拦截器进行完成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallWebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="comment">//拦截所有请求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">CartInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;UserInfoTo&gt; threadLocal=<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> (MemberResponseVo) session.getAttribute(AuthServerConstant.LOGIN_USER);</span><br><span class="line">        <span class="type">UserInfoTo</span> <span class="variable">userInfoTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfoTo</span>();</span><br><span class="line">        <span class="comment">//1 用户已经登录，设置userId</span></span><br><span class="line">        <span class="keyword">if</span> (memberResponseVo!=<span class="literal">null</span>)&#123;</span><br><span class="line">            userInfoTo.setUserId(memberResponseVo.getId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">            <span class="comment">//2 如果cookie中已经有user-Key，则直接设置</span></span><br><span class="line">            <span class="keyword">if</span> (cookie.getName().equals(CartConstant.TEMP_USER_COOKIE_NAME)) &#123;</span><br><span class="line">                userInfoTo.setUserKey(cookie.getValue());</span><br><span class="line">                userInfoTo.setTempUser(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 如果cookie没有user-key，我们通过uuid生成user-key</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userInfoTo.getUserKey())) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">            userInfoTo.setUserKey(uuid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 将用户身份认证信息放入threadlocal进行传递</span></span><br><span class="line">        threadLocal.set(userInfoTo);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">UserInfoTo</span> <span class="variable">userInfoTo</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line">        <span class="comment">//如果cookie中没有user-key，我们为其生成</span></span><br><span class="line">        <span class="keyword">if</span> (!userInfoTo.getTempUser()) &#123;</span><br><span class="line">            <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(CartConstant.TEMP_USER_COOKIE_NAME, userInfoTo.getUserKey());</span><br><span class="line">            cookie.setDomain(<span class="string">&quot;gulimall.com&quot;</span>);</span><br><span class="line">            cookie.setMaxAge(CartConstant.TEMP_USER_COOKIE_TIMEOUT);</span><br><span class="line">            response.addCookie(cookie);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-添加商品到购物车"><a href="#3-添加商品到购物车" class="headerlink" title="3. 添加商品到购物车"></a>3. 添加商品到购物车</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加商品到购物车</span></span><br><span class="line"><span class="comment"> * RedirectAttributes.addFlashAttribute():将数据放在session中，可以在页面中取出，但是只能取一次</span></span><br><span class="line"><span class="comment"> * RedirectAttributes.addAttribute():将数据拼接在url后面，?skuId=xxx</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/addCartItem&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addCartItem</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId, <span class="meta">@RequestParam(&quot;num&quot;)</span> Integer num, RedirectAttributes attributes)</span> &#123;</span><br><span class="line">    cartService.addCartItem(skuId, num);</span><br><span class="line">    attributes.addAttribute(<span class="string">&quot;skuId&quot;</span>, skuId);</span><br><span class="line">    <span class="comment">//为了防止成功页刷新可以重复提交添加商品，我们不直接转到成功页</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/addCartItemSuccess&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/addCartItemSuccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addCartItemSuccess</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId,Model model)</span> &#123;</span><br><span class="line">        <span class="type">CartItemVo</span> <span class="variable">cartItemVo</span> <span class="operator">=</span> cartService.getCartItem(skuId);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;cartItem&quot;</span>, cartItemVo);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>若当前商品已经存在购物车，只需增添数量</li>
<li>否则需要查询商品购物项所需信息，并添加新商品至购物车</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CartItemVo <span class="title function_">addCartItem</span><span class="params">(Long skuId, Integer num)</span> &#123;</span><br><span class="line">    <span class="comment">//获取当前以当前用户标识为key的hash的操作</span></span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; ops = getCartItemOps();</span><br><span class="line">    <span class="comment">// 判断当前商品是否已经存在购物车</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cartJson</span> <span class="operator">=</span> (String) ops.get(skuId.toString());</span><br><span class="line">    <span class="comment">// 1 已经存在购物车，将数据取出并添加商品数量</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(cartJson)) &#123;</span><br><span class="line">        <span class="comment">//1.1 将json转为对象并将count+</span></span><br><span class="line">        <span class="type">CartItemVo</span> <span class="variable">cartItemVo</span> <span class="operator">=</span> JSON.parseObject(cartJson, CartItemVo.class);</span><br><span class="line">        cartItemVo.setCount(cartItemVo.getCount() + num);</span><br><span class="line">        <span class="comment">//1.2 将更新后的对象转为json并存入redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(cartItemVo);</span><br><span class="line">        ops.put(skuId.toString(), jsonString);</span><br><span class="line">        <span class="keyword">return</span> cartItemVo;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">CartItemVo</span> <span class="variable">cartItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CartItemVo</span>();</span><br><span class="line">        <span class="comment">// 2 未存在购物车，则添加新商品</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; future1 = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//2.1 远程查询sku基本信息</span></span><br><span class="line">            <span class="type">R</span> <span class="variable">info</span> <span class="operator">=</span> productFeignService.info(skuId);</span><br><span class="line">            <span class="type">SkuInfoVo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> info.getData(<span class="string">&quot;skuInfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SkuInfoVo&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            cartItemVo.setCheck(<span class="literal">true</span>);</span><br><span class="line">            cartItemVo.setCount(num);</span><br><span class="line">            cartItemVo.setImage(skuInfo.getSkuDefaultImg());</span><br><span class="line">            cartItemVo.setPrice(skuInfo.getPrice());</span><br><span class="line">            cartItemVo.setSkuId(skuId);</span><br><span class="line">            cartItemVo.setTitle(skuInfo.getSkuTitle());</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.2 远程查询sku属性组合信息</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; attrValuesAsString = productFeignService.getSkuSaleAttrValuesAsString(skuId);</span><br><span class="line">            cartItemVo.setSkuAttrValues(attrValuesAsString);</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CompletableFuture.allOf(future1, future2).get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.3 将该属性封装并存入redis,登录用户使用userId为key,否则使用user-key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSON.toJSONString(cartItemVo);</span><br><span class="line">        ops.put(skuId.toString(), toJSONString);</span><br><span class="line">        <span class="keyword">return</span> cartItemVo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-获取购物车"><a href="#4-获取购物车" class="headerlink" title="4. 获取购物车"></a>4. 获取购物车</h2><ul>
<li>若用户未登录，则直接使用<code>user-key</code>获取购物车数据</li>
<li>否则使用<code>userId</code>获取购物车数据，并将<code>user-key</code>对应临时购物车数据与用户购物车数据合并，并删除临时购物车</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/cart.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getCartList</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    CartVo cartVo=cartService.getCart();</span><br><span class="line">    model.addAttribute(<span class="string">&quot;cart&quot;</span>, cartVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cartList&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CartVo <span class="title function_">getCart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CartVo</span> <span class="variable">cartVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CartVo</span>();</span><br><span class="line">        <span class="type">UserInfoTo</span> <span class="variable">userInfoTo</span> <span class="operator">=</span> CartInterceptor.threadLocal.get();</span><br><span class="line">        <span class="comment">//1 用户未登录，直接通过user-key获取临时购物车</span></span><br><span class="line">        List&lt;CartItemVo&gt; tempCart = getCartByKey(CartConstant.CART_PREFIX + userInfoTo.getUserKey());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userInfoTo.getUserId())) &#123;</span><br><span class="line">            List&lt;CartItemVo&gt; cartItemVos = tempCart;</span><br><span class="line">            cartVo.setItems(cartItemVos);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//2 用户登录</span></span><br><span class="line">            <span class="comment">//2.1 查询userId对应的购物车</span></span><br><span class="line">            List&lt;CartItemVo&gt; userCart = getCartByKey(CartConstant.CART_PREFIX + userInfoTo.getUserId());</span><br><span class="line">            <span class="comment">//2.2 查询user-key对应的临时购物车，并和用户购物车合并</span></span><br><span class="line">            <span class="keyword">if</span> (tempCart!=<span class="literal">null</span>&amp;&amp;tempCart.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                BoundHashOperations&lt;String, Object, Object&gt; ops = redisTemplate.boundHashOps(CartConstant.CART_PREFIX + userInfoTo.getUserId());</span><br><span class="line">                <span class="keyword">for</span> (CartItemVo cartItemVo : tempCart) &#123;</span><br><span class="line">                    userCart.add(cartItemVo);</span><br><span class="line">                    <span class="comment">//2.3 在redis中更新数据</span></span><br><span class="line">                    addCartItem(cartItemVo.getSkuId(), cartItemVo.getCount());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cartVo.setItems(userCart);</span><br><span class="line">            <span class="comment">//2.4 删除临时购物车数据</span></span><br><span class="line">            redisTemplate.delete(CartConstant.CART_PREFIX + userInfoTo.getUserKey());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cartVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-选中购物车项"><a href="#5-选中购物车项" class="headerlink" title="5. 选中购物车项"></a>5. 选中购物车项</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/checkCart&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">checkCart</span><span class="params">(<span class="meta">@RequestParam(&quot;isChecked&quot;)</span> Integer isChecked,<span class="meta">@RequestParam(&quot;skuId&quot;)</span>Long skuId)</span> &#123;</span><br><span class="line">    cartService.checkCart(skuId, isChecked);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改skuId对应购物车项的选中状态</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkCart</span><span class="params">(Long skuId, Integer isChecked)</span> &#123;</span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; ops = getCartItemOps();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cartJson</span> <span class="operator">=</span> (String) ops.get(skuId.toString());</span><br><span class="line">    <span class="type">CartItemVo</span> <span class="variable">cartItemVo</span> <span class="operator">=</span> JSON.parseObject(cartJson, CartItemVo.class);</span><br><span class="line">    cartItemVo.setCheck(isChecked==<span class="number">1</span>);</span><br><span class="line">    ops.put(skuId.toString(),JSON.toJSONString(cartItemVo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-修改购物项数量"><a href="#6-修改购物项数量" class="headerlink" title="6. 修改购物项数量"></a>6. 修改购物项数量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/countItem&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">changeItemCount</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId, <span class="meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span> &#123;</span><br><span class="line">    cartService.changeItemCount(skuId, num);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeItemCount</span><span class="params">(Long skuId, Integer num)</span> &#123;</span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; ops = getCartItemOps();</span><br><span class="line">    <span class="type">String</span> <span class="variable">cartJson</span> <span class="operator">=</span> (String) ops.get(skuId.toString());</span><br><span class="line">    <span class="type">CartItemVo</span> <span class="variable">cartItemVo</span> <span class="operator">=</span> JSON.parseObject(cartJson, CartItemVo.class);</span><br><span class="line">    cartItemVo.setCount(num);</span><br><span class="line">    ops.put(skuId.toString(),JSON.toJSONString(cartItemVo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-删除购物车项"><a href="#7-删除购物车项" class="headerlink" title="7. 删除购物车项"></a>7. 删除购物车项</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/deleteItem&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deleteItem</span><span class="params">(<span class="meta">@RequestParam(&quot;skuId&quot;)</span> Long skuId)</span> &#123;</span><br><span class="line">    cartService.deleteItem(skuId);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:http://cart.gulimall.com/cart.html&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteItem</span><span class="params">(Long skuId)</span> &#123;</span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; ops = getCartItemOps();</span><br><span class="line">    ops.delete(skuId.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h1><h2 id="一、消息简介"><a href="#一、消息简介" class="headerlink" title="一、消息简介"></a>一、消息简介</h2><p><strong>消息代理规范</strong></p>
<ul>
<li>JMS（Java Message Service）JAVA消息服务<ul>
<li>基于JVM消息代理的规范。ActiveMQ、HornetMQ是JMS实现</li>
</ul>
</li>
<li>AMQP（Advanced Message Queuing Protocol）<ul>
<li>高级消息队列协议，也是一个消息代理的规范，兼容JMS</li>
<li>RabbitMQ是AMQP的实现</li>
</ul>
</li>
</ul>
<p><strong>作用</strong></p>
<p>通过消息服务中间件来提升系统异步通信、扩展解耦能力</p>
<p>当消息发送者发送消息以后，将由消息代理接管，消息代理保证消息传递到指定目的地</p>
<p><strong>应用场景</strong></p>
<ol>
<li>异步处理</li>
</ol>
<p>​    用户注册操作和消息处理并行，提高响应速度</p>
<img src="https://i.loli.net/2020/10/03/nbJN45z6D3uEs97.png" style="zoom:50%;" />

<ol start="2">
<li><p>应用解耦</p>
<p>在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦</p>
<img src="https://i.loli.net/2020/10/03/HMk4oKfBCsjm2cY.png" style="zoom:60%;" /></li>
<li><p>流量削峰</p>
<p>用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转到错误页面</p>
<p>秒杀业务根据消息队列中的请求信息，再做后续处理</p>
<p><img src="https://i.loli.net/2020/10/03/qWTQo5azcxihAVU.png"></p>
</li>
</ol>
<h2 id="二、RabbitMQ"><a href="#二、RabbitMQ" class="headerlink" title="二、RabbitMQ"></a>二、RabbitMQ</h2><p>RabbitMQ是一个由erlang开发的AMQP(Advanved Message Queue Protocol)的开源实现。</p>
<h3 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="1. 核心概念"></a>1. 核心概念</h3><ul>
<li><p><strong>Message</strong></p>
<ul>
<li>消息，消息是不具名的，它由消息头和消息体组成</li>
<li>消息头，包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等</li>
</ul>
</li>
<li><p>Publisher</p>
<ul>
<li>消息的生产者，也是一个向交换器发布消息的客户端应用程序</li>
</ul>
</li>
<li><p><strong>Exchange</strong></p>
<ul>
<li>交换器，将生产者消息路由给服务器中的队列</li>
<li>类型有direct(默认)，fanout, topic, 和headers，具有不同转发策略</li>
</ul>
</li>
<li><p><strong>Queue</strong></p>
<ul>
<li>消息队列，保存消息直到发送给消费者</li>
</ul>
</li>
<li><p><strong>Binding</strong></p>
<ul>
<li>绑定，用于消息队列和交换器之间的关联</li>
</ul>
</li>
<li><p>Connection</p>
<ul>
<li>网络连接，比如一个TCP连接</li>
</ul>
</li>
<li><p>Consumer</p>
<ul>
<li>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序</li>
</ul>
</li>
<li><p>Virtual Host</p>
<ul>
<li>虚拟主机，表示一批交换器、消息队列和相关对象。</li>
<li>vhost 是 AMQP 概念的基础，必须在连接时指定</li>
<li>RabbitMQ 默认的 vhost 是 / </li>
</ul>
</li>
<li><p>Broker</p>
<ul>
<li>消息队列服务器实体</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651373265.png" alt="desc"></p>
<h3 id="2-运行机制"><a href="#2-运行机制" class="headerlink" title="2. 运行机制"></a>2. 运行机制</h3><p><strong>消息路由</strong></p>
<p>AMQP 中增加了Exchange 和 Binding 的角色， Binding 决定交换器的消息应该发送到那个队列</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375754.png" alt="desc"></p>
<p><strong>Exchange 类型</strong></p>
<ol>
<li><p>direct</p>
<p>点对点模式，消息中的路由键（routing key）如果和 Binding 中的 binding<br>key 一致， 交换器就将消息发到对应的队列中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375792.png" alt="desc"></p>
</li>
<li><p>fanout</p>
<p>广播模式，每个发到 fanout 类型交换器的消息都会分到所有绑定的队列上去</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375806.png" alt="desc"></p>
</li>
<li><p>topic</p>
<p>将路由键和某个模式进行匹配，此时队列需要绑定到一个模式上。它将路由键和绑定键的字符串切分成单词，这些单词之间用点隔开。<br>识别通配符： # 匹配 0 个或多个单词， *匹配一个单词</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651375826.png" alt="desc"></p>
</li>
</ol>
<h2 id="三、Docker安装RabbitMQ"><a href="#三、Docker安装RabbitMQ" class="headerlink" title="三、Docker安装RabbitMQ"></a>三、Docker安装RabbitMQ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p  25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:management</span><br><span class="line"></span><br><span class="line">4369, 25672 (Erlang发现&amp;集群端口)</span><br><span class="line">5672, 5671 (AMQP端口)</span><br><span class="line">15672 (web管理后台端口)</span><br><span class="line">61613, 61614 (STOMP协议端口)</span><br><span class="line">1883, 8883 (MQTT协议端口)</span><br><span class="line">https://www.rabbitmq.com/networking.html</span><br></pre></td></tr></table></figure>



<h2 id="四、-Springboot中的RabbitMQ"><a href="#四、-Springboot中的RabbitMQ" class="headerlink" title="四、 Springboot中的RabbitMQ"></a>四、 Springboot中的RabbitMQ</h2><h3 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1. 环境准备"></a>1. 环境准备</h3><p>在docker中安装rabbitmq并运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5672为服务端口，15672为web控制台端口</span></span><br><span class="line">docker run -d -p 5672:5672 -p 15672:15672 38e57f281891</span><br></pre></td></tr></table></figure>

<p>如果要修改账号密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1、进入docker 的 RabbitMQ 容器中</span><br><span class="line">docker exec -it rabbitmq01 bash</span><br><span class="line"></span><br><span class="line">2、查看用户</span><br><span class="line">rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line">3、修改密码</span><br><span class="line">rabbitmqctl change_password userName newPassword</span><br><span class="line"></span><br><span class="line">4、如果不想要guest的账号也可以新增账号</span><br><span class="line"> rabbitmqctl add_user userName newPassword</span><br><span class="line"> </span><br><span class="line">5、看guest不爽，你还可以delete它</span><br><span class="line">rabbitmqctl delete_user guest</span><br><span class="line"></span><br><span class="line">6、最后别忘了给自己添加的账号增加超级管理员权限</span><br><span class="line">rabbitmqctl set_user_tags userName administrator</span><br></pre></td></tr></table></figure>

<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--自定义消息转化器Jackson2JsonMessageConverter所需依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定rebbitmq服务器主机</span></span><br><span class="line"><span class="attr">spring.rabbitmq.host</span>=<span class="string">192.168.138.*</span></span><br><span class="line"><span class="comment">#spring.rabbitmq.username=guest  默认值为guest</span></span><br><span class="line"><span class="comment">#spring.rabbitmq.password=guest	 默认值为guest</span></span><br></pre></td></tr></table></figure>

<h3 id="2-RabbitMQ客户端API"><a href="#2-RabbitMQ客户端API" class="headerlink" title="2. RabbitMQ客户端API"></a>2. RabbitMQ客户端API</h3><p>RabbitAutoConfiguration中有内部类RabbitTemplateConfiguration,在该类中向容器中分别导入了<strong>RabbitTemplate</strong>和<strong>AmqpAdmin</strong></p>
<p>在测试类中分别注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AmqpAdmin amqpAdmin;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>RabbitTemplate消息发送处理组件</strong></p>
<p>​    可用来发送和接收消息</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">		rabbitTemplate.convertAndSend(<span class="string">&quot;amq.direct&quot;</span>,<span class="string">&quot;ustc&quot;</span>,<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">        book.setName(<span class="string">&quot;西游记&quot;</span>);</span><br><span class="line">        book.setPrice(<span class="number">23.2f</span>);</span><br><span class="line">		<span class="comment">//Book要实现Serializable接口</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;amq.direct&quot;</span>,<span class="string">&quot;ustc&quot;</span>,book);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//接收消息</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> rabbitTemplate.receiveAndConvert(<span class="string">&quot;ustc&quot;</span>);</span><br><span class="line">        System.out.println(o.getClass());  <span class="comment">//class cn.edu.ustc.springboot.bean.Book</span></span><br><span class="line">        System.out.println(o);			<span class="comment">//Book&#123;name=&#x27;西游记&#x27;, price=23.2&#125;</span></span><br></pre></td></tr></table></figure>

<p>默认的消息转化器是SimpleMessageConverter，对于对象以jdk序列化方式存储，若要以Json方式存储对象，就要自定义消息转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AmqpConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//在容器中导入Json的消息转换器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>AmqpAdmin管理组件</strong></p>
<p>​    可用于创建和删除exchange、binding和queue</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建Direct类型的Exchange</span></span><br><span class="line">amqpAdmin.declareExchange(<span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;admin.direct&quot;</span>));</span><br><span class="line"><span class="comment">//创建Queue</span></span><br><span class="line">amqpAdmin.declareQueue(<span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;admin.test&quot;</span>));</span><br><span class="line"><span class="comment">//将创建的队列与Exchange绑定</span></span><br><span class="line">amqpAdmin.declareBinding(<span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;admin.test&quot;</span>, Binding.DestinationType.QUEUE,<span class="string">&quot;admin.direct&quot;</span>,<span class="string">&quot;admin.test&quot;</span>,<span class="literal">null</span>));</span><br></pre></td></tr></table></figure>

<p><strong>消息的监听</strong></p>
<ul>
<li><p>在回调方法上标注@RabbitListener注解，并设置其属性queues，注册监听队列，当该队列收到消息时，标注方法遍会调用</p>
</li>
<li><p>可分别使用Message和保存消息所属对象进行消息接收，若使用Object对象进行消息接收，实际上接收到的也是Message</p>
</li>
<li><p>如果知道接收的消息是何种类型的对象，可在方法参数中直接加上该类型参数，也可接收到</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive1</span><span class="params">(Book book)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息：&quot;</span>+book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive1</span><span class="params">(Object object)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息：&quot;</span>+object.getClass());</span><br><span class="line">        <span class="comment">//收到消息：class org.springframework.amqp.core.Message</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive2</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息&quot;</span>+message.getHeaders()+<span class="string">&quot;---&quot;</span>+message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive3</span><span class="params">(Message message,Book book)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3收到消息：book:&quot;</span>+book.getClass()+<span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;message:&quot;</span>+message.getClass());</span><br><span class="line">        <span class="comment">//3收到消息：book:class cn.edu.ustc.springboot.bean.Book</span></span><br><span class="line">		<span class="comment">//message: class org.springframework.amqp.core.Message</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>若消息中含有不同的对象，可以使用<code>@RabbitHandler</code>进行分别接收</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;admin.test&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive4</span><span class="params">(Book book)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4收到消息：book:&quot;</span> + book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive5</span><span class="params">(Student student)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5收到消息：student:&quot;</span> + student);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-消息的可靠投递"><a href="#3-消息的可靠投递" class="headerlink" title="3.  消息的可靠投递"></a>3.  消息的可靠投递</h3><p>为保证消息不丢失，可靠抵达，可以使用事务消息，但性能下降250倍，为此引入确认机制</p>
<ul>
<li><p><strong>publisher</strong> confirmCallback 确认模式</p>
</li>
<li><p><strong>publisher</strong> returnCallback 未投递到queue 退回模式(失败时触发回调)</p>
</li>
<li><p><strong>consumer</strong> ack(Acknowledgement)机制</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/01/1651395290.png" alt="desc"></p>
</li>
</ul>
<img src="https://i.loli.net/2020/10/03/VIEF9woJaGchQpW.png" style="zoom:38%;" />

<h4 id="1-confirmCallback"><a href="#1-confirmCallback" class="headerlink" title="(1) confirmCallback"></a>(1) confirmCallback</h4><p>spring.rabbitmq.publisher-confirms=true</p>
<ul>
<li>在创建 connectionFactory 的时候设置 PublisherConfirms(true) 选项，开启</li>
</ul>
<p>confirmcallback 。</p>
<ul>
<li>CorrelationData：用来表示当前消息唯一性。</li>
<li>消息只要被 broker 接收到就会执行 confirmCallback，如果是 cluster 模式，需要所有broker 接收到才会调用 confirmCallback。</li>
<li>被 broker 接收到只能表示 message 已经到达服务器，并不能保证消息一定会被投递 到目标 queue 里。所以需要用到接下来的 returnCallback 。</li>
</ul>
<img src="https://i.loli.net/2020/10/03/mkn8LVQUiTxphsq.png" style="zoom: 50%;" />

<p><code> CorrelationData</code>为消息的唯一标识，在发送消息时进行构建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AmqpConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span>  <span class="comment">//此类创建完成后调用此方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRabbitTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;confirm CorrelationData:&quot;</span>+correlationData+<span class="string">&quot;===&gt;ack:&quot;</span>+ack+<span class="string">&quot;====&gt;cause:&quot;</span>+cause);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//confirm CorrelationData:CorrelationData [id=e3812ddd-f9c3-4f11-9510-d130a8d8f4d6]===&gt;ack:true====&gt;cause:null</span></span><br><span class="line"><span class="comment">//confirm CorrelationData:CorrelationData [id=d9560acc-f745-4a62-87cf-b6420d58706d]===&gt;ack:true====&gt;cause:null</span></span><br><span class="line"><span class="comment">//confirm CorrelationData:CorrelationData [id=4cf4a709-62ac-4966-afb9-90ec6c62a35b]===&gt;ack:true====&gt;cause:null</span></span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-ReturnCallback"><a href="#2-ReturnCallback" class="headerlink" title="(2) ReturnCallback"></a>(2) ReturnCallback</h4><p>spring.rabbitmq.publisher-returns=true</p>
<p>spring.rabbitmq.template.mandatory=true</p>
<ul>
<li><p>confrim 模式只能保证消息到达 broker，不能保证消息准确投递到目标 queue 里。在有 些业务场景下，我们需要保证消息一定要投递到目标 queue 里，此时就需要用到return 退回模式。</p>
</li>
<li><p>这样如果未能投递到目标 queue 里将调用 returnCallback ，可以记录下详细到投递数 据，定期的巡检或者自动纠错都需要这些数据。</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启发送端抵达队列的确认</span></span><br><span class="line"><span class="attr">spring.rabbitmq.publisher-returns</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 只要抵达队列，以异步发送优先回调</span></span><br><span class="line"><span class="attr">spring.rabbitmq.template.mandatory</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.setReturnCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;return callback...message:&quot;</span>+message+<span class="string">&quot;===&gt;replycode:&quot;</span>+replyCode+<span class="string">&quot;===&gt;replyText:&quot;</span>+replyText+<span class="string">&quot;===&gt;exchange:&quot;</span>+exchange+<span class="string">&quot;===&gt;routingKey:&quot;</span>+routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return callback<span class="built_in">..</span>.message:(Body:<span class="string">&#x27;&#123;&quot;name&quot;:&quot;水浒传&quot;,&quot;price&quot;:0.0&#125;&#x27;</span> MessageProperties [headers=&#123;<span class="attribute">spring_returned_message_correlation</span>=8f5d080c-35c8-42db-ac3d-0bf7509906aa, <span class="attribute">__TypeId__</span>=cn.edu.ustc.springboot.bean.Book&#125;, <span class="attribute">contentType</span>=application/json, <span class="attribute">contentEncoding</span>=UTF-8, <span class="attribute">contentLength</span>=0, <span class="attribute">receivedDeliveryMode</span>=PERSISTENT, <span class="attribute">priority</span>=0, <span class="attribute">deliveryTag</span>=0])===&gt;replycode:<span class="attribute">312</span>===&gt;replyText:NO_ROUTE===&gt;exchange:admin.direct===&gt;routingKey:admin.test0</span><br><span class="line"></span><br><span class="line">confirm CorrelationData:CorrelationData [<span class="attribute">id</span>=8f5d080c-35c8-42db-ac3d-0bf7509906aa]===&gt;ack:<span class="attribute">true</span>====&gt;causenull</span><br><span class="line"></span><br><span class="line">return callback<span class="built_in">..</span>.message:(Body:<span class="string">&#x27;&#123;&quot;name&quot;:&quot;mhs&quot;,&quot;age&quot;:1&#125;&#x27;</span> MessageProperties [headers=&#123;<span class="attribute">spring_returned_message_correlation</span>=2961a45c-19ee-4b94-8281-03e00fbdceea, <span class="attribute">__TypeId__</span>=cn.edu.ustc.springboot.bean.Student&#125;, <span class="attribute">contentType</span>=application/json, <span class="attribute">contentEncoding</span>=UTF-8, <span class="attribute">contentLength</span>=0, <span class="attribute">receivedDeliveryMode</span>=PERSISTENT, <span class="attribute">priority</span>=0, <span class="attribute">deliveryTag</span>=0])===&gt;replycode:<span class="attribute">312</span>===&gt;replyText:NO_ROUTE===&gt;exchange:admin.direct===&gt;routingKey:admin.test11</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-ack"><a href="#3-ack" class="headerlink" title="(3) ack"></a>(3) ack</h4><p>消费者获取到消息，成功处理，可以回复Ack给Broker</p>
<ul>
<li><p>basic.ack用于肯定确认；broker将移除此消息</p>
</li>
<li><p>basic.nack用于否定确认；可以指定broker是否丢弃此消息，可以批量</p>
</li>
<li><p>basic.reject用于否定确认；同上，但不能批量</p>
</li>
</ul>
<p>默认自动ack，消息被消费者收到，就会从broker的queue中移除</p>
<p>queue无消费者，消息依然会被存储，直到消费者消费</p>
<p>消费者收到消息，默认会自动ack。但是如果无法确定此消息是否被处理完成， 或者成功处理。我们可以开启手动ack模式</p>
<ul>
<li><p>消息处理成功，ack()，接受下一个消息，此消息broker就会移除</p>
</li>
<li><p>消息处理失败，nack()/reject()，重新发送给其他人进行处理，或者容错处理后ack</p>
</li>
<li><p>消息一直没有调用ack/nack方法，broker认为此消息正在被处理，不会投递给别人，此时客户端断开，消息不会被broker移除，会投递给别人</p>
</li>
</ul>
<img src="https://i.loli.net/2020/10/03/zcLPnRNXvq2uHoE.png" style="zoom:38%;" />

<p>在默认情况下，消息如果消费到一半，服务器宕机，剩下的消息就会默认全部确认，会造成消息丢失，因此需要引入手动确认模式</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费端手动ack消息</span></span><br><span class="line"><span class="attr">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br></pre></td></tr></table></figure>

<p>只要没有明确通知服务器ack，消息就不会确认收货，可以通过<code>basicAck()</code>进行确认收货</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive4</span><span class="params">(Book book, Message message,Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;4收到消息：book:&quot;</span> + book);</span><br><span class="line">    <span class="comment">//deliveryTag在通道内按顺序自增</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">    System.out.println(deliveryTag);</span><br><span class="line">    <span class="comment">//通过deliveryTag进行确认，false表示不批量确认</span></span><br><span class="line">    channel.basicAck(deliveryTag,<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外还可以使用<code>basicNack()</code>和<code>basicReject()</code>进行拒绝收货</p>
<h1 id="订单服务"><a href="#订单服务" class="headerlink" title="订单服务"></a>订单服务</h1><h2 id="1-订单流程"><a href="#1-订单流程" class="headerlink" title="1. 订单流程"></a>1. 订单流程</h2><p>订单生成 -&gt; 支付订单 -&gt; 卖家发货 -&gt; 确认收货 -&gt; 交易成功</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651454564.png" alt="desc"></p>
<h2 id="2-订单登录拦截"><a href="#2-订单登录拦截" class="headerlink" title="2. 订单登录拦截"></a>2. 订单登录拦截</h2><p>因为订单系统必然涉及到用户信息，因此进入订单系统的请求必须是已经登录的，所以我们需要通过拦截器对未登录订单请求进行拦截</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;MemberResponseVo&gt; loginUser = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> (MemberResponseVo) session.getAttribute(AuthServerConstant.LOGIN_USER);</span><br><span class="line">        <span class="keyword">if</span> (memberResponseVo != <span class="literal">null</span>) &#123;</span><br><span class="line">            loginUser.set(memberResponseVo);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            session.setAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;请先登录&quot;</span>);</span><br><span class="line">            response.sendRedirect(<span class="string">&quot;http://auth.gulimall.com/login.html&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallWebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-订单确认页"><a href="#3-订单确认页" class="headerlink" title="3. 订单确认页"></a>3. 订单确认页</h2><h3 id="（1）模型抽取"><a href="#（1）模型抽取" class="headerlink" title="（1）模型抽取"></a>（1）模型抽取</h3><p>跳转到确认页时需要携带的数据模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConfirmVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="comment">/** 会员收获地址列表 **/</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MemberAddressVo&gt; memberAddressVos;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="comment">/** 所有选中的购物项 **/</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderItemVo&gt; items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 发票记录 **/</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="comment">/** 优惠券（会员积分） **/</span></span><br><span class="line">    <span class="keyword">private</span> Integer integration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 防止重复提交的令牌 **/</span></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String orderToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span> <span class="meta">@Setter</span></span><br><span class="line">    Map&lt;Long,Boolean&gt; stocks;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo item : items) &#123;</span><br><span class="line">                count += item.getCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 订单总额 **/</span></span><br><span class="line">    <span class="comment">//BigDecimal total;</span></span><br><span class="line">    <span class="comment">//计算订单总额</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalNum</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">        <span class="keyword">if</span> (items != <span class="literal">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OrderItemVo item : items) &#123;</span><br><span class="line">                <span class="comment">//计算当前商品的总价格</span></span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">itemPrice</span> <span class="operator">=</span> item.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getCount().toString()));</span><br><span class="line">                <span class="comment">//再计算全部商品的总价格</span></span><br><span class="line">                totalNum = totalNum.add(itemPrice);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> totalNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 应付价格 **/</span></span><br><span class="line">    <span class="comment">//BigDecimal payPrice;</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">getPayPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getTotal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）数据获取"><a href="#（2）数据获取" class="headerlink" title="（2）数据获取"></a>（2）数据获取</h3><ul>
<li>查询购物项、库存和收货地址都要调用远程服务，串行会浪费大量时间，因此我们使用<code>CompletableFuture</code>进行异步编排</li>
<li>可能由于延迟，订单提交按钮可能被点击多次，为了防止重复提交的问题，我们在返回订单确认页时，在<code>redis</code>中生成一个随机的令牌，过期时间为30min，提交的订单会携带这个令牌，我们将会在订单提交的处理页面核验此令牌</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/toTrade&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toTrade</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    <span class="type">OrderConfirmVo</span> <span class="variable">confirmVo</span> <span class="operator">=</span> orderService.confirmOrder();</span><br><span class="line">    model.addAttribute(<span class="string">&quot;confirmOrder&quot;</span>, confirmVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;confirm&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderConfirmVo <span class="title function_">confirmOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">        <span class="type">OrderConfirmVo</span> <span class="variable">confirmVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderConfirmVo</span>();</span><br><span class="line">        <span class="type">RequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">        CompletableFuture&lt;Void&gt; itemAndStockFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            RequestContextHolder.setRequestAttributes(requestAttributes);</span><br><span class="line">            <span class="comment">//1. 查出所有选中购物项</span></span><br><span class="line">            List&lt;OrderItemVo&gt; checkedItems = cartFeignService.getCheckedItems();</span><br><span class="line">            confirmVo.setItems(checkedItems);</span><br><span class="line">            <span class="keyword">return</span> checkedItems;</span><br><span class="line">        &#125;, executor).thenAcceptAsync((items) -&gt; &#123;</span><br><span class="line">            <span class="comment">//4. 库存</span></span><br><span class="line">            List&lt;Long&gt; skuIds = items.stream().map(OrderItemVo::getSkuId).collect(Collectors.toList());</span><br><span class="line">            <span class="comment">//skuId为key,是否有库存为value</span></span><br><span class="line">            Map&lt;Long, Boolean&gt; hasStockMap = wareFeignService.getSkuHasStocks(skuIds).stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, SkuHasStockVo::getHasStock));</span><br><span class="line">            confirmVo.setStocks(hasStockMap);</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 查出所有收货地址</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; addressFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            List&lt;MemberAddressVo&gt; addressByUserId = memberFeignService.getAddressByUserId(memberResponseVo.getId());</span><br><span class="line">            confirmVo.setMemberAddressVos(addressByUserId);</span><br><span class="line">        &#125;, executor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 积分</span></span><br><span class="line">        confirmVo.setIntegration(memberResponseVo.getIntegration());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 总价自动计算</span></span><br><span class="line">        <span class="comment">//6. 防重令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId(), token, <span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">        confirmVo.setOrderToken(token);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CompletableFuture.allOf(itemAndStockFuture, addressFuture).get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> confirmVo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）Feign远程调用丢失请求头问题"><a href="#（3）Feign远程调用丢失请求头问题" class="headerlink" title="（3）Feign远程调用丢失请求头问题"></a>（3）Feign远程调用丢失请求头问题</h3><p><code>feign</code>远程调用的请求头中没有含有<code>JSESSIONID</code>的<code>cookie</code>，所以也就不能得到服务端的<code>session</code>数据，cart认为没登录，获取不了用户信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489137.png" alt="desc"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489175.png" alt="desc"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Request <span class="title function_">targetRequest</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (RequestInterceptor interceptor : requestInterceptors) &#123;</span><br><span class="line">    interceptor.apply(template);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> target.apply(template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是在<code>feign</code>的调用过程中，会使用容器中的<code>RequestInterceptor</code>对<code>RequestTemplate</code>进行处理，因此我们可以通过向容器中导入定制的<code>RequestInterceptor</code>为请求加上<code>cookie</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuliFeignConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">requestInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">                <span class="comment">//1. 使用RequestContextHolder拿到老请求的请求数据</span></span><br><span class="line">                <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">                <span class="keyword">if</span> (requestAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestAttributes.getRequest();</span><br><span class="line">                    <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//2. 将老请求得到cookie信息放到feign请求上</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">                        template.header(<span class="string">&quot;Cookie&quot;</span>, cookie);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>RequestContextHolder</code>为SpingMVC中共享<code>request</code>数据的上下文，底层由<code>ThreadLocal</code>实现</li>
</ul>
<p>经过<code>RequestInterceptor</code>处理后的请求如下，已经加上了请求头的<code>Cookie</code>信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489328.png" alt="desc"></p>
<h3 id="（4）Feign异步情况丢失上下文问题"><a href="#（4）Feign异步情况丢失上下文问题" class="headerlink" title="（4）Feign异步情况丢失上下文问题"></a>（4）Feign异步情况丢失上下文问题</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489224.png" alt="desc"></p>
<ul>
<li>由于<code>RequestContextHolder</code>使用<code>ThreadLocal</code>共享数据，所以在开启异步时获取不到老请求的信息，自然也就无法共享<code>cookie</code>了</li>
</ul>
<p>在这种情况下，我们需要在开启异步的时候将老请求的<code>RequestContextHolder</code>的数据设置进去</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/02/1651489251.png" alt="desc"></p>
<h3 id="（5）运费收件信息获取"><a href="#（5）运费收件信息获取" class="headerlink" title="（5）运费收件信息获取"></a>（5）运费收件信息获取</h3><p>数据封装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FareVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MemberAddressVo address;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal fare;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在页面将选中地址的id传给请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/fare/&#123;addrId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> FareVo <span class="title function_">getFare</span><span class="params">(<span class="meta">@PathVariable(&quot;addrId&quot;)</span> Long addrId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> wareInfoService.getFare(addrId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> FareVo <span class="title function_">getFare</span><span class="params">(Long addrId)</span> &#123;</span><br><span class="line">    <span class="type">FareVo</span> <span class="variable">fareVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FareVo</span>();</span><br><span class="line">    <span class="type">R</span> <span class="variable">info</span> <span class="operator">=</span> memberFeignService.info(addrId);</span><br><span class="line">    <span class="keyword">if</span> (info.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">MemberAddressVo</span> <span class="variable">address</span> <span class="operator">=</span> info.getData(<span class="string">&quot;memberReceiveAddress&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;MemberAddressVo&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        fareVo.setAddress(address);</span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> address.getPhone();</span><br><span class="line">        <span class="comment">//取电话号的最后两位作为邮费</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fare</span> <span class="operator">=</span> phone.substring(phone.length() - <span class="number">2</span>, phone.length());</span><br><span class="line">        fareVo.setFare(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(fare));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fareVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-订单提交"><a href="#4-订单提交" class="headerlink" title="4. 订单提交"></a>4. 订单提交</h2><h3 id="（1）模型抽取-1"><a href="#（1）模型抽取-1" class="headerlink" title="（1）模型抽取"></a>（1）模型抽取</h3><p>页面提交数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSubmitVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 收获地址的id **/</span></span><br><span class="line">    <span class="keyword">private</span> Long addrId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 支付方式 **/</span></span><br><span class="line">    <span class="keyword">private</span> Integer payType;</span><br><span class="line">    <span class="comment">//无需提交要购买的商品，去购物车再获取一遍</span></span><br><span class="line">    <span class="comment">//优惠、发票</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 防重令牌 **/</span></span><br><span class="line">    <span class="keyword">private</span> String orderToken;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 应付价格 **/</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 订单备注 **/</span></span><br><span class="line">    <span class="keyword">private</span> String remarks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户相关的信息，直接去session中取出即可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功后转发至支付页面携带数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubmitOrderResponseVo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderEntity order;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 错误状态码 **/</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）提交订单"><a href="#（2）提交订单" class="headerlink" title="（2）提交订单"></a>（2）提交订单</h3><ul>
<li>提交订单成功，则携带返回数据转发至支付页面</li>
<li>提交订单失败，则携带错误信息重定向至确认页</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/submitOrder&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo, Model model, RedirectAttributes attributes)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        SubmitOrderResponseVo responseVo=orderService.submitOrder(submitVo);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> responseVo.getCode();</span><br><span class="line">        <span class="keyword">if</span> (code==<span class="number">0</span>)&#123;</span><br><span class="line">            model.addAttribute(<span class="string">&quot;order&quot;</span>, responseVo.getOrder());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;pay&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;下单失败;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    msg += <span class="string">&quot;防重令牌校验失败&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    msg += <span class="string">&quot;商品价格发生变化&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            attributes.addFlashAttribute(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> NoStockException)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;下单失败，商品无库存&quot;</span>;</span><br><span class="line">            attributes.addFlashAttribute(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:http://order.gulimall.com/toTrade&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SubmitOrderResponseVo <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line">        <span class="type">SubmitOrderResponseVo</span> <span class="variable">responseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubmitOrderResponseVo</span>();</span><br><span class="line">        responseVo.setCode(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//1. 验证防重令牌</span></span><br><span class="line">        <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">        String script= <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script,Long.class), Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId()), submitVo.getOrderToken());</span><br><span class="line">        <span class="keyword">if</span> (execute == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="comment">//1.1 防重令牌验证失败</span></span><br><span class="line">            responseVo.setCode(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> responseVo;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//2. 创建订单、订单项</span></span><br><span class="line">            <span class="type">OrderCreateTo</span> <span class="variable">order</span> <span class="operator">=</span>createOrderTo(memberResponseVo,submitVo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3. 验价</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> order.getOrder().getPayAmount();</span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">payPrice</span> <span class="operator">=</span> submitVo.getPayPrice();</span><br><span class="line">            <span class="keyword">if</span> (Math.abs(payAmount.subtract(payPrice).doubleValue()) &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">                <span class="comment">//4. 保存订单</span></span><br><span class="line">                saveOrder(order);</span><br><span class="line">                <span class="comment">//5. 锁定库存</span></span><br><span class="line">                List&lt;OrderItemVo&gt; orderItemVos = order.getOrderItems().stream().map((item) -&gt; &#123;</span><br><span class="line">                    <span class="type">OrderItemVo</span> <span class="variable">orderItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemVo</span>();</span><br><span class="line">                    orderItemVo.setSkuId(item.getSkuId());</span><br><span class="line">                    orderItemVo.setCount(item.getSkuQuantity());</span><br><span class="line">                    <span class="keyword">return</span> orderItemVo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">                <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> wareFeignService.orderLockStock(orderItemVos);</span><br><span class="line">                <span class="comment">//5.1 锁定库存成功</span></span><br><span class="line">                <span class="keyword">if</span> (r.getCode()==<span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">//                    int i = 10 / 0;</span></span><br><span class="line">                    responseVo.setOrder(order.getOrder());</span><br><span class="line">                    responseVo.setCode(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">return</span> responseVo;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//5.1 锁定库存失败</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(msg);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//验价失败</span></span><br><span class="line">                responseVo.setCode(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span> responseVo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-验证防重令牌"><a href="#1-验证防重令牌" class="headerlink" title="1) 验证防重令牌"></a>1) 验证防重令牌</h4><p>为防止在获取令牌、对比值和删除令牌之间发生错误导入令牌校验出错，我们必须使用脚本保证原子性操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">String script= <span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line"><span class="type">Long</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script,Long.class), Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX + memberResponseVo.getId()), submitVo.getOrderToken());</span><br><span class="line"><span class="keyword">if</span> (execute == <span class="number">0L</span>) &#123;</span><br><span class="line">    <span class="comment">//1.1 防重令牌验证失败</span></span><br><span class="line">    responseVo.setCode(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> responseVo;</span><br></pre></td></tr></table></figure>

<h4 id="2-创建订单、订单项"><a href="#2-创建订单、订单项" class="headerlink" title="2) 创建订单、订单项"></a>2) 创建订单、订单项</h4><p>抽取模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCreateTo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderEntity order;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderItemEntity&gt; orderItems;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 订单计算的应付价格 **/</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal payPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 运费 **/</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal fare;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建订单、订单项</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2. 创建订单、订单项</span></span><br><span class="line"><span class="type">OrderCreateTo</span> <span class="variable">order</span> <span class="operator">=</span>createOrderTo(memberResponseVo,submitVo);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OrderCreateTo <span class="title function_">createOrderTo</span><span class="params">(MemberResponseVo memberResponseVo, OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line">    <span class="comment">//2.1 用IdWorker生成订单号</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> IdWorker.getTimeId();</span><br><span class="line">    <span class="comment">//2.2 构建订单</span></span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">entity</span> <span class="operator">=</span> buildOrder(memberResponseVo, submitVo,orderSn);</span><br><span class="line">    <span class="comment">//2.3 构建订单项</span></span><br><span class="line">    List&lt;OrderItemEntity&gt; orderItemEntities = buildOrderItems(orderSn);</span><br><span class="line">    <span class="comment">//2.4 计算价格</span></span><br><span class="line">    compute(entity, orderItemEntities);</span><br><span class="line">    <span class="type">OrderCreateTo</span> <span class="variable">createTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderCreateTo</span>();</span><br><span class="line">    createTo.setOrder(entity);</span><br><span class="line">    createTo.setOrderItems(orderItemEntities);</span><br><span class="line">    <span class="keyword">return</span> createTo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构建订单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OrderEntity <span class="title function_">buildOrder</span><span class="params">(MemberResponseVo memberResponseVo, OrderSubmitVo submitVo, String orderSn)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">OrderEntity</span>();</span><br><span class="line"></span><br><span class="line">        orderEntity.setOrderSn(orderSn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1) 设置用户信息</span></span><br><span class="line">        orderEntity.setMemberId(memberResponseVo.getId());</span><br><span class="line">        orderEntity.setMemberUsername(memberResponseVo.getUsername());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2) 获取邮费和收件人信息并设置</span></span><br><span class="line">        <span class="type">FareVo</span> <span class="variable">fareVo</span> <span class="operator">=</span> wareFeignService.getFare(submitVo.getAddrId());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">fare</span> <span class="operator">=</span> fareVo.getFare();</span><br><span class="line">        orderEntity.setFreightAmount(fare);</span><br><span class="line">        <span class="type">MemberAddressVo</span> <span class="variable">address</span> <span class="operator">=</span> fareVo.getAddress();</span><br><span class="line">        orderEntity.setReceiverName(address.getName());</span><br><span class="line">        orderEntity.setReceiverPhone(address.getPhone());</span><br><span class="line">        orderEntity.setReceiverPostCode(address.getPostCode());</span><br><span class="line">        orderEntity.setReceiverProvince(address.getProvince());</span><br><span class="line">        orderEntity.setReceiverCity(address.getCity());</span><br><span class="line">        orderEntity.setReceiverRegion(address.getRegion());</span><br><span class="line">        orderEntity.setReceiverDetailAddress(address.getDetailAddress());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3) 设置订单相关的状态信息</span></span><br><span class="line">        orderEntity.setStatus(OrderStatusEnum.CREATE_NEW.getCode());</span><br><span class="line">        orderEntity.setConfirmStatus(<span class="number">0</span>);</span><br><span class="line">        orderEntity.setAutoConfirmDay(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderEntity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>构建订单项</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OrderItemEntity <span class="title function_">buildOrderItem</span><span class="params">(OrderItemVo item)</span> &#123;</span><br><span class="line">        <span class="type">OrderItemEntity</span> <span class="variable">orderItemEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemEntity</span>();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> item.getSkuId();</span><br><span class="line">        <span class="comment">//1) 设置sku相关属性</span></span><br><span class="line">        orderItemEntity.setSkuId(skuId);</span><br><span class="line">        orderItemEntity.setSkuName(item.getTitle());</span><br><span class="line">        orderItemEntity.setSkuAttrsVals(StringUtils.collectionToDelimitedString(item.getSkuAttrValues(), <span class="string">&quot;;&quot;</span>));</span><br><span class="line">        orderItemEntity.setSkuPic(item.getImage());</span><br><span class="line">        orderItemEntity.setSkuPrice(item.getPrice());</span><br><span class="line">        orderItemEntity.setSkuQuantity(item.getCount());</span><br><span class="line">        <span class="comment">//2) 通过skuId查询spu相关属性并设置</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.getSpuBySkuId(skuId);</span><br><span class="line">        <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">SpuInfoTo</span> <span class="variable">spuInfo</span> <span class="operator">=</span> r.getData(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SpuInfoTo&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            orderItemEntity.setSpuId(spuInfo.getId());</span><br><span class="line">            orderItemEntity.setSpuName(spuInfo.getSpuName());</span><br><span class="line">            orderItemEntity.setSpuBrand(spuInfo.getBrandName());</span><br><span class="line">            orderItemEntity.setCategoryId(spuInfo.getCatalogId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3) 商品的优惠信息(不做)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4) 商品的积分成长，为价格x数量</span></span><br><span class="line">        orderItemEntity.setGiftGrowth(item.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getCount())).intValue());</span><br><span class="line">        orderItemEntity.setGiftIntegration(item.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getCount())).intValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5) 订单项订单价格信息</span></span><br><span class="line">        orderItemEntity.setPromotionAmount(BigDecimal.ZERO);</span><br><span class="line">        orderItemEntity.setCouponAmount(BigDecimal.ZERO);</span><br><span class="line">        orderItemEntity.setIntegrationAmount(BigDecimal.ZERO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6) 实际价格</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">origin</span> <span class="operator">=</span> orderItemEntity.getSkuPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(orderItemEntity.getSkuQuantity()));</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">realPrice</span> <span class="operator">=</span> origin.subtract(orderItemEntity.getPromotionAmount())</span><br><span class="line">                .subtract(orderItemEntity.getCouponAmount())</span><br><span class="line">                .subtract(orderItemEntity.getIntegrationAmount());</span><br><span class="line">        orderItemEntity.setRealAmount(realPrice);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderItemEntity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>计算订单价格</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">(OrderEntity entity, List&lt;OrderItemEntity&gt; orderItemEntities)</span> &#123;</span><br><span class="line">        <span class="comment">//总价</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line">        <span class="comment">//优惠价格</span></span><br><span class="line">        BigDecimal promotion=<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.0&quot;</span>);</span><br><span class="line">        BigDecimal integration=<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.0&quot;</span>);</span><br><span class="line">        BigDecimal coupon=<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0.0&quot;</span>);</span><br><span class="line">        <span class="comment">//积分</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">integrationTotal</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">growthTotal</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (OrderItemEntity orderItemEntity : orderItemEntities) &#123;</span><br><span class="line">            total=total.add(orderItemEntity.getRealAmount());</span><br><span class="line">            promotion=promotion.add(orderItemEntity.getPromotionAmount());</span><br><span class="line">            integration=integration.add(orderItemEntity.getIntegrationAmount());</span><br><span class="line">            coupon=coupon.add(orderItemEntity.getCouponAmount());</span><br><span class="line">            integrationTotal += orderItemEntity.getGiftIntegration();</span><br><span class="line">            growthTotal += orderItemEntity.getGiftGrowth();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        entity.setTotalAmount(total);</span><br><span class="line">        entity.setPromotionAmount(promotion);</span><br><span class="line">        entity.setIntegrationAmount(integration);</span><br><span class="line">        entity.setCouponAmount(coupon);</span><br><span class="line">        entity.setIntegration(integrationTotal);</span><br><span class="line">        entity.setGrowth(growthTotal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//付款价格=商品价格+运费</span></span><br><span class="line">        entity.setPayAmount(entity.getFreightAmount().add(total));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置删除状态(0-未删除，1-已删除)</span></span><br><span class="line">        entity.setDeleteStatus(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-验价"><a href="#3-验价" class="headerlink" title="3) 验价"></a>3) 验价</h4><p>将页面提交的价格和后台计算的价格进行对比，若不同则提示用户<code>商品价格发生变化</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> order.getOrder().getPayAmount();</span><br><span class="line"><span class="type">BigDecimal</span> <span class="variable">payPrice</span> <span class="operator">=</span> submitVo.getPayPrice();</span><br><span class="line"><span class="keyword">if</span> (Math.abs(payAmount.subtract(payPrice).doubleValue()) &lt; <span class="number">0.01</span>) &#123;</span><br><span class="line">			<span class="comment">/****************/</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//验价失败</span></span><br><span class="line">    responseVo.setCode(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> responseVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-保存订单"><a href="#4-保存订单" class="headerlink" title="4) 保存订单"></a>4) 保存订单</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveOrder</span><span class="params">(OrderCreateTo orderCreateTo)</span> &#123;</span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">order</span> <span class="operator">=</span> orderCreateTo.getOrder();</span><br><span class="line">    order.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    order.setModifyTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="built_in">this</span>.save(order);</span><br><span class="line">    orderItemService.saveBatch(orderCreateTo.getOrderItems());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-锁定库存"><a href="#5-锁定库存" class="headerlink" title="5) 锁定库存"></a>5) 锁定库存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrderItemVo&gt; orderItemVos = order.getOrderItems().stream().map((item) -&gt; &#123;</span><br><span class="line">                   <span class="type">OrderItemVo</span> <span class="variable">orderItemVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemVo</span>();</span><br><span class="line">                   orderItemVo.setSkuId(item.getSkuId());</span><br><span class="line">                   orderItemVo.setCount(item.getSkuQuantity());</span><br><span class="line">                   <span class="keyword">return</span> orderItemVo;</span><br><span class="line">               &#125;).collect(Collectors.toList());</span><br><span class="line">               <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> wareFeignService.orderLockStock(orderItemVos);</span><br><span class="line">               <span class="comment">//5.1 锁定库存成功</span></span><br><span class="line">               <span class="keyword">if</span> (r.getCode()==<span class="number">0</span>)&#123;</span><br><span class="line">                   responseVo.setOrder(order.getOrder());</span><br><span class="line">                   responseVo.setCode(<span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">return</span> responseVo;</span><br><span class="line">               &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//5.2 锁定库存失败</span></span><br><span class="line">                   <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(msg);</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>找出所有库存大于商品数的仓库</li>
<li>遍历所有满足条件的仓库，逐个尝试锁库存，若锁库存成功则退出遍历</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/lock/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">orderLockStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderItemVo&gt; itemVos)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> wareSkuService.orderLockStock(itemVos);</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoStockException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCodeEnum.NO_STOCK_EXCEPTION.getCode(), BizCodeEnum.NO_STOCK_EXCEPTION.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">orderLockStock</span><span class="params">(List&lt;OrderItemVo&gt; itemVos)</span> &#123;</span><br><span class="line">    List&lt;SkuLockVo&gt; lockVos = itemVos.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">SkuLockVo</span> <span class="variable">skuLockVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuLockVo</span>();</span><br><span class="line">        skuLockVo.setSkuId(item.getSkuId());</span><br><span class="line">        skuLockVo.setNum(item.getCount());</span><br><span class="line">        <span class="comment">//找出所有库存大于商品数的仓库</span></span><br><span class="line">        List&lt;Long&gt; wareIds = baseMapper.listWareIdsHasStock(item.getSkuId(), item.getCount());</span><br><span class="line">        skuLockVo.setWareIds(wareIds);</span><br><span class="line">        <span class="keyword">return</span> skuLockVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SkuLockVo lockVo : lockVos) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> lockVo.getSkuId();</span><br><span class="line">        List&lt;Long&gt; wareIds = lockVo.getWareIds();</span><br><span class="line">        <span class="comment">//如果没有满足条件的仓库，抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (wareIds == <span class="literal">null</span> || wareIds.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long wareId : wareIds) &#123;</span><br><span class="line">                Long count=baseMapper.lockWareSku(skuId, lockVo.getNum(), wareId);</span><br><span class="line">                <span class="keyword">if</span> (count==<span class="number">0</span>)&#123;</span><br><span class="line">                    lock=<span class="literal">false</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    lock = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!lock) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里通过异常机制控制事务回滚，如果在锁定库存失败则抛出<code>NoStockException</code>s,订单服务和库存服务都会回滚。</p>
<h3 id="（3）-分布式事务"><a href="#（3）-分布式事务" class="headerlink" title="（3） 分布式事务"></a>（3） 分布式事务</h3><p><strong>分布式系统中实现一致性的 raft 算法、paxos</strong><br><strong><a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></strong></p>
<p>分布式情况下，可能出现一些服务事务不一致的情况</p>
<ul>
<li>远程服务假失败</li>
<li>远程服务执行完成后，下面其他方法出现异常</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651631106.png" alt="desc"></p>
<p><strong>分布式事务的解决方案</strong></p>
<p><strong>1、2PC 模式</strong></p>
<p>数据库支持的 2PC【2 phase commit 二阶提交】，又叫做 XA Transactions。<br>MySQL 从 5.5 版本开始支持，SQL Server 2005 开始支持，Oracle 7 开始支持。<br>其中，XA 是一个两阶段提交协议，该协议分为以下两个阶段：<br>第一阶段：事务协调器要求每个涉及到事务的数据库预提交(precommit)此操作，并反映是否可以提交.<br>第二阶段：事务协调器要求每个数据库提交数据。<br>其中，如果有任何一个数据库否决此次提交，那么所有数据库都会被要求回滚它们在此事务中的那部分信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651633432.png" alt="desc"></p>
<p>    XA 协议比较简单，而且一旦商业数据库实现了 XA 协议，使用分布式事务的成本也比较低。<br>    XA 性能不理想，特别是在交易下单链路，往往并发量很高，XA 无法满足高并发场景<br>    XA 目前在商业数据库支持的比较理想，在 mysql 数据库中支持的不太理想，mysql 的XA 实现，没有记录 prepare 阶段日志，主备切换回导致主库与备库数据不一致。<br>    许多 nosql 也没有支持 XA，这让 XA 的应用场景变得非常狭隘。<br>    也有 3PC，引入了超时机制（无论协调者还是参与者，在向对方发送请求后，若长时间未收到回应则做出相应处理）</p>
<p><strong>2、柔性事务-TCC 事务</strong></p>
<p>刚性事务：遵循 ACID 原则，强一致性。<br>柔性事务：遵循 BASE 理论，最终一致性；<br>与刚性事务不同，柔性事务允许一定时间内，不同节点的数据不一致，但要求最终一致。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651633487.png" alt="desc"></p>
<p>一阶段 prepare 行为：调用 自定义 的 prepare 逻辑。<br>二阶段 commit 行为：调用 自定义 的 commit 逻辑。<br>二阶段 rollback 行为：调用 自定义 的 rollback 逻辑。<br>所谓 TCC 模式，是指支持把 自定义 的分支事务纳入到全局事务的管理中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/04/1651633524.png" alt="desc"></p>
<p><strong>3、柔性事务-最大努力通知型方案</strong><br>按规律进行通知，不保证数据一定能通知成功，但会提供可查询操作接口进行核对。这种方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。这种<br>方案也是结合 MQ 进行实现，例如：通过 MQ 发送 http 请求，设置最大通知次数。达到通知次数后即不再通知。<br>案例：银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对账文件），支付宝的支付成功异步回调</p>
<p><strong>4、柔性事务-可靠消息+最终一致性方案（异步确保型）</strong><br>实现：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。<br>防止消息丢失：</p>
<ul>
<li>   1、做好消息确认机制（pulisher，consumer【手动 ack】）</li>
<li>   2、每一个发送的消息都在数据库做好记录。定期将失败的消息再次发送一遍</li>
</ul>
<h3 id="（4）使用seata解决分布式事务问题"><a href="#（4）使用seata解决分布式事务问题" class="headerlink" title="（4）使用seata解决分布式事务问题"></a>（4）使用seata解决分布式事务问题</h3><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>环境搭建</p>
<p>下载senta-server-0.7.1并修改<code>register.conf</code>,使用nacos作为注册中心</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span></span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;#:8848&quot;</span><br><span class="line">    namespace = &quot;public&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>将<code>register.conf</code>和<code>file.conf</code>复制到需要开启分布式事务的根目录，并修改<code>file.conf</code></p>
<p> <code>vgroup_mapping.$&#123;application.name&#125;-fescar-service-group = &quot;default&quot;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">vgroup-&gt;rgroup</span></span><br><span class="line">  vgroup_mapping.gulimall-ware-fescar-service-group = &quot;default&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">only support single node</span></span><br><span class="line">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">degrade current not support</span></span><br><span class="line">  enableDegrade = false</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="built_in">disable</span></span></span><br><span class="line">  disable = false</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span></span><br><span class="line">  max.commit.retry.timeout = &quot;-1&quot;</span><br><span class="line">  max.rollback.retry.timeout = &quot;-1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用seata包装数据源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySeataConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSourceProperties dataSourceProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(DataSourceProperties dataSourceProperties)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">HikariDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> dataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(dataSourceProperties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(dataSourceProperties.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceProxy</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在大事务的入口标记注解<code>@GlobalTransactional</code>开启全局事务，并且每个小事务标记注解<code>@Transactional</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubmitOrderResponseVo <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-使用消息队列实现最终一致性"><a href="#5-使用消息队列实现最终一致性" class="headerlink" title="5. 使用消息队列实现最终一致性"></a>5. 使用消息队列实现最终一致性</h2><h3 id="1-延迟队列的定义与实现"><a href="#1-延迟队列的定义与实现" class="headerlink" title="(1) 延迟队列的定义与实现"></a>(1) 延迟队列的定义与实现</h3><ul>
<li><p>定义：</p>
<p>延迟队列存储的对象肯定是对应的延时消息，所谓”延时消息”是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个消息进行消费。</p>
</li>
<li><p>实现：</p>
<p>rabbitmq可以通过设置队列的<code>TTL</code>和死信路由实现延迟队列</p>
<ul>
<li>TTL：</li>
</ul>
<blockquote>
<p>RabbitMQ可以针对Queue设置x-expires 或者 针对Message设置 x-message-ttl，来控制消息的生存时间，如果超时(两者同时设置以最先到期的时间为准)，则消息变为dead letter(死信)</p>
</blockquote>
<ul>
<li>死信路由DLX</li>
</ul>
<blockquote>
<p>RabbitMQ的Queue可以配置x-dead-letter-exchange 和x-dead-letter-routing-key（可选）两个参数，如果队列内出现了dead letter，则按照这两个参数重新路由转发到指定的队列。</p>
</blockquote>
<blockquote>
<ul>
<li>x-dead-letter-exchange：出现dead letter之后将dead letter重新发送到指定exchange</li>
</ul>
</blockquote>
</li>
</ul>
<blockquote>
<ul>
<li>x-dead-letter-routing-key：出现dead letter之后将dead letter重新按照指定的routing-key发送</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972649.png" alt="desc"></p>
<p>针对订单模块创建以上消息队列，创建订单时消息会被发送至队列<code>order.delay.queue</code>，经过<code>TTL</code>的时间后消息会变成死信以<code>order.release.order</code>的路由键经交换机转发至队列<code>order.release.order.queue</code>，再通过监听该队列的消息来实现过期订单的处理</p>
<h3 id="2-延迟队列使用场景"><a href="#2-延迟队列使用场景" class="headerlink" title="(2) 延迟队列使用场景"></a>(2) 延迟队列使用场景</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972693.png" alt="desc"></p>
<p><strong>为什么不能用定时任务完成？</strong></p>
<p>如果恰好在一次扫描后完成业务逻辑，那么就会等待两个扫描周期才能扫到过期的订单，不能保证时效性</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972731.png" alt="desc"></p>
<h3 id="3-定时关单与库存解锁主体逻辑"><a href="#3-定时关单与库存解锁主体逻辑" class="headerlink" title="(3) 定时关单与库存解锁主体逻辑"></a>(3) 定时关单与库存解锁主体逻辑</h3><ul>
<li>订单超时未支付触发订单过期状态修改与库存解锁</li>
</ul>
<blockquote>
<p>创建订单时消息会被发送至队列<code>order.delay.queue</code>，经过<code>TTL</code>的时间后消息会变成死信以<code>order.release.order</code>的路由键经交换机转发至队列<code>order.release.order.queue</code>，再通过监听该队列的消息来实现过期订单的处理</p>
<ul>
<li>如果该订单已支付，则无需处理</li>
<li>否则说明该订单已过期，修改该订单的状态并通过路由键<code>order.release.other</code>发送消息至队列<code>stock.release.stock.queue</code>进行库存解锁</li>
</ul>
</blockquote>
<ul>
<li>库存锁定后延迟检查是否需要解锁库存</li>
</ul>
<blockquote>
<p>在库存锁定后通过<code>路由键stock.locked</code>发送至<code>延迟队列stock.delay.queue</code>，延迟时间到，死信通过<code>路由键stock.release</code>转发至<code>stock.release.stock.queue</code>,通过监听该队列进行判断当前订单状态，来确定库存是否需要解锁</p>
</blockquote>
<ul>
<li>由于<code>关闭订单</code>和<code>库存解锁</code>都有可能被执行多次，因此要保证业务逻辑的幂等性，在执行业务是重新查询当前的状态进行判断</li>
<li>订单关闭和库存解锁都会进行库存解锁的操作，来确保业务异常或者订单过期时库存会被可靠解锁</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972796.png" alt="desc"></p>
<h3 id="4-创建业务交换机和队列"><a href="#4-创建业务交换机和队列" class="headerlink" title="(4) 创建业务交换机和队列"></a>(4) 创建业务交换机和队列</h3><ul>
<li>订单模块</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitmqConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">orderEventExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *   String name,</span></span><br><span class="line"><span class="comment">         *   boolean durable,</span></span><br><span class="line"><span class="comment">         *   boolean autoDelete,</span></span><br><span class="line"><span class="comment">         *   Map&lt;String, Object&gt; arguments</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(<span class="string">&quot;order-event-exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">orderDelayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">            Queue(String name,  队列名字</span></span><br><span class="line"><span class="comment">            boolean durable,  是否持久化</span></span><br><span class="line"><span class="comment">            boolean exclusive,  是否排他</span></span><br><span class="line"><span class="comment">            boolean autoDelete, 是否自动删除</span></span><br><span class="line"><span class="comment">            Map&lt;String, Object&gt; arguments) 属性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        HashMap&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//死信交换机</span></span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;order-event-exchange&quot;</span>);</span><br><span class="line">        <span class="comment">//死信路由键</span></span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;order.release.order&quot;</span>);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">60000</span>); <span class="comment">// 消息过期时间 1分钟</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;order.delay.queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通队列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">orderReleaseQueue</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;order.release.order.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单的binding</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">orderCreateBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * String destination, 目的地（队列名或者交换机名字）</span></span><br><span class="line"><span class="comment">         * DestinationType destinationType, 目的地类型（Queue、Exhcange）</span></span><br><span class="line"><span class="comment">         * String exchange,</span></span><br><span class="line"><span class="comment">         * String routingKey,</span></span><br><span class="line"><span class="comment">         * Map&lt;String, Object&gt; arguments</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;order.delay.queue&quot;</span>, Binding.DestinationType.QUEUE, <span class="string">&quot;order-event-exchange&quot;</span>, <span class="string">&quot;order.create.order&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">orderReleaseBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;order.release.order.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;order.release.order&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">orderReleaseOrderBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;stock.release.stock.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;order.release.other.#&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>库存模块</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRabbitmqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">stockEventExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(<span class="string">&quot;stock-event-exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">stockDelayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;stock-event-exchange&quot;</span>);</span><br><span class="line">        arguments.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;stock.release&quot;</span>);</span><br><span class="line">        <span class="comment">// 消息过期时间 2分钟</span></span><br><span class="line">        arguments.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">120000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;stock.delay.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通队列，用于解锁库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">stockReleaseStockQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;stock.release.stock.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机和延迟队列绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">stockLockedBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;stock.delay.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;stock-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stock.locked&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机和普通队列绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">stockReleaseBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;stock.release.stock.queue&quot;</span>,</span><br><span class="line">                Binding.DestinationType.QUEUE,</span><br><span class="line">                <span class="string">&quot;stock-event-exchange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;stock.release.#&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-库存自动解锁"><a href="#5-库存自动解锁" class="headerlink" title="(5) 库存自动解锁"></a>(5) 库存自动解锁</h3><h4 id="1）库存锁定"><a href="#1）库存锁定" class="headerlink" title="1）库存锁定"></a>1）库存锁定</h4><p>在库存锁定是添加以下逻辑</p>
<ul>
<li>由于可能订单回滚的情况，所以为了能够得到库存锁定的信息，在锁定时需要记录库存工作单，其中包括订单信息和锁定库存时的信息(仓库id，商品id，锁了几件…)</li>
<li>在锁定成功后，向延迟队列发消息，带上库存锁定的相关信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">orderLockStock</span><span class="params">(WareSkuLockVo wareSkuLockVo)</span> &#123;</span><br><span class="line">    <span class="comment">//因为可能出现订单回滚后，库存锁定不回滚的情况，但订单已经回滚，得不到库存锁定信息，因此要有库存工作单</span></span><br><span class="line">    <span class="type">WareOrderTaskEntity</span> <span class="variable">taskEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WareOrderTaskEntity</span>();</span><br><span class="line">    taskEntity.setOrderSn(wareSkuLockVo.getOrderSn());</span><br><span class="line">    taskEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    wareOrderTaskService.save(taskEntity);</span><br><span class="line"></span><br><span class="line">    List&lt;OrderItemVo&gt; itemVos = wareSkuLockVo.getLocks();</span><br><span class="line">    List&lt;SkuLockVo&gt; lockVos = itemVos.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">SkuLockVo</span> <span class="variable">skuLockVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuLockVo</span>();</span><br><span class="line">        skuLockVo.setSkuId(item.getSkuId());</span><br><span class="line">        skuLockVo.setNum(item.getCount());</span><br><span class="line">        List&lt;Long&gt; wareIds = baseMapper.listWareIdsHasStock(item.getSkuId(), item.getCount());</span><br><span class="line">        skuLockVo.setWareIds(wareIds);</span><br><span class="line">        <span class="keyword">return</span> skuLockVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (SkuLockVo lockVo : lockVos) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> lockVo.getSkuId();</span><br><span class="line">        List&lt;Long&gt; wareIds = lockVo.getWareIds();</span><br><span class="line">        <span class="keyword">if</span> (wareIds == <span class="literal">null</span> || wareIds.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Long wareId : wareIds) &#123;</span><br><span class="line">                Long count=baseMapper.lockWareSku(skuId, lockVo.getNum(), wareId);</span><br><span class="line">                <span class="keyword">if</span> (count==<span class="number">0</span>)&#123;</span><br><span class="line">                    lock=<span class="literal">false</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//锁定成功，保存工作单详情</span></span><br><span class="line">                    <span class="type">WareOrderTaskDetailEntity</span> <span class="variable">detailEntity</span> <span class="operator">=</span> WareOrderTaskDetailEntity.builder()</span><br><span class="line">                            .skuId(skuId)</span><br><span class="line">                            .skuName(<span class="string">&quot;&quot;</span>)</span><br><span class="line">                            .skuNum(lockVo.getNum())</span><br><span class="line">                            .taskId(taskEntity.getId())</span><br><span class="line">                            .wareId(wareId)</span><br><span class="line">                            .lockStatus(<span class="number">1</span>).build();</span><br><span class="line">                    wareOrderTaskDetailService.save(detailEntity);</span><br><span class="line">                    <span class="comment">//发送库存锁定消息至延迟队列</span></span><br><span class="line">                    <span class="type">StockLockedTo</span> <span class="variable">lockedTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StockLockedTo</span>();</span><br><span class="line">                    lockedTo.setId(taskEntity.getId());</span><br><span class="line">                    <span class="type">StockDetailTo</span> <span class="variable">detailTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StockDetailTo</span>();</span><br><span class="line">                    BeanUtils.copyProperties(detailEntity,detailTo);</span><br><span class="line">                    lockedTo.setDetailTo(detailTo);</span><br><span class="line">                    rabbitTemplate.convertAndSend(<span class="string">&quot;stock-event-exchange&quot;</span>,<span class="string">&quot;stock.locked&quot;</span>,lockedTo);</span><br><span class="line"></span><br><span class="line">                    lock = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!lock) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoStockException</span>(skuId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2）监听队列"><a href="#2）监听队列" class="headerlink" title="2）监听队列"></a>2）监听队列</h4><ul>
<li>延迟队列会将过期的消息路由至<code>&quot;stock.release.stock.queue&quot;</code>,通过监听该队列实现库存的解锁</li>
<li>为保证消息的可靠到达，我们使用手动确认消息的模式，在解锁成功后确认消息，若出现异常则重新归队</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;stock.release.stock.queue&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockReleaseListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WareSkuService wareSkuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStockLockedRelease</span><span class="params">(StockLockedTo stockLockedTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;************************收到库存解锁的消息********************************&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unlock(stockLockedTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）库存解锁"><a href="#3）库存解锁" class="headerlink" title="3）库存解锁"></a>3）库存解锁</h4><ul>
<li>如果工作单详情不为空，说明该库存锁定成功<ul>
<li>查询最新的订单状态，如果订单不存在，说明订单提交出现异常回滚，或者订单处于已取消的状态，我们都对已锁定的库存进行解锁</li>
</ul>
</li>
<li>如果工作单详情为空，说明库存未锁定，自然无需解锁</li>
<li>为保证幂等性，我们分别对订单的状态和工作单的状态都进行了判断，只有当订单过期且工作单显示当前库存处于锁定的状态时，才进行库存的解锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(StockLockedTo stockLockedTo)</span> &#123;</span><br><span class="line">       <span class="type">StockDetailTo</span> <span class="variable">detailTo</span> <span class="operator">=</span> stockLockedTo.getDetailTo();</span><br><span class="line">       <span class="type">WareOrderTaskDetailEntity</span> <span class="variable">detailEntity</span> <span class="operator">=</span> wareOrderTaskDetailService.getById(detailTo.getId());</span><br><span class="line">       <span class="comment">//1.如果工作单详情不为空，说明该库存锁定成功</span></span><br><span class="line">       <span class="keyword">if</span> (detailEntity != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="type">WareOrderTaskEntity</span> <span class="variable">taskEntity</span> <span class="operator">=</span> wareOrderTaskService.getById(stockLockedTo.getId());</span><br><span class="line">           <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> orderFeignService.infoByOrderSn(taskEntity.getOrderSn());</span><br><span class="line">           <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="type">OrderTo</span> <span class="variable">order</span> <span class="operator">=</span> r.getData(<span class="string">&quot;order&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;OrderTo&gt;() &#123;</span><br><span class="line">               &#125;);</span><br><span class="line">               <span class="comment">//没有这个订单||订单状态已经取消 解锁库存</span></span><br><span class="line">               <span class="keyword">if</span> (order == <span class="literal">null</span>||order.getStatus()== OrderStatusEnum.CANCLED.getCode()) &#123;</span><br><span class="line">                   <span class="comment">//为保证幂等性，只有当工作单详情处于被锁定的情况下才进行解锁</span></span><br><span class="line">                   <span class="keyword">if</span> (detailEntity.getLockStatus()== WareTaskStatusEnum.Locked.getCode())&#123;</span><br><span class="line">                       unlockStock(detailTo.getSkuId(), detailTo.getSkuNum(), detailTo.getWareId(), detailEntity.getId());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;远程调用订单服务失败&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//无需解锁</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-定时关单"><a href="#6-定时关单" class="headerlink" title="(6) 定时关单"></a>(6) 定时关单</h3><h4 id="1-提交订单"><a href="#1-提交订单" class="headerlink" title="1) 提交订单"></a>1) 提交订单</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SubmitOrderResponseVo <span class="title function_">submitOrder</span><span class="params">(OrderSubmitVo submitVo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提交订单的业务处理。。。</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发送消息到订单延迟队列，判断过期订单</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>,<span class="string">&quot;order.create.order&quot;</span>,order.getOrder());</span><br><span class="line"></span><br><span class="line">               </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-监听队列"><a href="#2-监听队列" class="headerlink" title="2) 监听队列"></a>2) 监听队列</h4><p>创建订单的消息会进入延迟队列，最终发送至队列<code>order.release.order.queue</code>，因此我们对该队列进行监听，进行订单的关闭</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;order.release.order.queue&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderCloseListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">(OrderEntity orderEntity, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到过期的订单信息，准备关闭订单&quot;</span> + orderEntity.getOrderSn());</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderService.closeOrder(orderEntity);</span><br><span class="line">            channel.basicAck(deliveryTag,<span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            channel.basicReject(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-关闭订单"><a href="#3-关闭订单" class="headerlink" title="3) 关闭订单"></a>3) 关闭订单</h4><ul>
<li>由于要保证幂等性，因此要查询最新的订单状态判断是否需要关单</li>
<li>关闭订单后也需要解锁库存，因此发送消息进行库存、会员服务对应的解锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeOrder</span><span class="params">(OrderEntity orderEntity)</span> &#123;</span><br><span class="line">    <span class="comment">//因为消息发送过来的订单已经是很久前的了，中间可能被改动，因此要查询最新的订单</span></span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">newOrderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(orderEntity.getId());</span><br><span class="line">    <span class="comment">//如果订单还处于新创建的状态，说明超时未支付，进行关单</span></span><br><span class="line">    <span class="keyword">if</span> (newOrderEntity.getStatus() == OrderStatusEnum.CREATE_NEW.getCode()) &#123;</span><br><span class="line">        <span class="type">OrderEntity</span> <span class="variable">updateOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderEntity</span>();</span><br><span class="line">        updateOrder.setId(newOrderEntity.getId());</span><br><span class="line">        updateOrder.setStatus(OrderStatusEnum.CANCLED.getCode());</span><br><span class="line">        <span class="built_in">this</span>.updateById(updateOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关单后发送消息通知其他服务进行关单相关的操作，如解锁库存</span></span><br><span class="line">        <span class="type">OrderTo</span> <span class="variable">orderTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderTo</span>();</span><br><span class="line">        BeanUtils.copyProperties(newOrderEntity,orderTo);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>, <span class="string">&quot;order.release.other&quot;</span>,orderTo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-解锁库存"><a href="#4-解锁库存" class="headerlink" title="4) 解锁库存"></a>4) 解锁库存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &#123;&quot;stock.release.stock.queue&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockReleaseListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WareSkuService wareSkuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStockLockedRelease</span><span class="params">(StockLockedTo stockLockedTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;************************收到库存解锁的消息********************************&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unlock(stockLockedTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStockLockedRelease</span><span class="params">(OrderTo orderTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;************************从订单模块收到库存解锁的消息********************************&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wareSkuService.unlock(orderTo);</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(OrderTo orderTo)</span> &#123;</span><br><span class="line">    <span class="comment">//为防止重复解锁，需要重新查询工作单</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> orderTo.getOrderSn();</span><br><span class="line">    <span class="type">WareOrderTaskEntity</span> <span class="variable">taskEntity</span> <span class="operator">=</span> wareOrderTaskService.getBaseMapper().selectOne((<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;WareOrderTaskEntity&gt;().eq(<span class="string">&quot;order_sn&quot;</span>, orderSn)));</span><br><span class="line">    <span class="comment">//查询出当前订单相关的且处于锁定状态的工作单详情</span></span><br><span class="line">    List&lt;WareOrderTaskDetailEntity&gt; lockDetails = wareOrderTaskDetailService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;WareOrderTaskDetailEntity&gt;().eq(<span class="string">&quot;task_id&quot;</span>, taskEntity.getId()).eq(<span class="string">&quot;lock_status&quot;</span>, WareTaskStatusEnum.Locked.getCode()));</span><br><span class="line">    <span class="keyword">for</span> (WareOrderTaskDetailEntity lockDetail : lockDetails) &#123;</span><br><span class="line">        unlockStock(lockDetail.getSkuId(),lockDetail.getSkuNum(),lockDetail.getWareId(),lockDetail.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-支付"><a href="#6-支付" class="headerlink" title="6. 支付"></a>6. 支付</h2><h3 id="1-支付宝加密原理"><a href="#1-支付宝加密原理" class="headerlink" title="(1) 支付宝加密原理"></a>(1) 支付宝加密原理</h3><ul>
<li>支付宝加密采用RSA非对称加密，分别在商户端和支付宝端有两对公钥和私钥</li>
<li>在发送订单数据时，直接使用明文，但会使用<code>商户私钥</code>加一个对应的签名，支付宝端会使用<code>商户公钥</code>对签名进行验签，只有数据明文和签名对应的时候才能说明传输正确</li>
<li>支付成功后，支付宝发送支付成功数据之外，还会使用<code>支付宝私钥</code>加一个对应的签名，商户端收到支付成功数据之后也会使用<code>支付宝公钥</code>延签，成功后才能确认</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972890.png" alt="desc"></p>
<h3 id="2-配置支付宝沙箱环境"><a href="#2-配置支付宝沙箱环境" class="headerlink" title="(2) 配置支付宝沙箱环境"></a>(2) 配置支付宝沙箱环境</h3><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651972957.png" alt="desc"></p>
<h3 id="3-环境搭建"><a href="#3-环境搭建" class="headerlink" title="(3) 环境搭建"></a>(3) 环境搭建</h3><p>导入支付宝sdk</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sdk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>alipay-sdk-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.28.ALL<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>抽取支付工具类并进行配置</p>
<p>成功调用该接口后，返回的数据就是支付页面的html，因此后续会使用<code>@ResponseBody</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;alipay&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlipayTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在支付宝创建的应用的id</span></span><br><span class="line">    <span class="keyword">private</span>   <span class="type">String</span> <span class="variable">app_id</span> <span class="operator">=</span> <span class="string">&quot;2016102600763190&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商户私钥，您的PKCS8格式RSA2私钥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">merchant_private_key</span> <span class="operator">=</span> <span class="string">&quot;MjXN6Hnj8k2GAriRFt0BS9gjihbl9Rt38VMNbBi3Vt3Cy6TOwANLLJ/DfnYjRqwCG81fkyKlDqdsamdfCiTysCa0gQKBgQDYQ45LSRxAOTyM5NliBmtev0lbpDa7FqXL0UFgBel5VgA1Ysp0+6ex2n73NBHbaVPEXgNMnTdzU3WF9uHF4Gj0mfUzbVMbj/YkkHDOZHBggAjEHCB87IKowq/uAH/++Qes2GipHHCTJlG6yejdxhOsMZXdCRnidNx5yv9+2JI37QKBgQCw0xn7ZeRBIOXxW7xFJw1WecUV7yaL9OWqKRHat3lFtf1Qo/87cLl+KeObvQjjXuUe07UkrS05h6ijWyCFlBo2V7Cdb3qjq4atUwScKfTJONnrF+fwTX0L5QgyQeDX5a4yYp4pLmt6HKh34sI5S/RSWxDm7kpj+/MjCZgp6Xc51g==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">alipay_public_key</span> <span class="operator">=</span> <span class="string">&quot;MIIBIjA74UKxt2F8VMIRKrRAAAuIMuawIsl4Ye+G12LK8P1ZLYy7ZJpgZ+Wv5nOs3DdoEazgCERj/ON8lM1KBHZOAV+TkrIcyi7cD1gfv4a1usikrUqm8/qhFvoiUfyHJFv1ymT7C4BI6aHzQ2zcUlSQPGoPl4C11tgnSkm3DlH2JZKgaIMcCOnNH+qctjNh9yIV9zat2qUiXbxmrCTtxAmiI3I+eVsUNwvwIDAQAB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器[异步通知]页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">// 支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息</span></span><br><span class="line">    <span class="keyword">private</span>  String notify_url=<span class="string">&quot;http://**.natappfree.cc/payed/notify&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line">    <span class="comment">//同步通知，支付成功，一般跳转到成功页</span></span><br><span class="line">    <span class="keyword">private</span>  String return_url=<span class="string">&quot;http://order.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 签名方式</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">String</span> <span class="variable">sign_type</span> <span class="operator">=</span> <span class="string">&quot;RSA2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符编码格式</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">String</span> <span class="variable">charset</span> <span class="operator">=</span> <span class="string">&quot;utf-8&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付宝网关； https://openapi.alipaydev.com/gateway.do</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">String</span> <span class="variable">gatewayUrl</span> <span class="operator">=</span> <span class="string">&quot;https://openapi.alipaydev.com/gateway.do&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">pay</span><span class="params">(PayVo vo)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//AlipayClient alipayClient = new DefaultAlipayClient(AlipayTemplate.gatewayUrl, AlipayTemplate.app_id, AlipayTemplate.merchant_private_key, &quot;json&quot;, AlipayTemplate.charset, AlipayTemplate.alipay_public_key, AlipayTemplate.sign_type);</span></span><br><span class="line">        <span class="comment">//1、根据支付宝的配置生成一个支付客户端</span></span><br><span class="line">        <span class="type">AlipayClient</span> <span class="variable">alipayClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAlipayClient</span>(gatewayUrl,</span><br><span class="line">                app_id, merchant_private_key, <span class="string">&quot;json&quot;</span>,</span><br><span class="line">                charset, alipay_public_key, sign_type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、创建一个支付请求 //设置请求参数</span></span><br><span class="line">        <span class="type">AlipayTradePagePayRequest</span> <span class="variable">alipayRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlipayTradePagePayRequest</span>();</span><br><span class="line">        alipayRequest.setReturnUrl(return_url);</span><br><span class="line">        alipayRequest.setNotifyUrl(notify_url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//商户订单号，商户网站订单系统中唯一订单号，必填</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">out_trade_no</span> <span class="operator">=</span> vo.getOut_trade_no();</span><br><span class="line">        <span class="comment">//付款金额，必填</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">total_amount</span> <span class="operator">=</span> vo.getTotal_amount();</span><br><span class="line">        <span class="comment">//订单名称，必填</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">subject</span> <span class="operator">=</span> vo.getSubject();</span><br><span class="line">        <span class="comment">//商品描述，可空</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> vo.getBody();</span><br><span class="line"></span><br><span class="line">        alipayRequest.setBizContent(<span class="string">&quot;&#123;\&quot;out_trade_no\&quot;:\&quot;&quot;</span>+ out_trade_no +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;total_amount\&quot;:\&quot;&quot;</span>+ total_amount +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;subject\&quot;:\&quot;&quot;</span>+ subject +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;body\&quot;:\&quot;&quot;</span>+ body +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;product_code\&quot;:\&quot;FAST_INSTANT_TRADE_PAY\&quot;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> alipayClient.pageExecute(alipayRequest).getBody();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//会收到支付宝的响应，响应的是一个页面，只要浏览器显示这个页面，就会自动来到支付宝的收银台页面</span></span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝的响应：&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-订单支付与同步通知"><a href="#4-订单支付与同步通知" class="headerlink" title="(4) 订单支付与同步通知"></a>(4) 订单支付与同步通知</h3><p>点击支付跳转到支付接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/aliPayOrder&quot;,produces = &quot;text/html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">aliPayOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;orderSn&quot;)</span> String orderSn)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;接收到订单信息orderSn：&quot;</span>+orderSn);</span><br><span class="line">    <span class="comment">//获取当前订单并设置支付订单相关信息</span></span><br><span class="line">    <span class="type">PayVo</span> <span class="variable">payVo</span> <span class="operator">=</span> orderService.getOrderPay(orderSn);</span><br><span class="line">    <span class="type">String</span> <span class="variable">pay</span> <span class="operator">=</span> alipayTemplate.pay(payVo);</span><br><span class="line">    <span class="keyword">return</span> pay;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayVo <span class="title function_">getOrderPay</span><span class="params">(String orderSn)</span> &#123;</span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;OrderEntity&gt;().eq(<span class="string">&quot;order_sn&quot;</span>, orderSn));</span><br><span class="line">    <span class="type">PayVo</span> <span class="variable">payVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayVo</span>();</span><br><span class="line">    <span class="comment">//交易号</span></span><br><span class="line">    payVo.setOut_trade_no(orderSn);</span><br><span class="line">    <span class="comment">//支付金额设置为两位小数，否则会报错</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> orderEntity.getPayAmount().setScale(<span class="number">2</span>, BigDecimal.ROUND_UP);</span><br><span class="line">    payVo.setTotal_amount(payAmount.toString());</span><br><span class="line"></span><br><span class="line">    List&lt;OrderItemEntity&gt; orderItemEntities = orderItemService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;OrderItemEntity&gt;().eq(<span class="string">&quot;order_sn&quot;</span>, orderSn));</span><br><span class="line">    <span class="type">OrderItemEntity</span> <span class="variable">orderItemEntity</span> <span class="operator">=</span> orderItemEntities.get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//订单名称</span></span><br><span class="line">    payVo.setSubject(orderItemEntity.getSkuName());</span><br><span class="line">    <span class="comment">//商品描述</span></span><br><span class="line">    payVo.setBody(orderItemEntity.getSkuAttrsVals());</span><br><span class="line">    <span class="keyword">return</span> payVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置成功回调地址为订单详情页</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面跳转同步通知页面路径 需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line"> <span class="comment">//同步通知，支付成功，一般跳转到成功页</span></span><br><span class="line"> <span class="keyword">private</span>  String return_url=<span class="string">&quot;http://order.gulimall.com/memberOrder.html&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取当前用户的所有订单</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/memberOrder.html&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">memberOrder</span><span class="params">(<span class="meta">@RequestParam(value = &quot;pageNum&quot;,required = false,defaultValue = &quot;0&quot;)</span> Integer pageNum,Model model)</span>&#123;</span><br><span class="line">     Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">     params.put(<span class="string">&quot;page&quot;</span>, pageNum.toString());</span><br><span class="line">     <span class="comment">//分页查询当前用户的所有订单及对应订单项</span></span><br><span class="line">     <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> orderService.getMemberOrderPage(params);</span><br><span class="line">     model.addAttribute(<span class="string">&quot;pageUtil&quot;</span>, page);</span><br><span class="line">     <span class="comment">//返回至订单详情页</span></span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-异步通知"><a href="#5-异步通知" class="headerlink" title="(5) 异步通知"></a>(5) 异步通知</h3><ul>
<li>订单支付成功后支付宝会回调商户接口，这个时候需要修改订单状态</li>
<li>由于同步跳转可能由于网络问题失败，所以使用异步通知</li>
<li>支付宝使用的是最大努力通知方案，保障数据一致性，隔一段时间会通知商户支付成功，直到返回<code>success</code></li>
</ul>
<h4 id="1）内网穿透设置异步通知地址"><a href="#1）内网穿透设置异步通知地址" class="headerlink" title="1）内网穿透设置异步通知地址"></a>1）内网穿透设置异步通知地址</h4><ul>
<li><p>将外网映射到本地的<code>order.gulimall.com:80</code></p>
</li>
<li><p>由于回调的请求头不是<code>order.gulimall.com</code>，因此nginx转发到网关后找不到对应的服务，所以需要对nginx进行设置</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973051.png" alt="desc"></p>
<p>将<code>/payed/notify</code>异步通知转发至订单服务</p>
</li>
</ul>
<p>设置异步通知的地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务器[异步通知]页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问</span></span><br><span class="line"><span class="comment">// 支付宝会悄悄的给我们发送一个请求，告诉我们支付成功的信息</span></span><br><span class="line"><span class="keyword">private</span>  String notify_url=<span class="string">&quot;http://****.natappfree.cc/payed/notify&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2）验证签名"><a href="#2）验证签名" class="headerlink" title="2）验证签名"></a>2）验证签名</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/payed/notify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handlerAlipay</span><span class="params">(HttpServletRequest request, PayAsyncVo payAsyncVo)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收到支付宝异步通知******************&quot;</span>);</span><br><span class="line">    <span class="comment">// 只要收到支付宝的异步通知，返回 success 支付宝便不再通知</span></span><br><span class="line">    <span class="comment">// 获取支付宝POST过来反馈信息</span></span><br><span class="line">    <span class="comment">//TODO 需要验签</span></span><br><span class="line">    Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Map&lt;String, String[]&gt; requestParams = request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (String name : requestParams.keySet()) &#123;</span><br><span class="line">        String[] values = requestParams.get(name);</span><br><span class="line">        <span class="type">String</span> <span class="variable">valueStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">            valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">                    : valueStr + values[i] + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//乱码解决，这段代码在出现乱码时使用</span></span><br><span class="line">        <span class="comment">// valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;utf-8&quot;);</span></span><br><span class="line">        params.put(name, valueStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">signVerified</span> <span class="operator">=</span> AlipaySignature.rsaCheckV1(params, alipayTemplate.getAlipay_public_key(),</span><br><span class="line">            alipayTemplate.getCharset(), alipayTemplate.getSign_type()); <span class="comment">//调用SDK验证签名</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (signVerified)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝异步通知验签成功&quot;</span>);</span><br><span class="line">        <span class="comment">//修改订单状态</span></span><br><span class="line">        orderService.handlerPayResult(payAsyncVo);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;支付宝异步通知验签失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）修改订单状态与保存交易流水"><a href="#3）修改订单状态与保存交易流水" class="headerlink" title="3）修改订单状态与保存交易流水"></a>3）修改订单状态与保存交易流水</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerPayResult</span><span class="params">(PayAsyncVo payAsyncVo)</span> &#123;</span><br><span class="line">    <span class="comment">//保存交易流水</span></span><br><span class="line">    <span class="type">PaymentInfoEntity</span> <span class="variable">infoEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaymentInfoEntity</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> payAsyncVo.getOut_trade_no();</span><br><span class="line">    infoEntity.setOrderSn(orderSn);</span><br><span class="line">    infoEntity.setAlipayTradeNo(payAsyncVo.getTrade_no());</span><br><span class="line">    infoEntity.setSubject(payAsyncVo.getSubject());</span><br><span class="line">    <span class="type">String</span> <span class="variable">trade_status</span> <span class="operator">=</span> payAsyncVo.getTrade_status();</span><br><span class="line">    infoEntity.setPaymentStatus(trade_status);</span><br><span class="line">    infoEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    infoEntity.setCallbackTime(payAsyncVo.getNotify_time());</span><br><span class="line">    paymentInfoService.save(infoEntity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断交易状态是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (trade_status.equals(<span class="string">&quot;TRADE_SUCCESS&quot;</span>) || trade_status.equals(<span class="string">&quot;TRADE_FINISHED&quot;</span>)) &#123;</span><br><span class="line">        baseMapper.updateOrderStatus(orderSn, OrderStatusEnum.PAYED.getCode(), PayConstant.ALIPAY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-异步通知的参数"><a href="#4-异步通知的参数" class="headerlink" title="4) 异步通知的参数"></a>4) 异步通知的参数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/payed/notify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handlerAlipay</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;收到支付宝异步通知******************&quot;</span>);</span><br><span class="line">    Map&lt;String, String[]&gt; parameterMap = request.getParameterMap();</span><br><span class="line">    <span class="keyword">for</span> (String key : parameterMap.keySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> request.getParameter(key);</span><br><span class="line">        System.out.println(<span class="string">&quot;key:&quot;</span>+key+<span class="string">&quot;===========&gt;value:&quot;</span>+value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">收到支付宝异步通知******************</span><br><span class="line">key:gmt_create===========&gt;value:2020-10-18 09:13:26</span><br><span class="line">key:charset===========&gt;value:utf-8</span><br><span class="line">key:gmt_payment===========&gt;value:2020-10-18 09:13:34</span><br><span class="line">key:notify_time===========&gt;value:2020-10-18 09:13:35</span><br><span class="line">key:subject===========&gt;value:华为</span><br><span class="line">key:sign===========&gt;value:aqhKWzgzTLE84Scy5d8i3f+t9f7t7IE5tK/s5iHf3SdFQXPnTt6MEVtbr15ZXmITEo015nCbSXaUFJvLiAhWpvkNEd6ysraa+2dMgotuHPIHnIUFwvdk+U4Ez+2A4DBTJgmwtc5Ay8mYLpHLNR9ASuEmkxxK2F3Ov6MO0d+1DOjw9c/CCRRBWR8NHSJePAy/UxMzULLtpMELQ1KUVHLgZC5yym5TYSuRmltYpLHOuoJhJw8vGkh2+4FngvjtS7SBhEhR1GvJCYm1iXRFTNgP9Fmflw+EjxrDafCIA+r69ZqoJJ2Sk1hb4cBsXgNrFXR2Uj4+rQ1Ec74bIjT98f1KpA==</span><br><span class="line">key:buyer_id===========&gt;value:2088622954825223</span><br><span class="line">key:body===========&gt;value:上市年份：2020；内存：64G</span><br><span class="line">key:invoice_amount===========&gt;value:6300.00</span><br><span class="line">key:version===========&gt;value:1.0</span><br><span class="line">key:notify_id===========&gt;value:2020101800222091334025220507700182</span><br><span class="line">key:fund_bill_list===========&gt;value:[&#123;&quot;amount&quot;:&quot;6300.00&quot;,&quot;fundChannel&quot;:&quot;ALIPAYACCOUNT&quot;&#125;]</span><br><span class="line">key:notify_type===========&gt;value:trade_status_sync</span><br><span class="line">key:out_trade_no===========&gt;value:12345523123</span><br><span class="line">key:total_amount===========&gt;value:6300.00</span><br><span class="line">key:trade_status===========&gt;value:TRADE_SUCCESS</span><br><span class="line">key:trade_no===========&gt;value:2020101822001425220501264292</span><br><span class="line">key:auth_app_id===========&gt;value:2016102600763190</span><br><span class="line">key:receipt_amount===========&gt;value:6300.00</span><br><span class="line">key:point_amount===========&gt;value:0.00</span><br><span class="line">key:app_id===========&gt;value:2016102600763190</span><br><span class="line">key:buyer_pay_amount===========&gt;value:6300.00</span><br><span class="line">key:sign_type===========&gt;value:RSA2</span><br><span class="line">key:seller_id===========&gt;value:2088102181115314</span><br></pre></td></tr></table></figure>

<p>各参数详细意义见<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/194/103296">支付宝开放平台异步通知</a></p>
<h3 id="6-收单"><a href="#6-收单" class="headerlink" title="(6) 收单"></a>(6) 收单</h3><p>由于可能出现订单已经过期后，库存已经解锁，但支付成功后再修改订单状态的情况，需要设置支付有效时间，只有在有效期内才能进行支付</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">alipayRequest.setBizContent(<span class="string">&quot;&#123;\&quot;out_trade_no\&quot;:\&quot;&quot;</span>+ out_trade_no +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;total_amount\&quot;:\&quot;&quot;</span>+ total_amount +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;subject\&quot;:\&quot;&quot;</span>+ subject +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;body\&quot;:\&quot;&quot;</span>+ body +<span class="string">&quot;\&quot;,&quot;</span></span><br><span class="line">        <span class="comment">//设置过期时间为1m</span></span><br><span class="line">        +<span class="string">&quot;\&quot;timeout_express\&quot;:\&quot;1m\&quot;,&quot;</span></span><br><span class="line">        + <span class="string">&quot;\&quot;product_code\&quot;:\&quot;FAST_INSTANT_TRADE_PAY\&quot;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>超时后订单显示</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973086.png" alt="desc"></p>
<h1 id="秒杀服务"><a href="#秒杀服务" class="headerlink" title="秒杀服务"></a>秒杀服务</h1><h2 id="1-秒杀（高并发）系统关注的问题"><a href="#1-秒杀（高并发）系统关注的问题" class="headerlink" title="1. 秒杀（高并发）系统关注的问题"></a>1. 秒杀（高并发）系统关注的问题</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973246.png" alt="desc"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973308.png" alt="desc"></p>
<h2 id="2-秒杀架构设计"><a href="#2-秒杀架构设计" class="headerlink" title="2. 秒杀架构设计"></a>2. 秒杀架构设计</h2><h3 id="1-秒杀架构图"><a href="#1-秒杀架构图" class="headerlink" title="(1) 秒杀架构图"></a>(1) 秒杀架构图</h3><ul>
<li>项目独立部署，独立秒杀模块<code>gulimall-seckill</code></li>
<li>使用定时任务每天三点上架最新秒杀商品，削减高峰期压力</li>
<li>秒杀链接加密，为秒杀商品添加唯一商品随机码，在开始秒杀时才暴露接口</li>
<li>库存预热，先从数据库中扣除一部分库存以<code>redisson 信号量</code>的形式存储在redis中</li>
<li>队列削峰，秒杀成功后立即返回，然后以发送消息的形式创建订单</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973406.png" alt="desc"></p>
<h3 id="2-存储模型设计"><a href="#2-存储模型设计" class="headerlink" title="(2) 存储模型设计"></a>(2) 存储模型设计</h3><ul>
<li>秒杀场次存储的<code>List</code>可以当做<code>hash key</code>在<code>SECKILL_CHARE_PREFIX </code>中获得对应的商品数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储的秒杀场次对应数据</span></span><br><span class="line"><span class="comment">//K: SESSION_CACHE_PREFIX + startTime + &quot;_&quot; + endTime</span></span><br><span class="line"><span class="comment">//V: sessionId+&quot;-&quot;+skuId的List</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SESSION_CACHE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;seckill:sessions:&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储的秒杀商品数据</span></span><br><span class="line"><span class="comment">//K: 固定值SECKILL_CHARE_PREFIX</span></span><br><span class="line"><span class="comment">//V: hash，k为sessionId+&quot;-&quot;+skuId，v为对应的商品信息SeckillSkuRedisTo</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECKILL_CHARE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;seckill:skus&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//K: SKU_STOCK_SEMAPHORE+商品随机码</span></span><br><span class="line"><span class="comment">//V: 秒杀的库存件数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SKU_STOCK_SEMAPHORE</span> <span class="operator">=</span> <span class="string">&quot;seckill:stock:&quot;</span>;    <span class="comment">//+商品随机码</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>存储后的效果</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1651973552.png" alt="desc"></p>
</li>
<li><p>用来存储的to</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillSkuRedisTo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long promotionId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动场次id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long promotionSessionId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 秒杀价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal seckillPrice;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 秒杀总量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer seckillCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每人限购数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer seckillLimit;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer seckillSort;</span><br><span class="line">    <span class="comment">//以上都为SeckillSkuRelationEntity的属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//skuInfo</span></span><br><span class="line">    <span class="keyword">private</span> SkuInfoVo skuInfoVo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前商品秒杀的开始时间</span></span><br><span class="line">    <span class="keyword">private</span> Long startTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前商品秒杀的结束时间</span></span><br><span class="line">    <span class="keyword">private</span> Long endTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前商品秒杀的随机码</span></span><br><span class="line">    <span class="keyword">private</span> String randomCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-商品上架"><a href="#3-商品上架" class="headerlink" title="3. 商品上架"></a>3. 商品上架</h2><h3 id="1-定时上架"><a href="#1-定时上架" class="headerlink" title="(1) 定时上架"></a>(1) 定时上架</h3><ul>
<li><p>开启对定时任务的支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">//开启对异步的支持，防止定时任务之间相互阻塞</span></span><br><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">//开启对定时任务的支持</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>每天凌晨三点远程调用<code>coupon</code>服务上架最近三天的秒杀商品</p>
</li>
<li><p>由于在分布式情况下该方法可能同时被调用多次，因此加入分布式锁，同时只有一个服务可以调用该方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//秒杀商品上架功能的锁</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">upload_lock</span> <span class="operator">=</span> <span class="string">&quot;seckill:upload:lock&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 定时任务</span></span><br><span class="line"><span class="comment">   * 每天三点上架最近三天的秒杀商品</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Async</span></span><br><span class="line">  <span class="meta">@Scheduled(cron = &quot;0 0 3 * * ?&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadSeckillSkuLatest3Days</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">//为避免分布式情况下多服务同时上架的情况，使用分布式锁</span></span><br><span class="line">      <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(upload_lock);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          lock.lock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">          secKillService.uploadSeckillSkuLatest3Days();</span><br><span class="line">      &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">          lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadSeckillSkuLatest3Days</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> couponFeignService.getSeckillSessionsIn3Days();</span><br><span class="line">      <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">          List&lt;SeckillSessionWithSkusVo&gt; sessions = r.getData(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;SeckillSessionWithSkusVo&gt;&gt;() &#123;</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">//在redis中分别保存秒杀场次信息和场次对应的秒杀商品信息</span></span><br><span class="line">          saveSecKillSession(sessions);</span><br><span class="line">          saveSecKillSku(sessions);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013355.png" alt="desc"></p>
<h3 id="2-获取最近三天的秒杀信息"><a href="#2-获取最近三天的秒杀信息" class="headerlink" title="(2) 获取最近三天的秒杀信息"></a>(2) 获取最近三天的秒杀信息</h3><ul>
<li>获取最近三天的秒杀场次信息，再通过秒杀场次id查询对应的商品信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SeckillSessionEntity&gt; <span class="title function_">getSeckillSessionsIn3Days</span><span class="params">()</span> &#123;</span><br><span class="line">    QueryWrapper&lt;SeckillSessionEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SeckillSessionEntity&gt;()</span><br><span class="line">            .between(<span class="string">&quot;start_time&quot;</span>, getStartTime(), getEndTime());</span><br><span class="line">    List&lt;SeckillSessionEntity&gt; seckillSessionEntities = <span class="built_in">this</span>.list(queryWrapper);</span><br><span class="line">    List&lt;SeckillSessionEntity&gt; list = seckillSessionEntities.stream().map(session -&gt; &#123;</span><br><span class="line">        List&lt;SeckillSkuRelationEntity&gt; skuRelationEntities = seckillSkuRelationService.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SeckillSkuRelationEntity&gt;().eq(<span class="string">&quot;promotion_session_id&quot;</span>, session.getId()));</span><br><span class="line">        session.setRelations(skuRelationEntities);</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当前天数的 00:00:00</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getStartTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">now</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> now.atTime(LocalTime.MIN);</span><br><span class="line">    <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> time.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> format;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当前天数+2 23:59:59..</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getEndTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">now</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> now.plusDays(<span class="number">2</span>).atTime(LocalTime.MAX);</span><br><span class="line">    <span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> time.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> format;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-在redis中保存秒杀场次信息"><a href="#3-在redis中保存秒杀场次信息" class="headerlink" title="(3) 在redis中保存秒杀场次信息"></a>(3) 在redis中保存秒杀场次信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveSecKillSession</span><span class="params">(List&lt;SeckillSessionWithSkusVo&gt; sessions)</span> &#123;</span><br><span class="line">    sessions.stream().forEach(session-&gt;&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SESSION_CACHE_PREFIX + session.getStartTime().getTime() + <span class="string">&quot;_&quot;</span> + session.getEndTime().getTime();</span><br><span class="line">        <span class="comment">//当前活动信息未保存过</span></span><br><span class="line">        <span class="keyword">if</span> (!redisTemplate.hasKey(key))&#123;</span><br><span class="line">            List&lt;String&gt; values = session.getRelations().stream()</span><br><span class="line">                    .map(sku -&gt; sku.getPromotionSessionId() +<span class="string">&quot;-&quot;</span>+ sku.getSkuId())</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            redisTemplate.opsForList().leftPushAll(key,values);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-在redis中保存秒杀商品信息"><a href="#4-在redis中保存秒杀商品信息" class="headerlink" title="(4) 在redis中保存秒杀商品信息"></a>(4) 在redis中保存秒杀商品信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveSecKillSku</span><span class="params">(List&lt;SeckillSessionWithSkusVo&gt; sessions)</span> &#123;</span><br><span class="line">    BoundHashOperations&lt;String, Object, Object&gt; ops = redisTemplate.boundHashOps(SECKILL_CHARE_PREFIX);</span><br><span class="line">    sessions.stream().forEach(session-&gt;&#123;</span><br><span class="line">        session.getRelations().stream().forEach(sku-&gt;&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> sku.getPromotionSessionId() +<span class="string">&quot;-&quot;</span>+ sku.getSkuId();</span><br><span class="line">            <span class="keyword">if</span> (!ops.hasKey(key))&#123;</span><br><span class="line">                <span class="type">SeckillSkuRedisTo</span> <span class="variable">redisTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillSkuRedisTo</span>();</span><br><span class="line">                <span class="comment">//1. 保存SeckillSkuVo信息</span></span><br><span class="line">                BeanUtils.copyProperties(sku,redisTo);</span><br><span class="line">                <span class="comment">//2. 保存开始结束时间</span></span><br><span class="line">                redisTo.setStartTime(session.getStartTime().getTime());</span><br><span class="line">                redisTo.setEndTime(session.getEndTime().getTime());</span><br><span class="line">                <span class="comment">//3. 远程查询sku信息并保存</span></span><br><span class="line">                <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.info(sku.getSkuId());</span><br><span class="line">                <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">SkuInfoVo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> r.getData(<span class="string">&quot;skuInfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SkuInfoVo&gt;() &#123;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    redisTo.setSkuInfoVo(skuInfo);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//4. 生成商品随机码，防止恶意攻击</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                redisTo.setRandomCode(token);</span><br><span class="line">                <span class="comment">//5. 序列化为json并保存</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(redisTo);</span><br><span class="line">                ops.put(key,jsonString);</span><br><span class="line">                <span class="comment">//6. 使用库存作为Redisson信号量限制库存</span></span><br><span class="line">                <span class="type">RSemaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> redissonClient.getSemaphore(SKU_STOCK_SEMAPHORE + token);</span><br><span class="line">                semaphore.trySetPermits(sku.getSeckillCount());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-获取当前秒杀商品"><a href="#4-获取当前秒杀商品" class="headerlink" title="4. 获取当前秒杀商品"></a>4. 获取当前秒杀商品</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/getCurrentSeckillSkus&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">getCurrentSeckillSkus</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//获取到当前可以参加秒杀商品的信息</span></span><br><span class="line">    List&lt;SeckillSkuRedisTo&gt; vos = secKillService.getCurrentSeckillSkus();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().setData(vos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SeckillSkuRedisTo&gt; <span class="title function_">getCurrentSeckillSkus</span><span class="params">()</span> &#123;</span><br><span class="line">        Set&lt;String&gt; keys = redisTemplate.keys(SESSION_CACHE_PREFIX + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> key.replace(SESSION_CACHE_PREFIX, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            String[] split = replace.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> Long.parseLong(split[<span class="number">0</span>]);</span><br><span class="line">            <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> Long.parseLong(split[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">//当前秒杀活动处于有效期内</span></span><br><span class="line">            <span class="keyword">if</span> (currentTime &gt; startTime &amp;&amp; currentTime &lt; endTime) &#123;</span><br><span class="line">                <span class="comment">//取出当前秒杀活动对应商品存储的hash key</span></span><br><span class="line">                List&lt;String&gt; range = redisTemplate.opsForList().range(key, -<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">                BoundHashOperations&lt;String, Object, Object&gt; ops = redisTemplate.boundHashOps(SECKILL_CHARE_PREFIX);</span><br><span class="line">                <span class="comment">//取出存储的商品信息并返回</span></span><br><span class="line">                List&lt;SeckillSkuRedisTo&gt; collect = range.stream().map(s -&gt; &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> (String) ops.get(s);</span><br><span class="line">                    <span class="type">SeckillSkuRedisTo</span> <span class="variable">redisTo</span> <span class="operator">=</span> JSON.parseObject(json, SeckillSkuRedisTo.class);</span><br><span class="line">                    <span class="keyword">return</span> redisTo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">                <span class="keyword">return</span> collect;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>首页获取并拼装数据</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-slide&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 动态拼装秒杀商品信息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;seckillSkuContent&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  $.<span class="title function_">get</span>(<span class="string">&quot;http://seckill.gulimall.com/getCurrentSeckillSkus&quot;</span>, <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      res.<span class="property">data</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&quot;&lt;li onclick=&#x27;toDetail(&quot;</span> + item.<span class="property">skuId</span> + <span class="string">&quot;)&#x27;&gt;&lt;/li&gt;&quot;</span>).<span class="title function_">append</span>($(<span class="string">&quot;&lt;img style=&#x27;width: 130px; height: 130px&#x27; src=&#x27;&quot;</span> + item.<span class="property">skuInfoVo</span>.<span class="property">skuDefaultImg</span> + <span class="string">&quot;&#x27; /&gt;&quot;</span>))</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">append</span>($(<span class="string">&quot;&lt;p&gt;&quot;</span>+item.<span class="property">skuInfoVo</span>.<span class="property">skuTitle</span>+<span class="string">&quot;&lt;/p&gt;&quot;</span>))</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">append</span>($(<span class="string">&quot;&lt;span&gt;&quot;</span> + item.<span class="property">seckillPrice</span> + <span class="string">&quot;&lt;/span&gt;&quot;</span>))</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">append</span>($(<span class="string">&quot;&lt;s&gt;&quot;</span> + item.<span class="property">skuInfoVo</span>.<span class="property">price</span> + <span class="string">&quot;&lt;/s&gt;&quot;</span>))</span></span><br><span class="line"><span class="language-javascript">                .<span class="title function_">appendTo</span>(<span class="string">&quot;#seckillSkuContent&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">toDetail</span>(<span class="params">skuId</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    location.<span class="property">href</span> = <span class="string">&quot;http://item.gulimall.com/&quot;</span> + skuId + <span class="string">&quot;.html&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>首页展示效果</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013402.png" alt="desc"></p>
<h2 id="5-获取当前商品的秒杀信息"><a href="#5-获取当前商品的秒杀信息" class="headerlink" title="5. 获取当前商品的秒杀信息"></a>5. 获取当前商品的秒杀信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/getSeckillSkuInfo/&#123;skuId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">getSeckillSkuInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;skuId&quot;)</span> Long skuId)</span> &#123;</span><br><span class="line">    <span class="type">SeckillSkuRedisTo</span> <span class="variable">to</span> <span class="operator">=</span> secKillService.getSeckillSkuInfo(skuId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().setData(to);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SeckillSkuRedisTo <span class="title function_">getSeckillSkuInfo</span><span class="params">(Long skuId)</span> &#123;</span><br><span class="line">        BoundHashOperations&lt;String, String, String&gt; ops = redisTemplate.boundHashOps(SECKILL_CHARE_PREFIX);</span><br><span class="line">        <span class="comment">//获取所有商品的hash key</span></span><br><span class="line">        Set&lt;String&gt; keys = ops.keys();</span><br><span class="line">        <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">            <span class="comment">//通过正则表达式匹配 数字-当前skuid的商品</span></span><br><span class="line">            <span class="keyword">if</span> (Pattern.matches(<span class="string">&quot;\\d-&quot;</span> + skuId,key)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">v</span> <span class="operator">=</span> ops.get(key);</span><br><span class="line">                <span class="type">SeckillSkuRedisTo</span> <span class="variable">redisTo</span> <span class="operator">=</span> JSON.parseObject(v, SeckillSkuRedisTo.class);</span><br><span class="line">                <span class="comment">//当前商品参与秒杀活动</span></span><br><span class="line">                <span class="keyword">if</span> (redisTo!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                    <span class="comment">//当前活动在有效期，暴露商品随机码返回</span></span><br><span class="line">                    <span class="keyword">if</span> (redisTo.getStartTime() &lt; current &amp;&amp; redisTo.getEndTime() &gt; current) &#123;</span><br><span class="line">                        <span class="keyword">return</span> redisTo;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//当前商品不再秒杀有效期，则隐藏秒杀所需的商品随机码</span></span><br><span class="line">                    redisTo.setRandomCode(<span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">return</span> redisTo;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在查询商品详情页的接口中查询秒杀对应信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013625.png" alt="desc"></p>
<p>更改商品详情页的显示效果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">style</span>=<span class="string">&quot;color: red&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;item.seckillSkuVo != null&#125;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;#dates.createNow().getTime() &lt; item.seckillSkuVo.startTime&#125;&quot;</span>&gt;</span></span><br><span class="line">        商品将会在[[$&#123;#dates.format(new java.util.Date(item.seckillSkuVo.startTime),&quot;yyyy-MM-dd HH:mm:ss&quot;)&#125;]]进行秒杀</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;#dates.createNow().getTime() &gt;= item.seckillSkuVo.startTime &amp;&amp; #dates.createNow().getTime() &lt;= item.seckillSkuVo.endTime&#125;&quot;</span>&gt;</span></span><br><span class="line">        秒杀价  [[$&#123;#numbers.formatDecimal(item.seckillSkuVo.seckillPrice,1,2)&#125;]]</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box-btns-two&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">th:if</span>=<span class="string">&quot;$&#123;item.seckillSkuVo == null &#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;addToCart&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://cart.gulimall.com/addToCart&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;skuId=$&#123;item.info.skuId&#125;&quot;</span>&gt;</span></span><br><span class="line">        加入购物车</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box-btns-two&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">th:if</span>=<span class="string">&quot;$&#123;item.seckillSkuVo != null &amp;&amp; (#dates.createNow().getTime() &gt;= item.seckillSkuVo.startTime &amp;&amp; #dates.createNow().getTime() &lt;= item.seckillSkuVo.endTime)&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;seckill&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">th:attr</span>=<span class="string">&quot;skuId=$&#123;item.info.skuId&#125;,sessionId=$&#123;item.seckillSkuVo.promotionSessionId&#125;,code=$&#123;item.seckillSkuVo.randomCode&#125;&quot;</span>&gt;</span></span><br><span class="line">        立即抢购</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面显示效果</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013664.png" alt="desc"></p>
<h2 id="6-秒杀"><a href="#6-秒杀" class="headerlink" title="6. 秒杀"></a>6. 秒杀</h2><h3 id="1-秒杀接口"><a href="#1-秒杀接口" class="headerlink" title="(1) 秒杀接口"></a>(1) 秒杀接口</h3><ul>
<li><p>点击立即抢购时，会发送请求</p>
</li>
<li><p>秒杀请求会对请求校验<code>时效、商品随机码、当前用户是否已经抢购过当前商品、库存和购买量</code>，通过校验的则秒杀成功，发送消息创建订单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/kill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">kill</span><span class="params">(<span class="meta">@RequestParam(&quot;killId&quot;)</span> String killId,</span></span><br><span class="line"><span class="params">                   <span class="meta">@RequestParam(&quot;key&quot;)</span>String key,</span></span><br><span class="line"><span class="params">                   <span class="meta">@RequestParam(&quot;num&quot;)</span>Integer num,</span></span><br><span class="line"><span class="params">                   Model model)</span> &#123;</span><br><span class="line">    String orderSn= <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        orderSn = secKillService.kill(killId, key, num);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;orderSn&quot;</span>, orderSn);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">kill</span><span class="params">(String killId, String key, Integer num)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        BoundHashOperations&lt;String, String, String&gt; ops = redisTemplate.boundHashOps(SECKILL_CHARE_PREFIX);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> ops.get(killId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderSn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(json))&#123;</span><br><span class="line">            <span class="type">SeckillSkuRedisTo</span> <span class="variable">redisTo</span> <span class="operator">=</span> JSON.parseObject(json, SeckillSkuRedisTo.class);</span><br><span class="line">            <span class="comment">//1. 验证时效</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (current &gt;= redisTo.getStartTime() &amp;&amp; current &lt;= redisTo.getEndTime()) &#123;</span><br><span class="line">                <span class="comment">//2. 验证商品和商品随机码是否对应</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> redisTo.getPromotionSessionId() + <span class="string">&quot;-&quot;</span> + redisTo.getSkuId();</span><br><span class="line">                <span class="keyword">if</span> (redisKey.equals(killId) &amp;&amp; redisTo.getRandomCode().equals(key)) &#123;</span><br><span class="line">                    <span class="comment">//3. 验证当前用户是否购买过</span></span><br><span class="line">                    <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">                    <span class="type">long</span> <span class="variable">ttl</span> <span class="operator">=</span> redisTo.getEndTime() - System.currentTimeMillis();</span><br><span class="line">                    <span class="comment">//3.1 通过在redis中使用 用户id-skuId 来占位看是否买过</span></span><br><span class="line">                    <span class="type">Boolean</span> <span class="variable">occupy</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(memberResponseVo.getId()+<span class="string">&quot;-&quot;</span>+redisTo.getSkuId(), num.toString(), ttl, TimeUnit.MILLISECONDS);</span><br><span class="line">                    <span class="comment">//3.2 占位成功，说明该用户未秒杀过该商品，则继续</span></span><br><span class="line">                    <span class="keyword">if</span> (occupy)&#123;</span><br><span class="line">                        <span class="comment">//4. 校验库存和购买量是否符合要求</span></span><br><span class="line">                        <span class="keyword">if</span> (num &lt;= redisTo.getSeckillLimit()) &#123;</span><br><span class="line">                            <span class="comment">//4.1 尝试获取库存信号量</span></span><br><span class="line">                            <span class="type">RSemaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> redissonClient.getSemaphore(SKU_STOCK_SEMAPHORE + redisTo.getRandomCode());</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">acquire</span> <span class="operator">=</span> semaphore.tryAcquire(num,<span class="number">100</span>,TimeUnit.MILLISECONDS);</span><br><span class="line">                            <span class="comment">//4.2 获取库存成功</span></span><br><span class="line">                            <span class="keyword">if</span> (acquire) &#123;</span><br><span class="line">                                <span class="comment">//5. 发送消息创建订单</span></span><br><span class="line">                                <span class="comment">//5.1 创建订单号</span></span><br><span class="line">                                orderSn = IdWorker.getTimeId();</span><br><span class="line">                                <span class="comment">//5.2 创建秒杀订单to</span></span><br><span class="line">                                <span class="type">SeckillOrderTo</span> <span class="variable">orderTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillOrderTo</span>();</span><br><span class="line">                                orderTo.setMemberId(memberResponseVo.getId());</span><br><span class="line">                                orderTo.setNum(num);</span><br><span class="line">                                orderTo.setOrderSn(orderSn);</span><br><span class="line">                                orderTo.setPromotionSessionId(redisTo.getPromotionSessionId());</span><br><span class="line">                                orderTo.setSeckillPrice(redisTo.getSeckillPrice());</span><br><span class="line">                                orderTo.setSkuId(redisTo.getSkuId());</span><br><span class="line">                                <span class="comment">//5.3 发送创建订单的消息</span></span><br><span class="line">                                rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>, <span class="string">&quot;order.seckill.order&quot;</span>, orderTo);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> orderSn;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-创建订单"><a href="#2-创建订单" class="headerlink" title="(2) 创建订单"></a>(2) 创建订单</h4><p>发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送创建订单的消息</span></span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;order-event-exchange&quot;</span>, <span class="string">&quot;order.seckill.order&quot;</span>, orderTo);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建秒杀所需队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 商品秒杀队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">orderSecKillOrrderQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;order.seckill.order.queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Binding <span class="title function_">orderSecKillOrrderQueueBinding</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//String destination, DestinationType destinationType, String exchange, String routingKey,</span></span><br><span class="line">    <span class="comment">// 			Map&lt;String, Object&gt; arguments</span></span><br><span class="line">    <span class="type">Binding</span> <span class="variable">binding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(</span><br><span class="line">            <span class="string">&quot;order.seckill.order.queue&quot;</span>,</span><br><span class="line">            Binding.DestinationType.QUEUE,</span><br><span class="line">            <span class="string">&quot;order-event-exchange&quot;</span>,</span><br><span class="line">            <span class="string">&quot;order.seckill.order&quot;</span>,</span><br><span class="line">            <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> binding;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>监听队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;order.seckill.order.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillOrderListener</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createOrder</span><span class="params">(SeckillOrderTo orderTo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;***********接收到秒杀消息&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderService.createSeckillOrder(orderTo);</span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            channel.basicReject(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建订单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSeckillOrder</span><span class="params">(SeckillOrderTo orderTo)</span> &#123;</span><br><span class="line">    <span class="type">MemberResponseVo</span> <span class="variable">memberResponseVo</span> <span class="operator">=</span> LoginInterceptor.loginUser.get();</span><br><span class="line">    <span class="comment">//1. 创建订单</span></span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderEntity</span>();</span><br><span class="line">    orderEntity.setOrderSn(orderTo.getOrderSn());</span><br><span class="line">    orderEntity.setMemberId(orderTo.getMemberId());</span><br><span class="line">    orderEntity.setMemberUsername(memberResponseVo.getUsername());</span><br><span class="line">    orderEntity.setStatus(OrderStatusEnum.CREATE_NEW.getCode());</span><br><span class="line">    orderEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    orderEntity.setPayAmount(orderTo.getSeckillPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(orderTo.getNum())));</span><br><span class="line">    <span class="built_in">this</span>.save(orderEntity);</span><br><span class="line">    <span class="comment">//2. 创建订单项</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> productFeignService.info(orderTo.getSkuId());</span><br><span class="line">    <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">SeckillSkuInfoVo</span> <span class="variable">skuInfo</span> <span class="operator">=</span> r.getData(<span class="string">&quot;skuInfo&quot;</span>, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;SeckillSkuInfoVo&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">OrderItemEntity</span> <span class="variable">orderItemEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderItemEntity</span>();</span><br><span class="line">        orderItemEntity.setOrderSn(orderTo.getOrderSn());</span><br><span class="line">        orderItemEntity.setSpuId(skuInfo.getSpuId());</span><br><span class="line">        orderItemEntity.setCategoryId(skuInfo.getCatalogId());</span><br><span class="line">        orderItemEntity.setSkuId(skuInfo.getSkuId());</span><br><span class="line">        orderItemEntity.setSkuName(skuInfo.getSkuName());</span><br><span class="line">        orderItemEntity.setSkuPic(skuInfo.getSkuDefaultImg());</span><br><span class="line">        orderItemEntity.setSkuPrice(skuInfo.getPrice());</span><br><span class="line">        orderItemEntity.setSkuQuantity(orderTo.getNum());</span><br><span class="line">        orderItemService.save(orderItemEntity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>页面跳转效果</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/08/1652013704.png" alt="desc"></p>
<h1 id="Sentinel服务流控、熔断和降级"><a href="#Sentinel服务流控、熔断和降级" class="headerlink" title="Sentinel服务流控、熔断和降级"></a>Sentinel服务流控、熔断和降级</h1><p>sentinel的基础知识参考<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/">官方文档</a></p>
<h2 id="1-环境搭建-3"><a href="#1-环境搭建-3" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h2><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- sentinel熔断降级限流--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>基本配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sentinel控制台地址</span></span><br><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line"><span class="comment"># 暴露所有监控端点，使得sentinel可以实时监控</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>流控规则设置</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652082527.png" alt="desc"></p>
<p>触发流控的效果</p>
<h2 id="2-自定义流控响应"><a href="#2-自定义流控响应" class="headerlink" title="2. 自定义流控响应"></a>2. 自定义流控响应</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GulimallSentinelConfig</span> <span class="keyword">implements</span> <span class="title class_">UrlBlockHandler</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">blocked</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException ex)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> R.error(BizCodeEnum.SECKILL_EXCEPTION.getCode(),BizCodeEnum.SECKILL_EXCEPTION.getMsg());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(r));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652082546.png" alt="desc"></p>
<h2 id="3-网关流控"><a href="#3-网关流控" class="headerlink" title="3. 网关流控"></a>3. 网关流控</h2><p>如果能在网关层就进行流控，可以避免请求流入业务，减小服务压力</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入sentinel网关限流 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088755.png" alt="desc"></p>
<h2 id="4-feign的流控和降级"><a href="#4-feign的流控和降级" class="headerlink" title="4. feign的流控和降级"></a>4. feign的流控和降级</h2><p>默认情况下，sentinel是不会对feign进行监控的，需要开启配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>开启后的效果</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088794.png" alt="desc"></p>
<p>feign的降级</p>
<p>在<code>@FeignClient</code>设置<code>fallback</code>属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;gulimall-seckill&quot;,fallback = SeckillFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SeckillFeignService</span> &#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/getSeckillSkuInfo/&#123;skuId&#125;&quot;)</span></span><br><span class="line">    R <span class="title function_">getSeckillSkuInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;skuId&quot;)</span> Long skuId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在降级类中实现对应的<code>feign接口</code>,并重写降级方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeckillFallbackService</span> <span class="keyword">implements</span> <span class="title class_">SeckillFeignService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">getSeckillSkuInfo</span><span class="params">(Long skuId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCodeEnum.READ_TIME_OUT_EXCEPTION.getCode(), BizCodeEnum.READ_TIME_OUT_EXCEPTION.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>降级效果</p>
<p>当远程服务被限流或者不可用时，会触发降级效果，如下所示</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088812.png" alt="desc"></p>
<h1 id="Zipkin链路追踪"><a href="#Zipkin链路追踪" class="headerlink" title="Zipkin链路追踪"></a>Zipkin链路追踪</h1><p>由于微服务项目模块众多，相互之间的调用关系十分复杂，因此为了分析工作过程中的调用关系，需要使用zipkin来进行链路追踪</p>
<h2 id="1-环境搭建-4"><a href="#1-环境搭建-4" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h2><p>下载jar包并运行</p>
<p><a target="_blank" rel="noopener" href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/">https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/</a></p>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--链路追踪--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">zipkin:</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">      <span class="attr">sender:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">web</span></span><br><span class="line">      <span class="comment"># 取消nacos对zipkin的服务发现</span></span><br><span class="line">      <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#采样取值介于 0到1之间，1则表示全部收集</span></span><br><span class="line">    <span class="attr">sleuth:</span></span><br><span class="line">      <span class="attr">sampler:</span></span><br><span class="line">        <span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="2-查询调用链路"><a href="#2-查询调用链路" class="headerlink" title="2. 查询调用链路"></a>2. 查询调用链路</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088835.png" alt="desc"></p>
<p>其中可以看到请求的方式，请求时间，异步等信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088861.png" alt="desc"></p>
<h2 id="3-查询依赖"><a href="#3-查询依赖" class="headerlink" title="3. 查询依赖"></a>3. 查询依赖</h2><p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088914.png" alt="desc"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/05/09/1652088932.png" alt="desc"></p>

    </div>

	
    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>小Feng
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="http://zsxfa.cn/2022/05/14/gulimall-%E9%AB%98%E7%BA%A7/" title="gulimall-高级">http://zsxfa.cn/2022/05/14/gulimall-高级/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


	<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">- - - - - - - - - - - - - 文 章 结 束 <i class="fa fa-whale"></i> 感 谢 阅 读 - - - - - - - - - - - - -</div>
    
</div>

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/18/signature/" rel="prev" title="signature">
      <i class="fa fa-chevron-left"></i> signature
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/14/kx%E4%B8%8A%E7%BD%91/" rel="next" title="kx上网">
      kx上网 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="lv-container" data-id="city" data-uid="MTAyMC81NTU4MS8zMjA0OA=="></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
	
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
	
  </div>

  <aside class="sidebar">
  
    <div class="sidebar-inner">
	
		<meting-js
			server="netease"
			type="playlist"
			autoplay=false 
			fixed=true 
			theme=#0000ff
			id="7267391672"> 
		</meting-js>
	
	  

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ELASTICSEARCH"><span class="nav-number">1.</span> <span class="nav-text">ELASTICSEARCH</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ElasticSearch7-%E5%8E%BB%E6%8E%89type%E6%A6%82%E5%BF%B5"><span class="nav-number">1.3.</span> <span class="nav-text">ElasticSearch7-去掉type概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">1.4.</span> <span class="nav-text">倒排索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85elastic-search"><span class="nav-number">1.5.</span> <span class="nav-text">1、安装elastic search</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%88%9D%E6%AD%A5%E6%A3%80%E7%B4%A2"><span class="nav-number">1.6.</span> <span class="nav-text">2、初步检索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89-CAT"><span class="nav-number">1.6.1.</span> <span class="nav-text">1）_CAT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E7%B4%A2%E5%BC%95%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="nav-number">1.6.2.</span> <span class="nav-text">2）索引一个文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="nav-number">1.6.3.</span> <span class="nav-text">3）查看文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="nav-number">1.6.4.</span> <span class="nav-text">4）更新文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%EF%BC%89%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%E6%88%96%E7%B4%A2%E5%BC%95"><span class="nav-number">1.6.5.</span> <span class="nav-text">5）删除文档或索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%EF%BC%89eleasticsearch%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E2%80%94%E2%80%94bulk"><span class="nav-number">1.6.6.</span> <span class="nav-text">6）eleasticsearch的批量操作——bulk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%EF%BC%89%E6%A0%B7%E6%9C%AC%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-number">1.6.7.</span> <span class="nav-text">7）样本测试数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E6%A3%80%E7%B4%A2"><span class="nav-number">1.7.</span> <span class="nav-text">3、检索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89search-Api"><span class="nav-number">1.7.1.</span> <span class="nav-text">1）search Api</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89Query-DSL"><span class="nav-number">1.7.2.</span> <span class="nav-text">2）Query DSL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">（1）基本语法格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%BF%94%E5%9B%9E%E9%83%A8%E5%88%86%E5%AD%97%E6%AE%B5"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">（2）返回部分字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89match%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.7.2.3.</span> <span class="nav-text">（3）match匹配查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89-match-phrase-%E7%9F%AD%E5%8F%A5%E5%8C%B9%E9%85%8D"><span class="nav-number">1.7.2.4.</span> <span class="nav-text">（4） match_phrase [短句匹配]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%885%EF%BC%89multi-math%E3%80%90%E5%A4%9A%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E3%80%91"><span class="nav-number">1.7.2.5.</span> <span class="nav-text">（5）multi_math【多字段匹配】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%886%EF%BC%89bool%E7%94%A8%E6%9D%A5%E5%81%9A%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.7.2.6.</span> <span class="nav-text">（6）bool用来做复合查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%887%EF%BC%89Filter%E3%80%90%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4%E3%80%91"><span class="nav-number">1.7.2.7.</span> <span class="nav-text">（7）Filter【结果过滤】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%888%EF%BC%89term"><span class="nav-number">1.7.2.8.</span> <span class="nav-text">（8）term</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%889%EF%BC%89Aggregation%EF%BC%88%E6%89%A7%E8%A1%8C%E8%81%9A%E5%90%88%EF%BC%89"><span class="nav-number">1.7.2.9.</span> <span class="nav-text">（9）Aggregation（执行聚合）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89Mapping"><span class="nav-number">1.7.3.</span> <span class="nav-text">3）Mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.7.3.1.</span> <span class="nav-text">（1）字段类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%98%A0%E5%B0%84"><span class="nav-number">1.7.3.2.</span> <span class="nav-text">（2）映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%96%B0%E7%89%88%E6%9C%AC%E6%94%B9%E5%8F%98"><span class="nav-number">1.7.3.3.</span> <span class="nav-text">（3）新版本改变</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="nav-number">1.7.3.4.</span> <span class="nav-text">创建映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84"><span class="nav-number">1.7.3.5.</span> <span class="nav-text">查看映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84"><span class="nav-number">1.7.3.6.</span> <span class="nav-text">添加新的字段映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%98%A0%E5%B0%84"><span class="nav-number">1.7.3.7.</span> <span class="nav-text">更新映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="nav-number">1.7.3.8.</span> <span class="nav-text">数据迁移</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89%E5%88%86%E8%AF%8D"><span class="nav-number">1.7.4.</span> <span class="nav-text">4）分词</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">1.7.4.1.</span> <span class="nav-text">1）安装ik分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%E3%80%81%E6%9F%A5%E7%9C%8Belasticsearch%E7%89%88%E6%9C%AC%E5%8F%B7%EF%BC%9A"><span class="nav-number">1.7.4.1.1.</span> <span class="nav-text">a、查看elasticsearch版本号：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%E3%80%81%E8%BF%9B%E5%85%A5es%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8plugin%E7%9B%AE%E5%BD%95"><span class="nav-number">1.7.4.1.2.</span> <span class="nav-text">b、进入es容器内部plugin目录</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">1.7.4.2.</span> <span class="nav-text">2）测试分词器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E5%AF%B9ES%E8%BF%9B%E8%A1%8C%E8%AE%BE%E7%BD%AE"><span class="nav-number">1.7.4.3.</span> <span class="nav-text">3）对ES进行设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="nav-number">1.7.4.4.</span> <span class="nav-text">4）自定义词库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81elasticsearch-Rest-Client"><span class="nav-number">1.7.5.</span> <span class="nav-text">4、elasticsearch-Rest-Client</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%899300-TCP"><span class="nav-number">1.7.5.1.</span> <span class="nav-text">1）9300: TCP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%899200-HTTP"><span class="nav-number">1.7.5.2.</span> <span class="nav-text">2）9200: HTTP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81%E9%99%84%E5%BD%95%EF%BC%9A%E5%AE%89%E8%A3%85Nginx"><span class="nav-number">1.7.6.</span> <span class="nav-text">5、附录：安装Nginx</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88ElasticSearch"><span class="nav-number">1.8.</span> <span class="nav-text">SpringBoot整合ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">1.8.1.</span> <span class="nav-text">1、导入依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="nav-number">1.8.2.</span> <span class="nav-text">2、编写测试类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E6%B5%8B%E8%AF%95%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">1）测试保存数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E6%B5%8B%E8%AF%95%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">2）测试获取数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">1.9.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-kibana%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%91%BD%E4%BB%A4"><span class="nav-number">1.9.1.</span> <span class="nav-text">1. kibana控制台命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="nav-number">2.</span> <span class="nav-text">商品上架</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spu%E5%9C%A8es%E4%B8%AD%E7%9A%84%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">spu在es中的存储模型分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%91ES%E6%B7%BB%E5%8A%A0%E5%95%86%E5%93%81%E5%B1%9E%E6%80%A7%E6%98%A0%E5%B0%84"><span class="nav-number">2.2.</span> <span class="nav-text">向ES添加商品属性映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.</span> <span class="nav-text">商品上架接口实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%95%86%E5%9F%8E%E7%B3%BB%E7%BB%9F%E9%A6%96%E9%A1%B5"><span class="nav-number">3.</span> <span class="nav-text">商城系统首页</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">3.1.</span> <span class="nav-text">导入依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB%E8%8F%9C%E5%8D%95"><span class="nav-number">3.2.</span> <span class="nav-text">渲染一级分类菜单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E4%BA%8C%E7%BA%A7%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E8%8F%9C%E5%8D%95"><span class="nav-number">3.3.</span> <span class="nav-text">渲染二级三级分类菜单</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E7%8E%AF%E5%A2%83"><span class="nav-number">4.</span> <span class="nav-text">搭建域名访问环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">4.1.</span> <span class="nav-text">1. 正向代理与反向代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">4.2.</span> <span class="nav-text">2. Nginx配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Nginx-Windows%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E7%8E%AF%E5%A2%83"><span class="nav-number">4.3.</span> <span class="nav-text">3. Nginx+Windows搭建域名访问环境</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">性能压测与优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7%E4%B8%8E%E7%8E%AF%E5%A2%83"><span class="nav-number">5.1.</span> <span class="nav-text">1. 压测工具与环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%A6%96%E9%A1%B5%E8%8F%9C%E5%8D%95%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">5.2.</span> <span class="nav-text">2. 首页菜单渲染优化数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB-%E4%BC%98%E5%8C%96%E4%B8%9A%E5%8A%A1"><span class="nav-number">5.3.</span> <span class="nav-text">3. 三级分类(优化业务)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%B1%BB"><span class="nav-number">5.4.</span> <span class="nav-text">4. Nginx动静分类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-number">6.</span> <span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98"><span class="nav-number">6.1.</span> <span class="nav-text">1. 本地缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8hashmap%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98"><span class="nav-number">6.1.1.</span> <span class="nav-text">1)  使用hashmap本地缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B4%E5%90%88redis%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-number">6.1.2.</span> <span class="nav-text">2) 整合redis进行测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="nav-number">6.1.3.</span> <span class="nav-text">3) 高并发下缓存失效问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%8A%A0%E9%94%81%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="nav-number">6.1.4.</span> <span class="nav-text">4) 加锁解决缓存击穿问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E9%94%81%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-number">6.1.5.</span> <span class="nav-text">5)  锁时序问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="nav-number">6.2.</span> <span class="nav-text">2. 分布式缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E9%9D%A2%E4%B8%B4%E9%97%AE%E9%A2%98"><span class="nav-number">6.2.1.</span> <span class="nav-text">1) 本地缓存面临问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">6.2.2.</span> <span class="nav-text">2)  分布式锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E6%BC%94%E8%BF%9B"><span class="nav-number">6.2.3.</span> <span class="nav-text">3) 分布式锁的演进</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Redisson"><span class="nav-number">6.2.4.</span> <span class="nav-text">4) Redisson</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">6.2.4.1.</span> <span class="nav-text">(1) 环境搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%EF%BC%88Reentrant-Lock%EF%BC%89"><span class="nav-number">6.2.4.2.</span> <span class="nav-text">(2)  可重入锁（Reentrant Lock）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E8%AF%BB%E5%86%99%E9%94%81%EF%BC%88ReadWriteLock%EF%BC%89"><span class="nav-number">6.2.4.3.</span> <span class="nav-text">(3) 读写锁（ReadWriteLock）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E4%BF%A1%E5%8F%B7%E9%87%8F%EF%BC%88Semaphore%EF%BC%89"><span class="nav-number">6.2.4.4.</span> <span class="nav-text">(4) 信号量（Semaphore）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E9%97%AD%E9%94%81%EF%BC%88CountDownLatch%EF%BC%89"><span class="nav-number">6.2.4.5.</span> <span class="nav-text">(5) 闭锁（CountDownLatch）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">6.3.</span> <span class="nav-text">3. 缓存数据的一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8F%8C%E5%86%99%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.3.1.</span> <span class="nav-text">1)  双写模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%A4%B1%E6%95%88%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.3.2.</span> <span class="nav-text">2) 失效模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">6.3.3.</span> <span class="nav-text">3) 解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-SpringCache"><span class="nav-number">6.4.</span> <span class="nav-text">4. SpringCache</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">6.4.1.</span> <span class="nav-text">1)  导入依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="nav-number">6.4.2.</span> <span class="nav-text">2) 自定义配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86"><span class="nav-number">6.4.3.</span> <span class="nav-text">3) 自定义序列化原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Spring-Cache%E7%9A%84%E4%B8%8D%E8%B6%B3%E4%B9%8B%E5%A4%84"><span class="nav-number">6.4.4.</span> <span class="nav-text">4)  Spring-Cache的不足之处</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A3%80%E7%B4%A2"><span class="nav-number">7.</span> <span class="nav-text">检索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A3%80%E7%B4%A2%E6%9D%A1%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">7.1.</span> <span class="nav-text">1. 检索条件分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-DSL%E5%88%86%E6%9E%90"><span class="nav-number">7.2.</span> <span class="nav-text">2. DSL分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%A3%80%E7%B4%A2%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">7.3.</span> <span class="nav-text">3. 检索代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="nav-number">7.3.1.</span> <span class="nav-text">1) 请求参数和返回结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%B8%BB%E4%BD%93%E9%80%BB%E8%BE%91"><span class="nav-number">7.3.2.</span> <span class="nav-text">2)  主体逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9E%84%E5%BB%BA%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6"><span class="nav-number">7.3.3.</span> <span class="nav-text">3)  构建查询条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%B0%81%E8%A3%85%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C"><span class="nav-number">7.3.4.</span> <span class="nav-text">4) 封装响应结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%A1%B5%E9%9D%A2%E6%95%88%E6%9E%9C"><span class="nav-number">7.4.</span> <span class="nav-text">4. 页面效果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="nav-number">7.4.1.</span> <span class="nav-text">1)  基本数据渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6%E6%B8%B2%E6%9F%93"><span class="nav-number">7.4.2.</span> <span class="nav-text">2) 筛选条件渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="nav-number">7.4.3.</span> <span class="nav-text">3) 分页数据渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%A1%B5%E9%9D%A2%E6%8E%92%E5%BA%8F%E5%92%8C%E4%BB%B7%E6%A0%BC%E5%8C%BA%E9%97%B4"><span class="nav-number">7.4.4.</span> <span class="nav-text">4) 页面排序和价格区间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E9%9D%A2%E5%8C%85%E5%B1%91%E5%AF%BC%E8%88%AA"><span class="nav-number">7.4.5.</span> <span class="nav-text">5) 面包屑导航</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%9D%A1%E4%BB%B6%E7%AD%9B%E9%80%89%E8%81%94%E5%8A%A8"><span class="nav-number">7.4.6.</span> <span class="nav-text">6) 条件筛选联动</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5"><span class="nav-number">8.</span> <span class="nav-text">异步</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%BA%BF%E7%A8%8B"><span class="nav-number">8.1.</span> <span class="nav-text">1. 线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BA%BF%E7%A8%8B%E7%9A%844-%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">8.1.1.</span> <span class="nav-text">1) 初始化线程的4 种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%B8%83%E5%A4%A7%E5%8F%82%E6%95%B0"><span class="nav-number">8.1.2.</span> <span class="nav-text">2) 线程池的七大参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%B8%B8%E8%A7%81%E7%9A%844-%E7%A7%8D%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">8.1.3.</span> <span class="nav-text">3) 常见的4 种线程池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%BC%80%E5%8F%91%E4%B8%AD%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">8.1.4.</span> <span class="nav-text">4) 开发中为什么使用线程池</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-CompletableFuture%E7%BB%84%E5%90%88%E5%BC%8F%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B"><span class="nav-number">8.2.</span> <span class="nav-text">2.CompletableFuture组合式异步编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-runAsync-%E5%92%8C-supplyAsync%E6%96%B9%E6%B3%95"><span class="nav-number">8.2.1.</span> <span class="nav-text">(1)  runAsync 和 supplyAsync方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C%E5%AE%8C%E6%88%90%E6%97%B6%E7%9A%84%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95"><span class="nav-number">8.2.2.</span> <span class="nav-text">(2) 计算结果完成时的回调方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-handle-%E6%96%B9%E6%B3%95"><span class="nav-number">8.2.3.</span> <span class="nav-text">(3) handle 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%BA%BF%E7%A8%8B%E4%B8%B2%E8%A1%8C%E5%8C%96"><span class="nav-number">8.2.4.</span> <span class="nav-text">(4)  线程串行化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E4%B8%A4%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88-%E9%83%BD%E8%A6%81%E5%AE%8C%E6%88%90"><span class="nav-number">8.2.5.</span> <span class="nav-text">(5) 两任务组合 - 都要完成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%B8%A4%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88-%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%88%90"><span class="nav-number">8.2.6.</span> <span class="nav-text">(6) 两任务组合 - 一个完成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%90%88"><span class="nav-number">8.2.7.</span> <span class="nav-text">(7) 多任务组合</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85"><span class="nav-number">9.</span> <span class="nav-text">商品详情</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"><span class="nav-number">9.1.</span> <span class="nav-text">1. 模型抽取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B0%81%E8%A3%85%E5%95%86%E5%93%81%E5%B1%9E%E6%80%A7"><span class="nav-number">9.2.</span> <span class="nav-text">2. 封装商品属性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%80%BB%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="nav-number">9.2.1.</span> <span class="nav-text">(1) 总体思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96spu%E7%9A%84%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7"><span class="nav-number">9.2.2.</span> <span class="nav-text">(2) 获取spu的销售属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%8E%B7%E5%8F%96spu%E7%9A%84%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="nav-number">9.2.3.</span> <span class="nav-text">(3) 获取spu的规格参数信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92"><span class="nav-number">9.3.</span> <span class="nav-text">3. 使用异步编排</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%A1%B5%E9%9D%A2%E7%9A%84sku%E5%88%87%E6%8D%A2"><span class="nav-number">9.4.</span> <span class="nav-text">4. 页面的sku切换</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.</span> <span class="nav-text">认证服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="nav-number">10.1.</span> <span class="nav-text">1. 环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="nav-number">10.2.</span> <span class="nav-text">2.  注册功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%AA%8C%E8%AF%81%E7%A0%81%E5%80%92%E8%AE%A1%E6%97%B6"><span class="nav-number">10.2.1.</span> <span class="nav-text">(1) 验证码倒计时</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B4%E5%90%88%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.2.2.</span> <span class="nav-text">(2) 整合短信服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8E%A5%E5%8F%A3%E9%98%B2%E5%88%B7"><span class="nav-number">10.2.3.</span> <span class="nav-text">(3) 接口防刷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99"><span class="nav-number">10.2.4.</span> <span class="nav-text">(4) 注册接口编写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span class="nav-number">10.3.</span> <span class="nav-text">3. 用户名密码登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%A4%BE%E4%BA%A4%E7%99%BB%E5%BD%95"><span class="nav-number">10.4.</span> <span class="nav-text">4. 社交登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-oauth2-0"><span class="nav-number">10.4.1.</span> <span class="nav-text">(1) oauth2.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9C%A8%E5%BE%AE%E5%8D%9A%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="nav-number">10.4.2.</span> <span class="nav-text">(2) 在微博开放平台创建应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%9C%A8%E7%99%BB%E5%BD%95%E9%A1%B5%E5%BC%95%E5%AF%BC%E7%94%A8%E6%88%B7%E8%87%B3%E6%8E%88%E6%9D%83%E9%A1%B5"><span class="nav-number">10.4.3.</span> <span class="nav-text">(3) 在登录页引导用户至授权页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8D%A2%E5%8F%96token"><span class="nav-number">10.4.4.</span> <span class="nav-text">(4) 换取token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="nav-number">10.4.5.</span> <span class="nav-text">(5) 获取用户信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">10.4.6.</span> <span class="nav-text">(6) 代码编写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-SpringSession"><span class="nav-number">10.5.</span> <span class="nav-text">5. SpringSession</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-session-%E5%8E%9F%E7%90%86"><span class="nav-number">10.5.1.</span> <span class="nav-text">(1) session 原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%8Bsession%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="nav-number">10.5.2.</span> <span class="nav-text">(2) 分布式下session共享问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">10.5.3.</span> <span class="nav-text">(3) 解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-session%E5%A4%8D%E5%88%B6"><span class="nav-number">10.5.3.1.</span> <span class="nav-text">1) session复制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%98%E5%82%A8"><span class="nav-number">10.5.3.2.</span> <span class="nav-text">2) 客户端存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-hash%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">10.5.3.3.</span> <span class="nav-text">3) hash一致性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E7%BB%9F%E4%B8%80%E5%AD%98%E5%82%A8"><span class="nav-number">10.5.3.4.</span> <span class="nav-text">4) 统一存储</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-SpringSession%E6%95%B4%E5%90%88redis"><span class="nav-number">10.5.4.</span> <span class="nav-text">(4) SpringSession整合redis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-2"><span class="nav-number">10.5.4.1.</span> <span class="nav-text">1) 环境搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE-1"><span class="nav-number">10.5.4.2.</span> <span class="nav-text">2) 自定义配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-SpringSession%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86-%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">10.5.5.</span> <span class="nav-text">(5) SpringSession核心原理 - 装饰者模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="nav-number">11.</span> <span class="nav-text">购物车</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="nav-number">11.1.</span> <span class="nav-text">1. 数据模型分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="nav-number">11.1.1.</span> <span class="nav-text">(1) 数据存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">11.1.2.</span> <span class="nav-text">(2) 数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-VO%E7%BC%96%E5%86%99"><span class="nav-number">11.1.3.</span> <span class="nav-text">(3) VO编写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-ThreadLocal%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD%E9%89%B4%E5%88%AB"><span class="nav-number">11.2.</span> <span class="nav-text">2. ThreadLocal用户身份鉴别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD%E9%89%B4%E5%88%AB%E6%96%B9%E5%BC%8F"><span class="nav-number">11.2.1.</span> <span class="nav-text">(1) 用户身份鉴别方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8ThreadLocal%E8%BF%9B%E8%A1%8C%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD%E9%89%B4%E5%88%AB%E4%BF%A1%E6%81%AF%E4%BC%A0%E9%80%92"><span class="nav-number">11.2.2.</span> <span class="nav-text">(2) 使用ThreadLocal进行用户身份鉴别信息传递</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%B7%BB%E5%8A%A0%E5%95%86%E5%93%81%E5%88%B0%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="nav-number">11.3.</span> <span class="nav-text">3. 添加商品到购物车</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%8E%B7%E5%8F%96%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="nav-number">11.4.</span> <span class="nav-text">4. 获取购物车</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%80%89%E4%B8%AD%E8%B4%AD%E7%89%A9%E8%BD%A6%E9%A1%B9"><span class="nav-number">11.5.</span> <span class="nav-text">5. 选中购物车项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E4%BF%AE%E6%94%B9%E8%B4%AD%E7%89%A9%E9%A1%B9%E6%95%B0%E9%87%8F"><span class="nav-number">11.6.</span> <span class="nav-text">6. 修改购物项数量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%88%A0%E9%99%A4%E8%B4%AD%E7%89%A9%E8%BD%A6%E9%A1%B9"><span class="nav-number">11.7.</span> <span class="nav-text">7. 删除购物车项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-number">12.</span> <span class="nav-text">消息队列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%B6%88%E6%81%AF%E7%AE%80%E4%BB%8B"><span class="nav-number">12.1.</span> <span class="nav-text">一、消息简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81RabbitMQ"><span class="nav-number">12.2.</span> <span class="nav-text">二、RabbitMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">12.2.1.</span> <span class="nav-text">1. 核心概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-number">12.2.2.</span> <span class="nav-text">2. 运行机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Docker%E5%AE%89%E8%A3%85RabbitMQ"><span class="nav-number">12.3.</span> <span class="nav-text">三、Docker安装RabbitMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81-Springboot%E4%B8%AD%E7%9A%84RabbitMQ"><span class="nav-number">12.4.</span> <span class="nav-text">四、 Springboot中的RabbitMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">12.4.1.</span> <span class="nav-text">1. 环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-RabbitMQ%E5%AE%A2%E6%88%B7%E7%AB%AFAPI"><span class="nav-number">12.4.2.</span> <span class="nav-text">2. RabbitMQ客户端API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92"><span class="nav-number">12.4.3.</span> <span class="nav-text">3.  消息的可靠投递</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-confirmCallback"><span class="nav-number">12.4.3.1.</span> <span class="nav-text">(1) confirmCallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-ReturnCallback"><span class="nav-number">12.4.3.2.</span> <span class="nav-text">(2) ReturnCallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-ack"><span class="nav-number">12.4.3.3.</span> <span class="nav-text">(3) ack</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="nav-number">13.</span> <span class="nav-text">订单服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%AE%A2%E5%8D%95%E6%B5%81%E7%A8%8B"><span class="nav-number">13.1.</span> <span class="nav-text">1. 订单流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%AE%A2%E5%8D%95%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA"><span class="nav-number">13.2.</span> <span class="nav-text">2. 订单登录拦截</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%AE%A2%E5%8D%95%E7%A1%AE%E8%AE%A4%E9%A1%B5"><span class="nav-number">13.3.</span> <span class="nav-text">3. 订单确认页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96"><span class="nav-number">13.3.1.</span> <span class="nav-text">（1）模型抽取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96"><span class="nav-number">13.3.2.</span> <span class="nav-text">（2）数据获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89Feign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E4%B8%A2%E5%A4%B1%E8%AF%B7%E6%B1%82%E5%A4%B4%E9%97%AE%E9%A2%98"><span class="nav-number">13.3.3.</span> <span class="nav-text">（3）Feign远程调用丢失请求头问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89Feign%E5%BC%82%E6%AD%A5%E6%83%85%E5%86%B5%E4%B8%A2%E5%A4%B1%E4%B8%8A%E4%B8%8B%E6%96%87%E9%97%AE%E9%A2%98"><span class="nav-number">13.3.4.</span> <span class="nav-text">（4）Feign异步情况丢失上下文问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E8%BF%90%E8%B4%B9%E6%94%B6%E4%BB%B6%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96"><span class="nav-number">13.3.5.</span> <span class="nav-text">（5）运费收件信息获取</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%AE%A2%E5%8D%95%E6%8F%90%E4%BA%A4"><span class="nav-number">13.4.</span> <span class="nav-text">4. 订单提交</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A8%A1%E5%9E%8B%E6%8A%BD%E5%8F%96-1"><span class="nav-number">13.4.1.</span> <span class="nav-text">（1）模型抽取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="nav-number">13.4.2.</span> <span class="nav-text">（2）提交订单</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%AA%8C%E8%AF%81%E9%98%B2%E9%87%8D%E4%BB%A4%E7%89%8C"><span class="nav-number">13.4.2.1.</span> <span class="nav-text">1) 验证防重令牌</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E3%80%81%E8%AE%A2%E5%8D%95%E9%A1%B9"><span class="nav-number">13.4.2.2.</span> <span class="nav-text">2) 创建订单、订单项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%AA%8C%E4%BB%B7"><span class="nav-number">13.4.2.3.</span> <span class="nav-text">3) 验价</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E4%BF%9D%E5%AD%98%E8%AE%A2%E5%8D%95"><span class="nav-number">13.4.2.4.</span> <span class="nav-text">4) 保存订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E9%94%81%E5%AE%9A%E5%BA%93%E5%AD%98"><span class="nav-number">13.4.2.5.</span> <span class="nav-text">5) 锁定库存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">13.4.3.</span> <span class="nav-text">（3） 分布式事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8seata%E8%A7%A3%E5%86%B3%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="nav-number">13.4.4.</span> <span class="nav-text">（4）使用seata解决分布式事务问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">13.5.</span> <span class="nav-text">5. 使用消息队列实现最终一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="nav-number">13.5.1.</span> <span class="nav-text">(1) 延迟队列的定义与实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">13.5.2.</span> <span class="nav-text">(2) 延迟队列使用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AE%9A%E6%97%B6%E5%85%B3%E5%8D%95%E4%B8%8E%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81%E4%B8%BB%E4%BD%93%E9%80%BB%E8%BE%91"><span class="nav-number">13.5.3.</span> <span class="nav-text">(3) 定时关单与库存解锁主体逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%9B%E5%BB%BA%E4%B8%9A%E5%8A%A1%E4%BA%A4%E6%8D%A2%E6%9C%BA%E5%92%8C%E9%98%9F%E5%88%97"><span class="nav-number">13.5.4.</span> <span class="nav-text">(4) 创建业务交换机和队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%BA%93%E5%AD%98%E8%87%AA%E5%8A%A8%E8%A7%A3%E9%94%81"><span class="nav-number">13.5.5.</span> <span class="nav-text">(5) 库存自动解锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E5%BA%93%E5%AD%98%E9%94%81%E5%AE%9A"><span class="nav-number">13.5.5.1.</span> <span class="nav-text">1）库存锁定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97"><span class="nav-number">13.5.5.2.</span> <span class="nav-text">2）监听队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81"><span class="nav-number">13.5.5.3.</span> <span class="nav-text">3）库存解锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%AE%9A%E6%97%B6%E5%85%B3%E5%8D%95"><span class="nav-number">13.5.6.</span> <span class="nav-text">(6) 定时关单</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95"><span class="nav-number">13.5.6.1.</span> <span class="nav-text">1) 提交订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E7%9B%91%E5%90%AC%E9%98%9F%E5%88%97"><span class="nav-number">13.5.6.2.</span> <span class="nav-text">2) 监听队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%85%B3%E9%97%AD%E8%AE%A2%E5%8D%95"><span class="nav-number">13.5.6.3.</span> <span class="nav-text">3) 关闭订单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E8%A7%A3%E9%94%81%E5%BA%93%E5%AD%98"><span class="nav-number">13.5.6.4.</span> <span class="nav-text">4) 解锁库存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%94%AF%E4%BB%98"><span class="nav-number">13.6.</span> <span class="nav-text">6. 支付</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%94%AF%E4%BB%98%E5%AE%9D%E5%8A%A0%E5%AF%86%E5%8E%9F%E7%90%86"><span class="nav-number">13.6.1.</span> <span class="nav-text">(1) 支付宝加密原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AE%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83"><span class="nav-number">13.6.2.</span> <span class="nav-text">(2) 配置支付宝沙箱环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">13.6.3.</span> <span class="nav-text">(3) 环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98%E4%B8%8E%E5%90%8C%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="nav-number">13.6.4.</span> <span class="nav-text">(4) 订单支付与同步通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="nav-number">13.6.5.</span> <span class="nav-text">(5) 异步通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E8%AE%BE%E7%BD%AE%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5%E5%9C%B0%E5%9D%80"><span class="nav-number">13.6.5.1.</span> <span class="nav-text">1）内网穿透设置异步通知地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E9%AA%8C%E8%AF%81%E7%AD%BE%E5%90%8D"><span class="nav-number">13.6.5.2.</span> <span class="nav-text">2）验证签名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E4%BF%AE%E6%94%B9%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E4%B8%8E%E4%BF%9D%E5%AD%98%E4%BA%A4%E6%98%93%E6%B5%81%E6%B0%B4"><span class="nav-number">13.6.5.3.</span> <span class="nav-text">3）修改订单状态与保存交易流水</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5%E7%9A%84%E5%8F%82%E6%95%B0"><span class="nav-number">13.6.5.4.</span> <span class="nav-text">4) 异步通知的参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%94%B6%E5%8D%95"><span class="nav-number">13.6.6.</span> <span class="nav-text">(6) 收单</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1"><span class="nav-number">14.</span> <span class="nav-text">秒杀服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A7%92%E6%9D%80%EF%BC%88%E9%AB%98%E5%B9%B6%E5%8F%91%EF%BC%89%E7%B3%BB%E7%BB%9F%E5%85%B3%E6%B3%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">14.1.</span> <span class="nav-text">1. 秒杀（高并发）系统关注的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%A7%92%E6%9D%80%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">14.2.</span> <span class="nav-text">2. 秒杀架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%A7%92%E6%9D%80%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">14.2.1.</span> <span class="nav-text">(1) 秒杀架构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">14.2.2.</span> <span class="nav-text">(2) 存储模型设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="nav-number">14.3.</span> <span class="nav-text">3. 商品上架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%9A%E6%97%B6%E4%B8%8A%E6%9E%B6"><span class="nav-number">14.3.1.</span> <span class="nav-text">(1) 定时上架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96%E6%9C%80%E8%BF%91%E4%B8%89%E5%A4%A9%E7%9A%84%E7%A7%92%E6%9D%80%E4%BF%A1%E6%81%AF"><span class="nav-number">14.3.2.</span> <span class="nav-text">(2) 获取最近三天的秒杀信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%9C%A8redis%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%A7%92%E6%9D%80%E5%9C%BA%E6%AC%A1%E4%BF%A1%E6%81%AF"><span class="nav-number">14.3.3.</span> <span class="nav-text">(3) 在redis中保存秒杀场次信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%9C%A8redis%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF"><span class="nav-number">14.3.4.</span> <span class="nav-text">(4) 在redis中保存秒杀商品信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81"><span class="nav-number">14.4.</span> <span class="nav-text">4. 获取当前秒杀商品</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%95%86%E5%93%81%E7%9A%84%E7%A7%92%E6%9D%80%E4%BF%A1%E6%81%AF"><span class="nav-number">14.5.</span> <span class="nav-text">5. 获取当前商品的秒杀信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E7%A7%92%E6%9D%80"><span class="nav-number">14.6.</span> <span class="nav-text">6. 秒杀</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%A7%92%E6%9D%80%E6%8E%A5%E5%8F%A3"><span class="nav-number">14.6.1.</span> <span class="nav-text">(1) 秒杀接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95"><span class="nav-number">14.6.1.1.</span> <span class="nav-text">(2) 创建订单</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Sentinel%E6%9C%8D%E5%8A%A1%E6%B5%81%E6%8E%A7%E3%80%81%E7%86%94%E6%96%AD%E5%92%8C%E9%99%8D%E7%BA%A7"><span class="nav-number">15.</span> <span class="nav-text">Sentinel服务流控、熔断和降级</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-3"><span class="nav-number">15.1.</span> <span class="nav-text">1. 环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B5%81%E6%8E%A7%E5%93%8D%E5%BA%94"><span class="nav-number">15.2.</span> <span class="nav-text">2. 自定义流控响应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%BD%91%E5%85%B3%E6%B5%81%E6%8E%A7"><span class="nav-number">15.3.</span> <span class="nav-text">3. 网关流控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-feign%E7%9A%84%E6%B5%81%E6%8E%A7%E5%92%8C%E9%99%8D%E7%BA%A7"><span class="nav-number">15.4.</span> <span class="nav-text">4. feign的流控和降级</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zipkin%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="nav-number">16.</span> <span class="nav-text">Zipkin链路追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-4"><span class="nav-number">16.1.</span> <span class="nav-text">1. 环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="nav-number">16.2.</span> <span class="nav-text">2. 查询调用链路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%9F%A5%E8%AF%A2%E4%BE%9D%E8%B5%96"><span class="nav-number">16.3.</span> <span class="nav-text">3. 查询依赖</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->
	  
	  

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小Feng"
      src="https://cdn.jsdelivr.net/gh/zsxfa/CDN/img/md/2022/01/14/1642171382.png">
  <p class="site-author-name" itemprop="name">小Feng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zsxfa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zsxfa" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zsxfa125689@163.com" title="E-Mail → mailto:zsxfa125689@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/m0_46132054" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;m0_46132054" rel="noopener" target="_blank"><i class="fa fa-copyright fa-fw"></i>CSDN</a>
      </span>
  </div>
  <div class="">
    <a target="_blank" class="social-link" href="/atom.xml" style="color: burlywood;">
      <span class="icon">
        <i class="fa fa-rss"></i>
      </span>
      <span class="label">RSS</span>
    </a>
  </div>



      </div>
	  
	  <div id="binft"></div>
  <script>
    var binft = function (r) {
      function t() {
        return b[Math.floor(Math.random() * b.length)]
      }  
      function e() {
        return String.fromCharCode(94 * Math.random() + 33)
      }
      function n(r) {
        for (var n = document.createDocumentFragment(), i = 0; r > i; i++) {
          var l = document.createElement("span");
          l.textContent = e(), l.style.color = t(), n.appendChild(l)
        }
        return n
      }
      function i() {
        var t = o[c.skillI];
        c.step ? c.step-- : (c.step = g, c.prefixP < l.length ? (c.prefixP >= 0 && (c.text += l[c.prefixP]), c.prefixP++) : "forward" === c.direction ? c.skillP < t.length ? (c.text += t[c.skillP], c.skillP++) : c.delay ? c.delay-- : (c.direction = "backward", c.delay = a) : c.skillP > 0 ? (c.text = c.text.slice(0, -1), c.skillP--) : (c.skillI = (c.skillI + 1) % o.length, c.direction = "forward")), r.textContent = c.text, r.appendChild(n(c.prefixP < l.length ? Math.min(s, s + c.prefixP) : Math.min(s, t.length - c.skillP))), setTimeout(i, d)
      }

      var l = "",
      o = [" 人生如逆旅，我亦是行人"].map(function (r) {
      return r + ""
      }),
      a = 2,
      g = 1,
      s = 5,
      d = 75,
      b = ["rgb(110,64,170)", "rgb(150,61,179)", "rgb(191,60,175)", "rgb(228,65,157)", "rgb(254,75,131)", "rgb(255,94,99)", "rgb(255,120,71)", "rgb(251,150,51)", "rgb(226,183,47)", "rgb(198,214,60)", "rgb(175,240,91)", "rgb(127,246,88)", "rgb(82,246,103)", "rgb(48,239,130)", "rgb(29,223,163)", "rgb(26,199,194)", "rgb(35,171,216)", "rgb(54,140,225)", "rgb(76,110,219)", "rgb(96,84,200)"],
      c = {
        text: "",
        prefixP: -s,
        skillI: 0,
        skillP: 0,
        direction: "forward",
        delay: a,
        step: g
      };
      i()
      };
      binft(document.getElementById('binft'));
  </script>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
	  

    </div>
	
	
  </aside>
  
  
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小Feng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">620k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">9:24</span>
</div>

<!--添加运行时间-->
<span id="sitetime"></span>
<script language=javascript>
	function siteTime(){
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* 
      Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
      year - 作为date对象的年份，为4位年份值
      month - 0-11之间的整数，做为date对象的月份
      day - 1-31之间的整数，做为date对象的天数
      hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
      minutes - 0-59之间的整数，做为date对象的分钟数
      seconds - 0-59之间的整数，做为date对象的秒数
      microseconds - 0-999之间的整数，做为date对象的毫秒数
     */
		var t1 = Date.UTC(2022,01,10,20,00,00); //北京时间2018-2-13 00:00:00
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		document.getElementById("sitetime").innerHTML=" 本站已运行"+/*diffYears+" 年 "+*/diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
	}
	siteTime();
</script>
<!--// 添加运行时间-->

<!-- 新增访客统计代码 -->
<div class="busuanzi-count">
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">
		本站总访问量<span id="busuanzi_value_site_pv"></span>次
	</span>
	<span class="post-meta-divider">|</span>
	<span id="busuanzi_container_site_uv">
		本站访客数<span id="busuanzi_value_site_uv"></span>人次
	</span>
</div>
<!-- 新增访客统计代码 END-->


        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

<script>
NexT.utils.loadComments(document.querySelector('#lv-container'), () => {
  window.livereOptions = {
    refer: location.pathname.replace(CONFIG.root, '').replace('index.html', '')
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script>

    </div>
  

<script type="text/javascript"
color="0,0,255" opacity='0.7' zIndex="-1" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>



<!-- 页面点击小红心 
<script type="text/javascript" src="/js/heart.js"></script> -->
<!-- 页面点击烟花爆炸 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>

<!-- 音乐播放 -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><!--APlayer的样式-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zsxfa/CDN/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><!--APlayer的依赖-->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><!--Meting的依赖-->

<!-- 样式一（鼠标点击更换样式） -->
<script src="https://g.joyinshare.com/hc/ribbon.min.js" type="text/javascript"></script>
<!-- 样式二（飘动的彩带） -->
<script src="https://g.joyinshare.com/hc/piao.js" type="text/javascript"></script>

</body>
<!-- 页面恶搞-->
<script type="text/javascript" src="\js\funny.js"></script> 
</html>
